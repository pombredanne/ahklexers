<LINK href="styles.css" rel="stylesheet" type="text/css">old lexer: 
<div class="highlight"><pre><span class="c1">; Ping function by Drugwash April 29, 2010</span>
<span class="c1">; v2.0</span>
<span class="c1">;*********************************</span>
<span class="nf">ping_</span><span class="p">(</span>adr<span class="p">,</span><span class="w"> </span>data<span class="p">,</span><span class="w"> </span>timeout<span class="p">)</span>
<span class="p">{</span>
<span class="kt">static</span><span class="w"> </span>reply
<span class="n">ErrorLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">SetFormat</span><span class="p">,</span><span class="w"> </span>IntegerFast<span class="p">,</span><span class="w"> </span>H
cAdr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;wsock32\inet_addr&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>adr<span class="p">,</span><span class="w"> </span>UInt<span class="p">)</span><span class="w">   </span><span class="c1">; convert address to 32bit UInt</span>
<span class="kr">if</span><span class="w"> </span>cAdr<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span>
<span class="w">   </span>cAdr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;ws2_32\inet_addr&quot;</span><span class="p">,</span><span class="w"> </span>str<span class="p">,</span><span class="w"> </span>adr<span class="p">,</span><span class="w"> </span>Int<span class="p">)</span><span class="w"> </span><span class="c1">; second attempt at conversion, using ws2_32</span>
<span class="w">      </span><span class="kr">if</span><span class="w"> </span>cAdr<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span>
<span class="w">         </span><span class="p">{</span>
<span class="w">         </span>ErrorLevel<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span>err<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;Error: Cannot convert address to UInt.&quot;</span>
<span class="w">         </span><span class="p">}</span>
<span class="c1">; test for function presence since it&#39;s located in different libs through various OS</span>
hLib<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;LoadLibrary&quot;</span><span class="p">,</span><span class="w"> </span>str<span class="p">,</span><span class="w"> </span><span class="s">&quot;iphlpapi.dll&quot;</span><span class="p">)</span>
<span class="kr">if</span><span class="w"> </span>hLib
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span>hPrAdr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;GetProcAddress&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>hLib<span class="p">,</span><span class="w"> </span>str<span class="p">,</span><span class="w"> </span><span class="s">&quot;IcmpCreateFile&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="kr">if</span><span class="w"> </span>hPrAdr
<span class="c1">;      hPort := DllCall(&quot;iphlpapi\IcmpCreateFile&quot;, UInt)   ; open a port (iphlpapi.dll in XP+)</span>
<span class="w">      </span>hPort<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span>hPrAdr<span class="p">,</span><span class="w"> </span>UInt<span class="p">)</span><span class="w">   </span><span class="c1">; open a port (iphlpapi.dll in XP+)</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">      </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;FreeLibrary&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>hLib<span class="p">)</span>
<span class="w">   </span><span class="p">}</span>
<span class="kr">if</span><span class="w"> </span><span class="o">!</span>hPort
<span class="w">   </span>hPort<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;icmp\IcmpCreateFile&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">)</span><span class="w">   </span><span class="c1">; open a port (icmp.dll in Win2000 and lower)</span>
<span class="kr">if</span><span class="w"> </span><span class="o">!</span>hPort
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span>ErrorLevel<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span>err<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;Error: Cannot open port.&quot;</span>
<span class="w">   </span><span class="p">}</span>
<span class="k">SetFormat</span><span class="p">,</span><span class="w"> </span>Integer<span class="p">,</span><span class="w"> </span>D
<span class="n">szreply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">278</span><span class="w">                </span><span class="c1">; ICMP_ECHO_REPLY structure</span>
<span class="nf">VarSetCapacity</span><span class="p">(</span>reply<span class="p">,</span><span class="w"> </span>szreply<span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;icmp\IcmpSendEcho&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>hPort<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>cAdr<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>data<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>StrLen<span class="p">(</span>data<span class="p">),</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>NULL<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>reply<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>szreply<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>timeout<span class="p">,</span><span class="w"> </span>UInt<span class="p">)</span>
errcode<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>reply<span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UInt&quot;</span><span class="p">)</span><span class="w">   </span><span class="c1">; check for status</span>
errcode<span class="w"> </span><span class="o">:=</span><span class="w"> </span>errcode<span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>errcode<span class="w"> </span><span class="o">:</span><span class="w"> </span>errcode<span class="o">+</span><span class="mi">11000</span>
<span class="kr">if</span><span class="w"> </span>errcode<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11001</span><span class="w">   </span><span class="c1">; function returned &#39;buffer too small&#39; so we increase it and try again</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span><span class="nf">VarSetCapacity</span><span class="p">(</span>reply<span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>reply<span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UShort&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span>
<span class="w">   </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;icmp\IcmpSendEcho&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>hPort<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>cAdr<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>data<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>StrLen<span class="p">(</span>data<span class="p">),</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>NULL<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>reply<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>szreply<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>timeout<span class="p">,</span><span class="w"> </span>UInt<span class="p">)</span>
<span class="w">   </span>errcode<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>reply<span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UInt&quot;</span><span class="p">)</span><span class="w">   </span><span class="c1">; another check for status on 2-nd attempt</span>
<span class="w">   </span>errcode<span class="w"> </span><span class="o">:=</span><span class="w"> </span>errcode<span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span>errcode<span class="w"> </span><span class="o">:</span><span class="w"> </span>errcode<span class="o">+</span><span class="mi">11000</span>
<span class="w">   </span><span class="p">}</span>
err<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ping_GetError<span class="p">(</span>errcode<span class="p">,</span><span class="w"> </span><span class="s">&quot;IcmpSendEcho&quot;</span><span class="p">)</span><span class="w">   </span><span class="c1">; error handling</span>
<span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;icmp\IcmpCloseHandle&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>hPort<span class="p">)</span><span class="w">   </span><span class="c1">; close port</span>
<span class="kr">if</span><span class="w"> </span>errcode<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">11000</span><span class="w">            </span><span class="c1">; IP_SUCCESS</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span>ErrorLevel<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span>err
<span class="w">   </span><span class="p">}</span>
<span class="k">else</span>
<span class="c1">; on success returns ICMP_ECHO_REPLY structure address for external processing of data</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span>err<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span>reply
<span class="p">}</span>
<span class="c1">;*********************************</span>
<span class="nf">ping_GetError</span><span class="p">(</span>code<span class="p">,</span><span class="w"> </span>func<span class="o">=</span><span class="s">&quot;[ukn]&quot;</span><span class="p">)</span><span class="w">      </span><span class="c1">; error translation</span>
<span class="p">{</span>
str<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;Success|Reply buffer too small|Destination network unreachable|Destination host unreachable|Destination protocol unreachable|Destination port unreachable|Insufficient IP resources|Bad IP option specified|Hardware error|Packet too big|Request timed out|Bad request|Bad route|TTL expired in transit|TTL expired during fragment reassembly|Parameter problem|Datagrams are arriving too fast to be processed and datagrams may have been discarded|IP option too big|Bad destination|General failure (possible malformed ICMP packets)&quot;</span>
<span class="k">Loop</span><span class="p">,</span><span class="w"> </span>Parse<span class="p">,</span><span class="w"> </span>str<span class="p">,</span><span class="w"> </span><span class="o">|</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>code<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">A_Index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nb">A_Index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>code<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11050</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span>err<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;Error &quot;</span><span class="w"> </span>code<span class="w"> </span><span class="s">&quot; [&quot;</span><span class="w"> </span><span class="nb">A_LoopField</span><span class="w"> </span><span class="s">&quot;] in function &quot;</span><span class="w"> </span>func
<span class="w">   </span><span class="p">}</span>
<span class="k">return</span><span class="w"> </span>err<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;Function &quot;</span><span class="w"> </span>func<span class="w"> </span><span class="s">&quot; returned &quot;</span><span class="w"> </span>code
<span class="p">}</span>
<span class="c1">;*********************************</span>
<span class="nf">ping_Host2IP</span><span class="p">(</span>name<span class="p">)</span>
<span class="p">{</span>
<span class="n">ErrorLevel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
type<span class="w"> </span><span class="o">:=</span><span class="w"> </span>SubStr<span class="p">(</span>name<span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="kr">if</span><span class="w"> </span>type<span class="w"> </span>is<span class="w"> </span>alpha
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span>hostent<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;ws2_32\gethostbyname&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>name<span class="p">,</span><span class="w"> </span>UInt<span class="p">)</span><span class="w"> </span><span class="c1">; http://msdn.microsoft.com/en-us/library/ms738524(VS.85).aspx</span>
<span class="w">   </span><span class="kr">if</span><span class="w"> </span><span class="o">!</span>hostent
<span class="w">      </span><span class="p">{</span>
<span class="w">      </span>err<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;ws2_32\WSAGetLastError&quot;</span><span class="p">)</span>
<span class="w">      </span>ErrorLevel<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span>err
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="c1">; string containing protocol types (mainly for debug purposes)</span>
<span class="w">   </span>str<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;local to host (pipes, portals)|internetwork: UDP, TCP, etc.|arpanet imp addresses|pup protocols: e.g. BSP|mit CHAOS protocols|XEROX NS protocols or IPX protocols: IPX, SPX, etc.|ISO protocols or OSI is ISO|european computer manufacturers|datakit protocols|CCITT protocols, X.25 etc|IBM SNA|DECnet|Direct data link interface|LAT|NSC Hyperchannel|AppleTalk|NetBios-style addresses|VoiceView|Protocols from Firefox|Unknown - Somebody is using this!|Banyan|Native ATM Services|Internetwork Version 6|Microsoft Wolfpack|IEEE 1284.4 WG AF&quot;</span>
<span class="w">   </span>ptrName<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>hostent<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UInt&quot;</span><span class="p">)</span>
<span class="w">   </span>pt<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>hostent<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UShort&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="k">Loop</span><span class="p">,</span><span class="w"> </span>Parse<span class="p">,</span><span class="w"> </span>str<span class="p">,</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="nb">A_Index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>pt<span class="p">)</span>
<span class="w">         </span>type<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">A_LoopField</span>
<span class="w">   </span>len<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>hostent<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UShort&quot;</span><span class="p">)</span>
<span class="w">   </span>ptrAddress<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>hostent<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UInt&quot;</span><span class="p">)</span>
<span class="w">   </span>ptrIPAddress<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>ptrAddress<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UInt&quot;</span><span class="p">)</span>
<span class="w">   </span>strAddress<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>ptrIPAddress<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UInt&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="nf">VarSetCapacity</span><span class="p">(</span>adr<span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">   </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;lstrcpy&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>adr<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;ws2_32\inet_ntoa&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>strAddress<span class="p">))</span>
<span class="w">   </span><span class="nf">VarSetCapacity</span><span class="p">(</span>adr<span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="nf">VarSetCapacity</span><span class="p">(</span>pname<span class="p">,</span><span class="w"> </span><span class="mi">260</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">   </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;lstrcpy&quot;</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>pname<span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span>ptrName<span class="p">)</span>
<span class="w">   </span><span class="nf">VarSetCapacity</span><span class="p">(</span>pname<span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span>adr
<span class="w">   </span><span class="p">}</span>
<span class="k">else</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span>name
<span class="p">}</span>
<span class="c1">;*********************************</span>
<span class="nf">ping_DW2IP</span><span class="p">(</span>adr<span class="p">)</span>
<span class="p">{</span>
res<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>adr<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Uchar&quot;</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span>NumGet<span class="p">(</span>adr<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Uchar&quot;</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span>NumGet<span class="p">(</span>adr<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Uchar&quot;</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span>NumGet<span class="p">(</span>adr<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Uchar&quot;</span><span class="p">)</span>
<span class="k">return</span><span class="w"> </span>res
<span class="p">}</span>
<span class="c1">;*********************************</span>
<span class="nf">ping</span><span class="p">(</span>addr<span class="p">,</span><span class="w"> </span>data<span class="o">=</span><span class="s">&quot;AHK ping test&quot;</span><span class="p">,</span><span class="w"> </span>timeout<span class="o">=</span><span class="s">&quot;500&quot;</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">; Sockets initialization http://msdn.microsoft.com/en-us/library/ms741563(VS.85).aspx</span>
<span class="nf">VarSetCapacity</span><span class="p">(</span>WSADATA<span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="o">+</span><span class="mi">257</span><span class="o">+</span><span class="mi">129</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">   </span><span class="c1">; WSADATA structure initialization</span>
err<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;wsock32\WSAStartup&quot;</span><span class="p">,</span><span class="w"> </span>Short<span class="p">,</span><span class="w"> </span><span class="mh">0x101</span><span class="p">,</span><span class="w"> </span>UInt<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>WSADATA<span class="p">,</span><span class="w"> </span>UInt<span class="p">)</span>
<span class="kr">if</span><span class="w"> </span>err<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">   </span>ErrorLevel<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span>err<span class="w"> </span><span class="o">=</span><span class="w"> </span>Socket<span class="w"> </span>initialization<span class="w"> </span>error<span class="w"> </span><span class="nv">%err%</span><span class="w">      </span><span class="c1">; Failed to initialize sockets</span>
<span class="w">   </span><span class="k">goto</span><span class="w"> </span>error
<span class="w">   </span><span class="p">}</span>
address<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ping_Host2IP<span class="p">(</span>addr<span class="p">)</span><span class="w">               </span><span class="c1">; address conversion to DWORD</span>
err<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ping_GetError<span class="p">(</span>address<span class="p">,</span><span class="w"> </span><span class="s">&quot;ping_Host2IP&quot;</span><span class="p">)</span><span class="w">         </span><span class="c1">; error handling</span>
<span class="kr">if</span><span class="w"> </span>ErrorLevel
<span class="w">   </span><span class="k">goto</span><span class="w"> </span>error
err<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ping_<span class="p">(</span>address<span class="p">,</span><span class="w"> </span>data<span class="p">,</span><span class="w"> </span>timeout<span class="p">)</span><span class="w">         </span><span class="c1">; ping function call</span>
<span class="nl">error:</span>
EL<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel
<span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;wsock32\WSACleanup&quot;</span><span class="p">)</span><span class="w">            </span><span class="c1">; Sockets cleanup &amp; close</span>
ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>EL
<span class="k">return</span><span class="w"> </span>err
<span class="p">}</span>
</pre></div>


New Lexer: 
<div class="highlight"><pre><span class="c-Singleline">; Ping function by Drugwash April 29, 2010</span>
<span class="c-Singleline">; v2.0</span>
<span class="c-Singleline">;*********************************</span>
<span class="n">ping_</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
<span class="nb">static</span> <span class="n">reply</span>
<span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">SetFormat</span><span class="p">,</span> <span class="n">IntegerFast</span><span class="p">,</span> <span class="n">H</span>
<span class="n">cAdr</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;wsock32\inet_addr&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adr</span><span class="p">,</span> <span class="n">UInt</span><span class="p">)</span><span class="c-Singleline">   ; convert address to 32bit UInt</span>
<span class="nb">if </span><span class="n">cAdr</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
   <span class="n">cAdr</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;ws2_32\inet_addr&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">Int</span><span class="p">)</span><span class="c-Singleline"> ; second attempt at conversion, using ws2_32</span>
<span class="w">      </span><span class="nb">if </span><span class="n">cAdr</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
         <span class="p">{</span>
         <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">         </span><span class="nb">return</span> <span class="n">err</span> <span class="o">:=</span> <span class="s">&quot;Error: Cannot convert address to UInt.&quot;</span>
         <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">; test for function presence since it&#39;s located in different libs through various OS</span>
<span class="n">hLib</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;LoadLibrary&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="s">&quot;iphlpapi.dll&quot;</span><span class="p">)</span>
<span class="nb">if </span><span class="n">hLib</span>
   <span class="p">{</span>
   <span class="n">hPrAdr</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetProcAddress&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">hLib</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="s">&quot;IcmpCreateFile&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="nb">if </span><span class="n">hPrAdr</span><span class="c-Singleline"></span>
<span class="c-Singleline">;      hPort := DllCall(&quot;iphlpapi\IcmpCreateFile&quot;, UInt)   ; open a port (iphlpapi.dll in XP+)</span>
      <span class="n">hPort</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="n">hPrAdr</span><span class="p">,</span> <span class="n">UInt</span><span class="p">)</span><span class="c-Singleline">   ; open a port (iphlpapi.dll in XP+)</span>
<span class="w">   </span><span class="nb">else</span>
      <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;FreeLibrary&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">hLib</span><span class="p">)</span>
   <span class="p">}</span>
<span class="n">if</span> <span class="o">!</span><span class="n">hPort</span>
   <span class="n">hPort</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;icmp\IcmpCreateFile&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">)</span><span class="c-Singleline">   ; open a port (icmp.dll in Win2000 and lower)</span>
<span class="n">if</span> <span class="o">!</span><span class="n">hPort</span>
   <span class="p">{</span>
   <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">   </span><span class="nb">return</span> <span class="n">err</span> <span class="o">:=</span> <span class="s">&quot;Error: Cannot open port.&quot;</span>
   <span class="p">}</span>
<span class="nb">SetFormat</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">D</span>
<span class="n">szreply</span> <span class="o">=</span> <span class="mi">278</span><span class="c-Singleline">                ; ICMP_ECHO_REPLY structure</span>
<span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">szreply</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;icmp\IcmpSendEcho&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">hPort</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">cAdr</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="nf">StrLen</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">szreply</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">UInt</span><span class="p">)</span>
<span class="n">errcode</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span><span class="c-Singleline">   ; check for status</span>
<span class="n">errcode</span> <span class="o">:=</span> <span class="n">errcode</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">errcode</span> <span class="o">:</span> <span class="n">errcode</span><span class="o">+</span><span class="mi">11000</span>
<span class="nb">if </span><span class="n">errcode</span> <span class="o">=</span> <span class="mi">11001</span><span class="c-Singleline">   ; function returned &#39;buffer too small&#39; so we increase it and try again</span>
   <span class="p">{</span>
   <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span>
   <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;icmp\IcmpSendEcho&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">hPort</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">cAdr</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="nf">StrLen</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">szreply</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">UInt</span><span class="p">)</span>
   <span class="n">errcode</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span><span class="c-Singleline">   ; another check for status on 2-nd attempt</span>
   <span class="n">errcode</span> <span class="o">:=</span> <span class="n">errcode</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">errcode</span> <span class="o">:</span> <span class="n">errcode</span><span class="o">+</span><span class="mi">11000</span>
   <span class="p">}</span>
<span class="n">err</span> <span class="o">:=</span> <span class="n">ping_GetError</span><span class="p">(</span><span class="n">errcode</span><span class="p">,</span> <span class="s">&quot;IcmpSendEcho&quot;</span><span class="p">)</span><span class="c-Singleline">   ; error handling</span>
<span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;icmp\IcmpCloseHandle&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">hPort</span><span class="p">)</span><span class="c-Singleline">   ; close port</span>
<span class="nb">if </span><span class="n">errcode</span> <span class="o">!=</span> <span class="mi">11000</span><span class="c-Singleline">            ; IP_SUCCESS</span>
   <span class="p">{</span>
   <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">   </span><span class="nb">return</span> <span class="n">err</span>
   <span class="p">}</span>
<span class="nb">else</span><span class="c-Singleline"></span>
<span class="c-Singleline">; on success returns ICMP_ECHO_REPLY structure address for external processing of data</span>
<span class="w">   </span><span class="nb">return</span> <span class="n">err</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">reply</span>
<span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">;*********************************</span>
<span class="n">ping_GetError</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="s">&quot;[ukn]&quot;</span><span class="p">)</span><span class="c-Singleline">      ; error translation</span>
<span class="p">{</span>
<span class="n">str</span> <span class="o">:=</span> <span class="s">&quot;Success|Reply buffer too small|Destination network unreachable|Destination host unreachable|Destination protocol unreachable|Destination port unreachable|Insufficient IP resources|Bad IP option specified|Hardware error|Packet too big|Request timed out|Bad request|Bad route|TTL expired in transit|TTL expired during fragment reassembly|Parameter problem|Datagrams are arriving too fast to be processed and datagrams may have been discarded|IP option too big|Bad destination|General failure (possible malformed ICMP packets)&quot;</span>
<span class="nb">Loop</span><span class="p">,</span> <span class="n">Parse</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="o">|</span>
   <span class="p">{</span>
   <span class="n">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="mi">11000</span> <span class="o">+</span> <span class="nv">A_Index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">A_Index</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">11050</span><span class="p">)</span>
<span class="w">      </span><span class="nb">return</span> <span class="n">err</span> <span class="o">:=</span> <span class="s">&quot;Error &quot;</span> <span class="n">code</span> <span class="s">&quot; [&quot;</span> <span class="nv">A_LoopField</span> <span class="s">&quot;] in function &quot;</span> <span class="n">func</span>
   <span class="p">}</span>
<span class="nb">return</span> <span class="n">err</span> <span class="o">:=</span> <span class="s">&quot;Function &quot;</span> <span class="n">func</span> <span class="s">&quot; returned &quot;</span> <span class="n">code</span>
<span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">;*********************************</span>
<span class="n">ping_Host2IP</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">type</span> <span class="o">:=</span> <span class="nf">SubStr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">if </span><span class="n">type</span> <span class="ow">is</span> <span class="n">alpha</span>
   <span class="p">{</span>
   <span class="n">hostent</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;ws2_32\gethostbyname&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">UInt</span><span class="p">)</span><span class="c-Singleline"> ; http://msdn.microsoft.com/en-us/library/ms738524(VS.85).aspx</span>
   <span class="n">if</span> <span class="o">!</span><span class="n">hostent</span>
      <span class="p">{</span>
      <span class="n">err</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;ws2_32\WSAGetLastError&quot;</span><span class="p">)</span>
      <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">      </span><span class="nb">return</span> <span class="n">err</span>
      <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">   ; string containing protocol types (mainly for debug purposes)</span>
   <span class="n">str</span> <span class="o">:=</span> <span class="s">&quot;local to host (pipes, portals)|internetwork: UDP, TCP, etc.|arpanet imp addresses|pup protocols: e.g. BSP|mit CHAOS protocols|XEROX NS protocols or IPX protocols: IPX, SPX, etc.|ISO protocols or OSI is ISO|european computer manufacturers|datakit protocols|CCITT protocols, X.25 etc|IBM SNA|DECnet|Direct data link interface|LAT|NSC Hyperchannel|AppleTalk|NetBios-style addresses|VoiceView|Protocols from Firefox|Unknown - Somebody is using this!|Banyan|Native ATM Services|Internetwork Version 6|Microsoft Wolfpack|IEEE 1284.4 WG AF&quot;</span>
   <span class="n">ptrName</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">hostent</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span>
   <span class="n">pt</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">hostent</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="nb">Loop</span><span class="p">,</span> <span class="n">Parse</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="o">|</span>
      <span class="n">if</span> <span class="p">(</span><span class="nv">A_Index</span> <span class="o">=</span> <span class="n">pt</span><span class="p">)</span>
         <span class="n">type</span> <span class="o">:=</span> <span class="nv">A_LoopField</span>
   <span class="n">len</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">hostent</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span>
   <span class="n">ptrAddress</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">hostent</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span>
   <span class="n">ptrIPAddress</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">ptrAddress</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span>
   <span class="n">strAddress</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">ptrIPAddress</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span>
   <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
   <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;lstrcpy&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adr</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;ws2_32\inet_ntoa&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">strAddress</span><span class="p">))</span>
   <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
   <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
   <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;lstrcpy&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pname</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">ptrName</span><span class="p">)</span>
   <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">   </span><span class="nb">return</span> <span class="n">adr</span>
   <span class="p">}</span>
<span class="nb">else</span>
<span class="w">   </span><span class="nb">return</span> <span class="n">name</span>
<span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">;*********************************</span>
<span class="n">ping_DW2IP</span><span class="p">(</span><span class="n">adr</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">res</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">adr</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Uchar&quot;</span><span class="p">)</span> <span class="s">&quot;.&quot;</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">adr</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Uchar&quot;</span><span class="p">)</span> <span class="s">&quot;.&quot;</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">adr</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Uchar&quot;</span><span class="p">)</span> <span class="s">&quot;.&quot;</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">adr</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;Uchar&quot;</span><span class="p">)</span>
<span class="nb">return</span> <span class="n">res</span>
<span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">;*********************************</span>
<span class="n">ping</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s">&quot;AHK ping test&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="s">&quot;500&quot;</span><span class="p">)</span>
<span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">; Sockets initialization http://msdn.microsoft.com/en-us/library/ms741563(VS.85).aspx</span>
<span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">WSADATA</span><span class="p">,</span> <span class="mi">12</span><span class="o">+</span><span class="mi">257</span><span class="o">+</span><span class="mi">129</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="c-Singleline">   ; WSADATA structure initialization</span>
<span class="n">err</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;wsock32\WSAStartup&quot;</span><span class="p">,</span> <span class="n">Short</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">WSADATA</span><span class="p">,</span> <span class="n">UInt</span><span class="p">)</span>
<span class="nb">if </span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span>
   <span class="p">{</span>
   <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="n">err</span> <span class="o">=</span> <span class="n">Socket</span> <span class="n">initialization</span> <span class="n">error</span> <span class="nv">%err%</span><span class="c-Singleline">      ; Failed to initialize sockets</span>
<span class="w">   </span><span class="nb">goto</span> <span class="n">error</span>
   <span class="p">}</span>
<span class="n">address</span> <span class="o">:=</span> <span class="n">ping_Host2IP</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="c-Singleline">               ; address conversion to DWORD</span>
<span class="n">err</span> <span class="o">:=</span> <span class="n">ping_GetError</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="s">&quot;ping_Host2IP&quot;</span><span class="p">)</span><span class="c-Singleline">         ; error handling</span>
<span class="nb">if </span><span class="nv">ErrorLevel</span>
<span class="w">   </span><span class="nb">goto</span> <span class="n">error</span>
<span class="n">err</span> <span class="o">:=</span> <span class="n">ping_</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span><span class="c-Singleline">         ; ping function call</span>
<span class="nl">error:</span>
<span class="n">EL</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span>
<span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;wsock32\WSACleanup&quot;</span><span class="p">)</span><span class="c-Singleline">            ; Sockets cleanup &amp; close</span>
<span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">EL</span>
<span class="nb">return</span> <span class="n">err</span>
<span class="p">}</span>
</pre></div>
