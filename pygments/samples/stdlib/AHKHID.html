<LINK href="styles.css" rel="stylesheet" type="text/css"><div class="highlight"><pre><span class="cm">/*! TheGood</span>
<span class="cm">    AHKHID - An AHK implementation of the HID functions.</span>
<span class="cm">    Last updated: June 14th, 2010</span>

<span class="cm">USING THE CONSTANTS:</span>

<span class="cm">If you explicitly #include AHKHID in your script, you will have all the constants available to you. Otherwise, if AHKHID is</span>
<span class="cm">in your library folder and you do not wish to explicitly #include it, you can call AHKHID_UseConstants() to have the</span>
<span class="cm">constants available to you.</span>

<span class="cm">FUNCTION LIST:</span>
<span class="cm">_____________________</span>
<span class="cm">AHKHID_UseConstants()</span>

<span class="cm">See the section above titled &quot;USING THE CONSTANTS&quot;</span>
<span class="cm">___________________________________</span>
<span class="cm">AHKHID_Initialize(bRefresh = False)</span>

<span class="cm">You don&#39;t have to call this function manually. It is automatically called by other functions to get the pointer of the</span>
<span class="cm">RAWINPUTDEVICELIST struct array. However, if a new device is plugged in, you will have to refresh the listing by calling it</span>
<span class="cm">with bRefresh = True. Returns -1 on error (with error message in ErrorLevel).</span>
<span class="cm">____________________</span>
<span class="cm">AHKHID_GetDevCount()</span>

<span class="cm">Returs the number of HID devices connected to this computer.</span>
<span class="cm">Returns -1 on error (with error message in ErrorLevel).</span>
<span class="cm">______________________</span>
<span class="cm">AHKHID_GetDevHandle(i)</span>

<span class="cm">Returns the handle of device i (starts at 1).</span>
<span class="cm">Mostly used internally for API calls.</span>
<span class="cm">__________________________</span>
<span class="cm">AHKHID_GetDevIndex(Handle)</span>

<span class="cm">Returns the index (starts at 1) of the device in the enumeration with matching handle.</span>
<span class="cm">Returns 0 if not found.</span>
<span class="cm">______________________________________</span>
<span class="cm">AHKHID_GetDevType(i, IsHandle = False)</span>

<span class="cm">Returns the type of the device. See the RIM_ constants for possible values.</span>
<span class="cm">If IsHandle is false, then i is considered the index (starts at 1) of the device in the enumeration.</span>
<span class="cm">Otherwise it is the handle of the device.</span>
<span class="cm">______________________________________</span>
<span class="cm">AHKHID_GetDevName(i, IsHandle = False)</span>

<span class="cm">Returns the name of the device (or empty string on error, with error message in ErrorLevel).</span>
<span class="cm">If IsHandle is false, then i is considered the index (starts at 1) of the device in the enumeration.</span>
<span class="cm">Otherwise it is the handle of the device.</span>
<span class="cm">____________________________________________</span>
<span class="cm">AHKHID_GetDevInfo(i, Flag, IsHandle = False)</span>

<span class="cm">Retrieves info from the RID_DEVICE_INFO struct. To retrieve a member, simply use the corresponding flag. A list of flags</span>
<span class="cm">can be found at the top of the script (the constants starting with DI_). Each flag corresponds to a member in the struct.</span>
<span class="cm">If IsHandle is false, then i is considered the index (starts at 1) of the device in the enumeration. Otherwise it is the</span>
<span class="cm">handle of the device. Returns -1 on error (with error message in ErrorLevel).</span>

<span class="cm">See Example 1 for an example on how to use it. </span>
<span class="cm">_______________________________________________________________________________</span>
<span class="cm">AHKHID_AddRegister(UsagePage = False, Usage = False, Handle = False, Flags = 0)</span>

<span class="cm">Allows you to queue up RAWINPUTDEVICE structures before doing the registration. To use it, you first need to initialize the</span>
<span class="cm">variable by calling AHKHID_AddRegister(iNumberOfElements). To then add to the stack, simply call it with the parameters you</span>
<span class="cm">want (eg. AHKHID_AddRegister(1,6,MyGuiHandle) for keyboards). When you&#39;re finally done, you just have to call</span>
<span class="cm">AHKHID_Register() with no parameters. The function returns -1 if the struct is full. Redimensioning the struct will erase</span>
<span class="cm">all previous structs added. On success, it returns the address of the array of structs (if you&#39;d rather manipulate it</span>
<span class="cm">yourself).</span>

<span class="cm">See Example 2 for an example on how to use it.</span>

<span class="cm">You will need to do this if you want to use advance features of the RAWINPUTDEVICE flags. For example, if you want to</span>
<span class="cm">register all devices using Usage Page 1 but would like to exclude devices of Usage Page 1 using Usage 2 (keyboards), then</span>
<span class="cm">you need to place two elements in the array. The first one is AHKHID_AddRegister(1,0,MyGuiHandle,RIDEV_PAGEONLY) and the</span>
<span class="cm">second one is AHKHID_AddRegister(1,2,MyGuiHandle,RIDEV_EXCLUDE).</span>

<span class="cm">Tip: Have a look at all the flags you can use (see the constants starting with RIDEV_). The most useful is RIDEV_INPUTSINK.</span>
<span class="cm">Tip: Set Handle to 0 if you want the WM_INPUT messages to go to the window with keyboard focus.</span>
<span class="cm">Tip: To unregister, use the flag RIDEV_REMOVE. Note that you also need to use the RIDEV_PAGEONLY flag if the TLC was</span>
<span class="cm">registered with it.</span>
<span class="cm">____________________________________________________________________________</span>
<span class="cm">AHKHID_Register(UsagePage = False, Usage = False, Handle = False, Flags = 0)</span>

<span class="cm">This function can be used in two ways. If no parameters are specified, it will use the RAWINPUTDEVICE array created through</span>
<span class="cm">AHKHID_AddRegister() and register. Otherwise, it will register only the specified parameters. For example, if you just want</span>
<span class="cm">to register the mouse, you can simply do AHKHID_Register(1,2,MyGuiHandle). Returns 0 on success, returns -1 on error (with</span>
<span class="cm">error message in ErrorLevel).</span>

<span class="cm">See Example 2 for an example on how to use it with the RAWINPUTDEVICE.</span>
<span class="cm">See Example 3 for an example on how to use it only with the specified parameters.</span>
<span class="cm">____________________________________</span>
<span class="cm">AHKHID_GetRegisteredDevs(ByRef uDev)</span>

<span class="cm">This function allows you to get an array of the TLCs that have already been registered.</span>
<span class="cm">It fills uDev with an array of RAWINPUTDEVICE and returns the number of elements in the array.</span>
<span class="cm">Returns -1 on error (with error message in ErrorLevel).</span>

<span class="cm">See Example 2 for an example on how to use it.</span>
<span class="cm">______________________________________</span>
<span class="cm">AHKHID_GetInputInfo(InputHandle, Flag)</span>

<span class="cm">This function is used to retrieve the data upon receiving WM_INPUT messages. By passing the lParam of the WM_INPUT (0xFF00)</span>
<span class="cm">messages, it can retrieve all the members of the RAWINPUT structure, except the raw data coming from HID devices (use</span>
<span class="cm">AHKHID_GetInputData for that). To retrieve a member, simply specify the flag corresponding to the member you want, and call</span>
<span class="cm">the function. A list of all the flags can be found at the top of this script (the constants starting with II_). Returns -1</span>
<span class="cm">on error (with error message in ErrorLevel).</span>

<span class="cm">See Example 2 for an example on how to use it to retrieve each member of the structure.</span>
<span class="cm">See Example 3 for an example on how to interpret members which represent flags.</span>

<span class="cm">Tip: You have to use Critical in your message function or you might get invalid handle errors.</span>
<span class="cm">Tip: You can check the value of wParam to know if the application was in the foreground upon reception (see RIM_INPUT).</span>
<span class="cm">_____________________________________________</span>
<span class="cm">AHKHID_GetInputData(InputHandle, ByRef uData)</span>

<span class="cm">This function is used to retrieve the data sent by HID devices of type RIM_TYPEHID (ie. neither keyboard nor mouse) upon</span>
<span class="cm">receiving WM_INPUT messages. CAUTION: it does not check if the device is indeed of type HID. It is up to you to do so (you</span>
<span class="cm">can use GetInputInfo for that). Specify the lParam of the WM_INPUT (0xFF00) message and the function will put in uData the</span>
<span class="cm">raw data received from the device. It will then return the size (number of bytes) of uData. Returns -1 on error (with error</span>
<span class="cm">message in ErrorLevel).</span>

<span class="cm">See Example 2 for an example on how to use it (although you need an HID device of type RIM_TYPEHID to test it).</span>

<span class="cm">*/</span>

<span class="n">AHKHID_Included</span> <span class="o">:=</span> <span class="nv">True</span>
<span class="nl">AHKHID_SetConstants:</span><span class="c-Singleline"></span>
<span class="c-Singleline">;______________________________________</span>
<span class="c-Singleline">;Flags you can use in AHKHID_GetDevInfo</span>
<span class="n">DI_DEVTYPE</span>                  <span class="o">:=</span> <span class="mi">4</span><span class="c-Singleline">    ;Type of the device. See RIM_ constants.</span>

<span class="n">DI_MSE_ID</span>                   <span class="o">:=</span> <span class="mi">8</span><span class="c-Singleline">    ;ID for the mouse device.</span>
<span class="n">DI_MSE_NUMBEROFBUTTONS</span>      <span class="o">:=</span> <span class="mi">12</span><span class="c-Singleline">   ;Number of buttons for the mouse.</span>
<span class="n">DI_MSE_SAMPLERATE</span>           <span class="o">:=</span> <span class="mi">16</span><span class="c-Singleline">   ;Number of data points per second. This information may not be applicable for every</span>
<span class="c-Singleline">                                    ;mouse device.</span>
<span class="n">DI_MSE_HASHORIZONTALWHEEL</span>   <span class="o">:=</span> <span class="mi">20</span><span class="c-Singleline">   ;Vista and later only: TRUE if the mouse has a wheel for horizontal scrolling;</span>
<span class="c-Singleline">                                    ;otherwise, FALSE.</span>

<span class="n">DI_KBD_TYPE</span>                 <span class="o">:=</span> <span class="mi">8</span><span class="c-Singleline">    ;Type of the keyboard. </span>
<span class="n">DI_KBD_SUBTYPE</span>              <span class="o">:=</span> <span class="mi">12</span><span class="c-Singleline">   ;Subtype of the keyboard. </span>
<span class="n">DI_KBD_KEYBOARDMODE</span>         <span class="o">:=</span> <span class="mi">16</span><span class="c-Singleline">   ;Scan code mode. </span>
<span class="n">DI_KBD_NUMBEROFFUNCTIONKEYS</span> <span class="o">:=</span> <span class="mi">20</span><span class="c-Singleline">   ;Number of function keys on the keyboard.</span>
<span class="n">DI_KBD_NUMBEROFINDICATORS</span>   <span class="o">:=</span> <span class="mi">24</span><span class="c-Singleline">   ;Number of LED indicators on the keyboard.</span>
<span class="n">DI_KBD_NUMBEROFKEYSTOTAL</span>    <span class="o">:=</span> <span class="mi">28</span><span class="c-Singleline">   ;Total number of keys on the keyboard. </span>

<span class="n">DI_HID_VENDORID</span>             <span class="o">:=</span> <span class="mi">8</span><span class="c-Singleline">    ;Vendor ID for the HID.</span>
<span class="n">DI_HID_PRODUCTID</span>            <span class="o">:=</span> <span class="mi">12</span><span class="c-Singleline">   ;Product ID for the HID. </span>
<span class="n">DI_HID_VERSIONNUMBER</span>        <span class="o">:=</span> <span class="mi">16</span><span class="c-Singleline">   ;Version number for the HID. </span>
<span class="n">DI_HID_USAGEPAGE</span>            <span class="o">:=</span> <span class="mi">20</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="c-Singleline">  ;Top-level collection Usage Page for the device.</span>
<span class="n">DI_HID_USAGE</span>                <span class="o">:=</span> <span class="mi">22</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="c-Singleline">  ;Top-level collection Usage for the device.</span>
<span class="c-Singleline">;_____________________________________</span>
<span class="c-Singleline">;Flags you can use in HID_GetInputInfo</span>
<span class="n">II_DEVTYPE</span>          <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline">    ;Type of the device generating the raw input data. See RIM_ constants.</span>
<span class="n">II_DEVHANDLE</span>        <span class="o">:=</span> <span class="mi">8</span><span class="c-Singleline">    ;Handle to the device generating the raw input data.</span>

<span class="n">II_MSE_FLAGS</span>        <span class="o">:=</span> <span class="mi">16</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="c-Singleline">  ;Mouse state. This member can be any reasonable combination of the following values</span>
<span class="c-Singleline">                                    ; -&gt; see MOUSE constants.</span>
<span class="n">II_MSE_BUTTONFLAGS</span>  <span class="o">:=</span> <span class="mi">20</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="c-Singleline">  ;Transition state of the mouse buttons. This member can be one or more of the following</span>
<span class="c-Singleline">                                    ;values -&gt; see RI_MOUSE constants.</span>
<span class="n">II_MSE_BUTTONDATA</span>   <span class="o">:=</span> <span class="mi">22</span> <span class="o">|</span> <span class="mh">0x1100</span><span class="c-Singleline">  ;If usButtonFlags is RI_MOUSE_WHEEL, this member is a signed value that specifies the</span>
<span class="c-Singleline">                                    ;wheel delta.</span>
<span class="n">II_MSE_RAWBUTTONS</span>   <span class="o">:=</span> <span class="mi">24</span><span class="c-Singleline">           ;Raw state of the mouse buttons. </span>
<span class="n">II_MSE_LASTX</span>        <span class="o">:=</span> <span class="mi">28</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="c-Singleline">  ;Motion in the X direction. This is signed relative motion or absolute motion,</span>
<span class="c-Singleline">                                    ;depending on the value of usFlags.</span>
<span class="n">II_MSE_LASTY</span>        <span class="o">:=</span> <span class="mi">32</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="c-Singleline">  ;Motion in the Y direction. This is signed relative motion or absolute motion,</span>
<span class="c-Singleline">                                    ;depending on the value of usFlags. </span>
<span class="n">II_MSE_EXTRAINFO</span>    <span class="o">:=</span> <span class="mi">36</span><span class="c-Singleline">           ;Device-specific additional information for the event. </span>

<span class="n">II_KBD_MAKECODE</span>     <span class="o">:=</span> <span class="mi">16</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="c-Singleline">  ;Scan code from the key depression. The scan code for keyboard overrun is</span>
<span class="c-Singleline">                                    ;KEYBOARD_OVERRUN_MAKE_CODE.</span>
<span class="n">II_KBD_FLAGS</span>        <span class="o">:=</span> <span class="mi">18</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="c-Singleline">  ;Flags for scan code information. It can be one or more of the following values</span>
<span class="c-Singleline">                                    ;-&gt; see RI_KEY constants.</span>
<span class="n">II_KBD_VKEY</span>         <span class="o">:=</span> <span class="mi">22</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="c-Singleline">  ;Microsoft Windows message compatible virtual-key code.</span>
<span class="n">II_KBD_MSG</span>          <span class="o">:=</span> <span class="mi">24</span><span class="c-Singleline">           ;Corresponding window message, for example WM_KEYDOWN, WM_SYSKEYDOWN, and so forth.</span>
<span class="n">II_KBD_EXTRAINFO</span>    <span class="o">:=</span> <span class="mi">28</span><span class="c-Singleline">           ;Device-specific additional information for the event.</span>

<span class="n">II_HID_SIZE</span>         <span class="o">:=</span> <span class="mi">16</span><span class="c-Singleline">           ;Size, in bytes, of each HID input in bRawData.</span>
<span class="n">II_HID_COUNT</span>        <span class="o">:=</span> <span class="mi">20</span><span class="c-Singleline">           ;Number of HID inputs in bRawData.</span>

<span class="c-Singleline">;DO NOT USE WITH AHKHID_GetInputInfo. Use AHKHID_GetInputData instead to retrieve the raw data.</span>
<span class="n">II_HID_DATA</span>         <span class="o">:=</span> <span class="mi">24</span><span class="c-Singleline">           ;Raw input data as an array of bytes.</span>
<span class="c-Singleline">;__________________________________________________________________________________</span>
<span class="c-Singleline">;Device type values returned by AHKHID_GetDevType as well as DI_DEVTYPE and II_DEVTYPE</span>
<span class="c-Singleline">;http://msdn.microsoft.com/en-us/library/ms645568</span>
<span class="n">RIM_TYPEMOUSE</span>       <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline">    ;The device is a mouse.</span>
<span class="n">RIM_TYPEKEYBOARD</span>    <span class="o">:=</span> <span class="mi">1</span><span class="c-Singleline">    ;The device is a keyboard.</span>
<span class="n">RIM_TYPEHID</span>         <span class="o">:=</span> <span class="mi">2</span><span class="c-Singleline">    ;The device is an Human Interface Device (HID) that is not a keyboard and not a mouse.</span>
<span class="c-Singleline">;_______________________________________________________________________________________________</span>
<span class="c-Singleline">;Different flags for RAWINPUTDEVICE structure (to be used with AHKHID_AddRegister and AHKHID_Register)</span>
<span class="c-Singleline">;http://msdn.microsoft.com/en-us/library/ms645565</span>
<span class="n">RIDEV_REMOVE</span>        <span class="o">:=</span> <span class="mh">0x00000001</span><span class="c-Singleline">   ;If set, this removes the top level collection from the inclusion list. This tells the</span>
<span class="c-Singleline">                                    ;operating system to stop reading from a device which matches the top level collection.</span>
<span class="n">RIDEV_EXCLUDE</span>       <span class="o">:=</span> <span class="mh">0x00000010</span><span class="c-Singleline">   ;If set, this specifies the top level collections to exclude when reading a complete</span>
<span class="c-Singleline">                                    ;usage page. This flag only affects a TLC whose usage page is already specified with</span>
<span class="c-Singleline">                                    ;RIDEV_PAGEONLY.</span>
<span class="n">RIDEV_PAGEONLY</span>      <span class="o">:=</span> <span class="mh">0x00000020</span><span class="c-Singleline">   ;If set, this specifies all devices whose top level collection is from the specified</span>
<span class="c-Singleline">                                    ;usUsagePage. Note that usUsage must be zero. To exclude a particular top level</span>
<span class="c-Singleline">                                    ;collection, use RIDEV_EXCLUDE.</span>
<span class="n">RIDEV_NOLEGACY</span>      <span class="o">:=</span> <span class="mh">0x00000030</span><span class="c-Singleline">   ;If set, this prevents any devices specified by usUsagePage or usUsage from generating</span>
<span class="c-Singleline">                                    ;legacy messages. This is only for the mouse and keyboard. See Remarks.</span>
<span class="n">RIDEV_INPUTSINK</span>     <span class="o">:=</span> <span class="mh">0x00000100</span><span class="c-Singleline">   ;If set, this enables the caller to receive the input even when the caller is not in</span>
<span class="c-Singleline">                                    ;the foreground. Note that hwndTarget must be specified.</span>
<span class="n">RIDEV_CAPTUREMOUSE</span>  <span class="o">:=</span> <span class="mh">0x00000200</span><span class="c-Singleline">   ;If set, the mouse button click does not activate the other window.</span>
<span class="n">RIDEV_NOHOTKEYS</span>     <span class="o">:=</span> <span class="mh">0x00000200</span><span class="c-Singleline">   ;If set, the application-defined keyboard device hotkeys are not handled. However, the</span>
<span class="c-Singleline">                                    ;system hotkeys; for example, ALT+TAB and CTRL+ALT+DEL, are still handled. By default,</span>
<span class="c-Singleline">                                    ;all keyboard hotkeys are handled. RIDEV_NOHOTKEYS can be specified even if</span>
<span class="c-Singleline">                                    ;RIDEV_NOLEGACY is not specified and hwndTarget is NULL.</span>
<span class="n">RIDEV_APPKEYS</span>       <span class="o">:=</span> <span class="mh">0x00000400</span><span class="c-Singleline">   ;Microsoft Windows XP Service Pack 1 (SP1): If set, the application command keys are</span>
<span class="c-Singleline">                                    ;handled. RIDEV_APPKEYS can be specified only if RIDEV_NOLEGACY is specified for a</span>
<span class="c-Singleline">                                    ;keyboard device.</span>
<span class="n">RIDEV_EXINPUTSINK</span>   <span class="o">:=</span> <span class="mh">0x00001000</span><span class="c-Singleline">   ;Vista and later only: If set, this enables the caller to receive input in the</span>
<span class="c-Singleline">                                    ;background only if the foreground application does not process it. In other words, if</span>
<span class="c-Singleline">                                    ;the foreground application is not registered for raw input, then the background</span>
<span class="c-Singleline">                                    ;application that is registered will receive the input.</span>
<span class="n">RIDEV_DEVNOTIFY</span>     <span class="o">:=</span> <span class="mh">0x00002000</span><span class="c-Singleline">   ;Vista and later only: If set, this enables the caller to receive WM_INPUT_DEVICE_CHANGE</span>
<span class="c-Singleline">                                    ;notifications for device arrival and device removal.</span>
<span class="c-Singleline">;__________________________________________________</span>
<span class="c-Singleline">;Different values of wParam in the WM_INPUT message</span>
<span class="c-Singleline">;http://msdn.microsoft.com/en-us/library/ms645590</span>
<span class="n">RIM_INPUT</span>       <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline">    ;Input occurred while the application was in the foreground. The application must call</span>
<span class="c-Singleline">                        ;DefWindowProc so the system can perform cleanup.</span>
<span class="n">RIM_INPUTSINK</span>   <span class="o">:=</span> <span class="mi">1</span><span class="c-Singleline">    ;Input occurred while the application was not in the foreground. The application must call</span>
<span class="c-Singleline">                        ;DefWindowProc so the system can perform the cleanup.</span>
<span class="c-Singleline">;__________________________________</span>
<span class="c-Singleline">;Flags for GetRawInputData API call</span>
<span class="c-Singleline">;http://msdn.microsoft.com/en-us/library/ms645596</span>
<span class="n">RID_INPUT</span>    <span class="o">:=</span> <span class="mh">0x10000003</span><span class="c-Singleline">    ;Get the raw data from the RAWINPUT structure.</span>
<span class="n">RID_HEADER</span>   <span class="o">:=</span> <span class="mh">0x10000005</span><span class="c-Singleline">    ;Get the header information from the RAWINPUT structure.</span>
<span class="c-Singleline">;_____________________________________</span>
<span class="c-Singleline">;Flags for RAWMOUSE (part of RAWINPUT)</span>
<span class="c-Singleline">;http://msdn.microsoft.com/en-us/library/ms645578</span>

<span class="c-Singleline">;Flags for the II_MSE_FLAGS member</span>
<span class="n">MOUSE_MOVE_RELATIVE</span>         <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline">     ;Mouse movement data is relative to the last mouse position.</span>
<span class="n">MOUSE_MOVE_ABSOLUTE</span>         <span class="o">:=</span> <span class="mi">1</span><span class="c-Singleline">     ;Mouse movement data is based on absolute position.</span>
<span class="n">MOUSE_VIRTUAL_DESKTOP</span>       <span class="o">:=</span> <span class="mh">0x02</span><span class="c-Singleline">  ;Mouse coordinates are mapped to the virtual desktop (for a multiple monitor system)</span>
<span class="n">MOUSE_ATTRIBUTES_CHANGED</span>    <span class="o">:=</span> <span class="mh">0x04</span><span class="c-Singleline">  ;Mouse attributes changed; application needs to query the mouse attributes.</span>

<span class="c-Singleline">;Flags for the II_MSE_BUTTONFLAGS member</span>
<span class="n">RI_MOUSE_LEFT_BUTTON_DOWN</span>   <span class="o">:=</span> <span class="mh">0x0001</span><span class="c-Singleline">   ;Self-explanatory</span>
<span class="n">RI_MOUSE_LEFT_BUTTON_UP</span>     <span class="o">:=</span> <span class="mh">0x0002</span><span class="c-Singleline">   ;Self-explanatory</span>
<span class="n">RI_MOUSE_RIGHT_BUTTON_DOWN</span>  <span class="o">:=</span> <span class="mh">0x0004</span><span class="c-Singleline">   ;Self-explanatory</span>
<span class="n">RI_MOUSE_RIGHT_BUTTON_UP</span>    <span class="o">:=</span> <span class="mh">0x0008</span><span class="c-Singleline">   ;Self-explanatory</span>
<span class="n">RI_MOUSE_MIDDLE_BUTTON_DOWN</span> <span class="o">:=</span> <span class="mh">0x0010</span><span class="c-Singleline">   ;Self-explanatory</span>
<span class="n">RI_MOUSE_MIDDLE_BUTTON_UP</span>   <span class="o">:=</span> <span class="mh">0x0020</span><span class="c-Singleline">   ;Self-explanatory</span>
<span class="n">RI_MOUSE_BUTTON_4_DOWN</span>      <span class="o">:=</span> <span class="mh">0x0040</span><span class="c-Singleline">   ;XBUTTON1 changed to down.</span>
<span class="n">RI_MOUSE_BUTTON_4_UP</span>        <span class="o">:=</span> <span class="mh">0x0080</span><span class="c-Singleline">   ;XBUTTON1 changed to up.</span>
<span class="n">RI_MOUSE_BUTTON_5_DOWN</span>      <span class="o">:=</span> <span class="mh">0x0100</span><span class="c-Singleline">   ;XBUTTON2 changed to down.</span>
<span class="n">RI_MOUSE_BUTTON_5_UP</span>        <span class="o">:=</span> <span class="mh">0x0200</span><span class="c-Singleline">   ;XBUTTON2 changed to up.</span>
<span class="n">RI_MOUSE_WHEEL</span>              <span class="o">:=</span> <span class="mh">0x0400</span><span class="c-Singleline">   ;Raw input comes from a mouse wheel. The wheel delta is stored in usButtonData.</span>
<span class="c-Singleline">;____________________________________________</span>
<span class="c-Singleline">;Flags for the RAWKEYBOARD (part of RAWINPUT)</span>
<span class="c-Singleline">;http://msdn.microsoft.com/en-us/library/ms645575</span>

<span class="c-Singleline">;Flag for the II_KBD_MAKECODE member in the event of a keyboard overrun</span>
<span class="n">KEYBOARD_OVERRUN_MAKE_CODE</span>  <span class="o">:=</span> <span class="mh">0xFF</span><span class="c-Singleline"></span>

<span class="c-Singleline">;Flags for the II_KBD_FLAGS member</span>
<span class="n">RI_KEY_MAKE</span>             <span class="o">:=</span> <span class="mi">0</span>
<span class="n">RI_KEY_BREAK</span>            <span class="o">:=</span> <span class="mi">1</span>
<span class="n">RI_KEY_E0</span>               <span class="o">:=</span> <span class="mi">2</span>
<span class="n">RI_KEY_E1</span>               <span class="o">:=</span> <span class="mi">4</span>
<span class="n">RI_KEY_TERMSRV_SET_LED</span>  <span class="o">:=</span> <span class="mi">8</span>
<span class="n">RI_KEY_TERMSRV_SHADOW</span>   <span class="o">:=</span> <span class="mh">0x10</span><span class="c-Singleline"></span>
<span class="c-Singleline">;____________________________________</span>
<span class="c-Singleline">;AHKHID FUNCTIONS</span>

<span class="nb">If </span><span class="n">Not</span> <span class="n">AHKHID_Included</span>
<span class="w">    </span><span class="nb">Return</span>

<span class="n">AHKHID_UseConstants</span><span class="p">()</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Global</span><span class="c-Singleline"> ;To make the constants global</span>
    <span class="n">AHKHID_Included</span> <span class="o">:=</span> <span class="nv">False</span>
<span class="w">    </span><span class="nb">Gosub</span><span class="p">,</span> <span class="n">AHKHID_SetConstants</span>
<span class="p">}</span>

<span class="n">AHKHID_Initialize</span><span class="p">(</span><span class="n">bRefresh</span> <span class="o">=</span> <span class="nv">False</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">uHIDList</span><span class="p">,</span> <span class="n">bInitialized</span> <span class="o">:=</span> <span class="nv">False</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">If </span><span class="n">bInitialized</span> <span class="n">And</span> <span class="n">Not</span> <span class="n">bRefresh</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">&amp;</span><span class="n">uHIDList</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get the device count</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputDeviceList&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iCount</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check for error</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputDeviceList</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Prep var</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uHIDList</span><span class="p">,</span> <span class="n">iCount</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputDeviceList&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uHIDList</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iCount</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputDeviceList</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>
    
    <span class="n">bInitialized</span> <span class="o">:=</span> <span class="nv">True</span>
<span class="w">    </span><span class="nb">Return</span> <span class="o">&amp;</span><span class="n">uHIDList</span>
<span class="p">}</span>

<span class="n">AHKHID_GetDevCount</span><span class="p">()</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get the device count</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputDeviceList&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iCount</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check for error</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputDeviceList</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">Return</span> <span class="n">iCount</span>
<span class="p">}</span>

<span class="n">AHKHID_GetDevHandle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Return</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">AHKHID_Initialize</span><span class="p">(),</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">AHKHID_GetDevIndex</span><span class="p">(</span><span class="n">Handle</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Loop</span> <span class="o">%</span> <span class="n">AHKHID_GetDevCount</span><span class="p">()</span>
        <span class="n">If</span> <span class="p">(</span><span class="nf">NumGet</span><span class="p">(</span><span class="n">AHKHID_Initialize</span><span class="p">(),</span> <span class="p">(</span><span class="nv">A_Index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">Handle</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Return</span> <span class="nv">A_Index</span>
<span class="w">    </span><span class="nb">Return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="n">AHKHID_GetDevType</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IsHandle</span> <span class="o">=</span> <span class="nv">False</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Return</span> <span class="n">Not</span> <span class="n">IsHandle</span> <span class="o">?</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">AHKHID_Initialize</span><span class="p">(),</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">:</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">AHKHID_Initialize</span><span class="p">(),</span> <span class="p">((</span><span class="n">AHKHID_GetDevIndex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">AHKHID_GetDevName</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IsHandle</span> <span class="o">=</span> <span class="nv">False</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get index if i is handle</span>
    <span class="n">h</span> <span class="o">:=</span> <span class="n">IsHandle</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="n">AHKHID_GetDevHandle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get device name length.                                 RIDI_DEVICENAME</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputDeviceInfo&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x20000007</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iLength</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputDeviceInfo</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="s">&quot;&quot;</span>
    <span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">    ;Get device name.</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">iLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="c-Singleline">                          ;RIDI_DEVICENAME</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputDeviceInfo&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x20000007</span><span class="p">,</span> <span class="s">&quot;Str&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iLength</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputDeviceInfo</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="s">&quot;&quot;</span>
    <span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">Return</span> <span class="n">s</span>
<span class="p">}</span>

<span class="n">AHKHID_GetDevInfo</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">IsHandle</span> <span class="o">=</span> <span class="nv">False</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">uInfo</span><span class="p">,</span> <span class="n">iLastHandle</span> <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get index if i is handle</span>
    <span class="n">h</span> <span class="o">:=</span> <span class="n">IsHandle</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="n">AHKHID_GetDevHandle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if the handle changed</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">iLastHandle</span><span class="p">)</span><span class="c-Singleline"> ;It&#39;s the same device. No need to call again</span>
<span class="w">        </span><span class="nb">Return</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">uInfo</span><span class="p">,</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">AHKHID_NumIsShort</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;UShort&quot;</span> <span class="o">:</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">Else</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Get device info buffer size.                            RIDI_DEVICEINFO</span>
        <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputDeviceInfo&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x2000000b</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iLength</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputDeviceInfo</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Get device info</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uInfo</span><span class="p">,</span> <span class="n">iLength</span><span class="p">)</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="n">iLength</span><span class="p">,</span> <span class="n">uInfo</span><span class="p">)</span><span class="c-Singleline">    ;Put length in struct          RIDI_DEVICEINFO</span>
        <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputDeviceInfo&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x2000000b</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uInfo</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iLength</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputDeviceInfo</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Successful. Keep handle.</span>
        <span class="n">iLastHandle</span> <span class="o">:=</span> <span class="n">h</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Retrieve data</span>
<span class="w">        </span><span class="nb">Return</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">uInfo</span><span class="p">,</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">AHKHID_NumIsShort</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;UShort&quot;</span> <span class="o">:</span> <span class="s">&quot;UInt&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">Return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="n">AHKHID_AddRegister</span><span class="p">(</span><span class="n">UsagePage</span> <span class="o">=</span> <span class="nv">False</span><span class="p">,</span> <span class="n">Usage</span> <span class="o">=</span> <span class="nv">False</span><span class="p">,</span> <span class="n">Handle</span> <span class="o">=</span> <span class="nv">False</span><span class="p">,</span> <span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">uDev</span><span class="p">,</span> <span class="n">iIndex</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iCount</span> <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if we just want the address</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="p">(</span><span class="n">UsagePage</span> <span class="n">Or</span> <span class="n">Usage</span> <span class="n">Or</span> <span class="n">Handle</span> <span class="n">Or</span> <span class="n">Flags</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">&amp;</span><span class="n">uDev</span><span class="c-Singleline"></span>
<span class="c-Singleline">    ;Check if we just want the count</span>
<span class="w">    </span><span class="nb">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">UsagePage</span> <span class="o">=</span> <span class="s">&quot;Count&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="n">iCount</span><span class="c-Singleline"></span>
<span class="c-Singleline">    ;Check if we&#39;re dimensioning the struct</span>
<span class="w">    </span><span class="nb">Else</span> <span class="n">If</span> <span class="n">UsagePage</span> <span class="n">And</span> <span class="n">Not</span> <span class="p">(</span><span class="n">Usage</span> <span class="n">Or</span> <span class="n">Handle</span> <span class="n">Or</span> <span class="n">Flags</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">iCount</span> <span class="o">:=</span> <span class="n">UsagePage</span>
        <span class="n">iIndex</span> <span class="o">:=</span> <span class="mi">0</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uDev</span><span class="p">,</span> <span class="n">iCount</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">&amp;</span><span class="n">uDev</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if there&#39;s space before adding data to struct</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">=</span> <span class="n">iCount</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline">    ;Full capacity</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if hwnd needs to be null. RIDEV_REMOVE, RIDEV_EXCLUDE</span>
    <span class="n">Handle</span> <span class="o">:=</span> <span class="p">((</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">)</span> <span class="n">Or</span> <span class="p">(</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x00000010</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">Handle</span><span class="c-Singleline"></span>

<span class="c-Singleline">    ;Put in struct</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="n">UsagePage</span><span class="p">,</span> <span class="n">uDev</span><span class="p">,</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="n">Usage</span><span class="p">,</span>     <span class="n">uDev</span><span class="p">,</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="n">Flags</span><span class="p">,</span>     <span class="n">uDev</span><span class="p">,</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="n">Handle</span><span class="p">,</span>    <span class="n">uDev</span><span class="p">,</span> <span class="p">(</span><span class="n">iIndex</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Move to next slot</span>
    <span class="n">iIndex</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">Return</span> <span class="o">&amp;</span><span class="n">uDev</span>
<span class="p">}</span>

<span class="n">AHKHID_Register</span><span class="p">(</span><span class="n">UsagePage</span> <span class="o">=</span> <span class="nv">False</span><span class="p">,</span> <span class="n">Usage</span> <span class="o">=</span> <span class="nv">False</span><span class="p">,</span> <span class="n">Handle</span> <span class="o">=</span> <span class="nv">False</span><span class="p">,</span> <span class="n">Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if we&#39;re using the AddRegister array or only a single struct</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="p">(</span><span class="n">UsagePage</span> <span class="n">Or</span> <span class="n">Usage</span> <span class="n">Or</span> <span class="n">Handle</span> <span class="n">Or</span> <span class="n">Flags</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Call</span>
        <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;RegisterRawInputDevices&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">AHKHID_AddRegister</span><span class="p">(),</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">AHKHID_AddRegister</span><span class="p">(</span><span class="s">&quot;Count&quot;</span><span class="p">),</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check for error</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">r</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">RegisterRawInputDevices</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">    ;Build struct and call</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Prep var</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uDev</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if hwnd needs to be null. RIDEV_REMOVE, RIDEV_EXCLUDE</span>
        <span class="n">Handle</span> <span class="o">:=</span> <span class="p">((</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">)</span> <span class="n">Or</span> <span class="p">(</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="mh">0x00000010</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">Handle</span>
        
        <span class="nf">NumPut</span><span class="p">(</span><span class="n">UsagePage</span><span class="p">,</span> <span class="n">uDev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="n">Usage</span><span class="p">,</span>     <span class="n">uDev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="n">Flags</span><span class="p">,</span>     <span class="n">uDev</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="n">Handle</span><span class="p">,</span>    <span class="n">uDev</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Call</span>
        <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;RegisterRawInputDevices&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uDev</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check for error</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">r</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">RegisterRawInputDevices</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">Return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="n">AHKHID_GetRegisteredDevs</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">uDev</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get length</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">iCount</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRegisteredRawInputDevices&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iCount</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="w">    </span><span class="nb">If </span><span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRegisteredRawInputDevices</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>
    
    <span class="n">If</span> <span class="p">(</span><span class="n">iCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Prep var</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uDev</span><span class="p">,</span> <span class="n">iCount</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Call</span>
        <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRegisteredRawInputDevices&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uDev</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iCount</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRegisteredRawInputDevices</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">Return</span> <span class="n">iCount</span>
<span class="p">}</span>

<span class="n">AHKHID_GetInputInfo</span><span class="p">(</span><span class="n">InputHandle</span><span class="p">,</span> <span class="n">Flag</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">uRawInput</span><span class="p">,</span> <span class="n">iLastHandle</span> <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if it&#39;s the same handle</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">InputHandle</span> <span class="o">=</span> <span class="n">iLastHandle</span><span class="p">)</span><span class="c-Singleline"> ;We can retrieve the data without having to call again</span>
<span class="w">        </span><span class="nb">Return</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">uRawInput</span><span class="p">,</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">AHKHID_NumIsShort</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">AHKHID_NumIsSigned</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Short&quot;</span> <span class="o">:</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">AHKHID_NumIsSigned</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Int&quot;</span> <span class="o">:</span> <span class="s">&quot;UInt&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="nb">Else</span> <span class="p">{</span><span class="c-Singleline">    ;We need to get a fresh copy</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Get raw data size                                           RID_INPUT</span>
        <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputData&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">InputHandle</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x10000003</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iSize</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputData</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Prep var</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uRawInput</span><span class="p">,</span> <span class="n">iSize</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Get raw data                                                RID_INPUT</span>
        <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputData&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">InputHandle</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x10000003</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uRawInput</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iSize</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputData</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&gt;</span> <span class="n">iSize</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputData</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">return</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">size</span><span class="o">.</span><span class="se">`n</span><span class="n">Size</span> <span class="n">returned</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="n">Size</span> <span class="n">allocated</span><span class="o">:</span> <span class="nv">%iSize%</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Keep handle reference of current uRawInput</span>
        <span class="n">iLastHandle</span> <span class="o">:=</span> <span class="n">InputHandle</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Retrieve data</span>
<span class="w">        </span><span class="nb">Return</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">uRawInput</span><span class="p">,</span> <span class="n">Flag</span><span class="p">,</span> <span class="n">AHKHID_NumIsShort</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">AHKHID_NumIsSigned</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Short&quot;</span> <span class="o">:</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">AHKHID_NumIsSigned</span><span class="p">(</span><span class="n">Flag</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Int&quot;</span> <span class="o">:</span> <span class="s">&quot;UInt&quot;</span><span class="p">))</span>
    <span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">Return</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="n">AHKHID_GetInputData</span><span class="p">(</span><span class="n">InputHandle</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">uData</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get raw data size                                           RID_INPUT</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputData&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">InputHandle</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x10000003</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iSize</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputData</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Prep var</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uRawInput</span><span class="p">,</span> <span class="n">iSize</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get raw data                                                RID_INPUT</span>
    <span class="n">r</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;GetRawInputData&quot;</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="n">InputHandle</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mh">0x10000003</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uRawInput</span><span class="p">,</span> <span class="s">&quot;UInt*&quot;</span><span class="p">,</span> <span class="n">iSize</span><span class="p">,</span> <span class="s">&quot;UInt&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputData</span> <span class="n">call</span> <span class="n">failed</span><span class="o">.</span><span class="se">`n</span><span class="n">Return</span> <span class="n">value</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="nv">ErrorLevel</span><span class="o">:</span> <span class="nv">%ErrorLevel%</span><span class="se">`n</span><span class="n">Line</span><span class="o">:</span> <span class="nv">%A_LineNumber%</span><span class="se">`n</span><span class="n">Last</span> <span class="n">Error</span><span class="o">:</span> <span class="nv">%A_LastError%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&gt;</span> <span class="n">iSize</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">=</span> <span class="n">GetRawInputData</span> <span class="n">did</span> <span class="ow">not</span> <span class="n">return</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">size</span><span class="o">.</span><span class="se">`n</span><span class="n">Size</span> <span class="n">returned</span><span class="o">:</span> <span class="nv">%r%</span><span class="se">`n</span><span class="n">Size</span> <span class="n">allocated</span><span class="o">:</span> <span class="nv">%iSize%</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get the size of each HID input and the number of them</span>
    <span class="n">iSize</span>   <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">uRawInput</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="c-Singleline"> ;ID_HID_SIZE</span>
    <span class="n">iCount</span>  <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">uRawInput</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="c-Singleline"> ;ID_HID_COUNT</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Allocate memory</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">uData</span><span class="p">,</span> <span class="n">iSize</span> <span class="o">*</span> <span class="n">iCount</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Copy bytes</span>
    <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;RtlMoveMemory&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uData</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uRawInput</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span> <span class="n">iSize</span> <span class="o">*</span> <span class="n">iCount</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">Return</span> <span class="p">(</span><span class="n">iSize</span> <span class="o">*</span> <span class="n">iCount</span><span class="p">)</span>
<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;Internal use only</span>
<span class="n">AHKHID_NumIsShort</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">Flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">Flag</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Flag</span> <span class="o">^=</span> <span class="mh">0x0100</span><span class="c-Singleline">    ;Remove it</span>
<span class="w">        </span><span class="nb">Return</span> <span class="nv">True</span>
    <span class="p">}</span> <span class="n">Return</span> <span class="nv">False</span>
<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;Internal use only</span>
<span class="n">AHKHID_NumIsSigned</span><span class="p">(</span><span class="n">ByRef</span> <span class="n">Flag</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">Flag</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Flag</span> <span class="o">^=</span> <span class="mh">0x1000</span><span class="c-Singleline">    ;Remove it</span>
<span class="w">        </span><span class="nb">Return</span> <span class="nv">True</span>
    <span class="p">}</span> <span class="n">Return</span> <span class="nv">False</span>
<span class="p">}</span>
</pre></div>
