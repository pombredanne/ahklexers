<LINK href="styles.css" rel="stylesheet" type="text/css">

New Lexer: 
<div class="highlight"><pre><span class="c-Singleline">;Title: TreeViewX</span>
<span class="c-Singleline">;		TreeViewX  extends standard TreeView control to support moving, deleting &amp; inserting.</span>

<span class="c-Singleline">;----------------------------------------------------------------------------------------</span>
<span class="c-Singleline">; Function: TVX</span>
<span class="c-Singleline">;			Initialisation function. Mandatory to call before you show the TreeView.</span>
<span class="c-Singleline">; </span>
<span class="c-Singleline">; Parameters:</span>
<span class="c-Singleline">;			pTree		- AHK name of the TreeView control</span>
<span class="c-Singleline">;			pSub		- Subroutine for TreeViewX, the same rules as in g.</span>
<span class="c-Singleline">;			pOptions	- String containing space delimited options for setting up TreeViewX</span>
<span class="c-Singleline">;			pUserData	- Base name of the array holding user data. </span>
<span class="c-Singleline">;						  This array is indexed using tree view item handles.</span>
<span class="c-Singleline">;			</span>
<span class="c-Singleline">; Options: </span>
<span class="c-Singleline">;			HasRoot		- TreeViewX has root item - the one containing all other items. </span>
<span class="c-Singleline">;						  Root item can&#39;t be moved, edited or delited, and items can not</span>
<span class="c-Singleline">;						  be moved or created outside of it. This option need to be set </span>
<span class="c-Singleline">;						  after root is already added to the menu, as TreeViewX need to</span>
<span class="c-Singleline">;						  know the root menu handle.</span>
<span class="c-Singleline">;						  </span>
<span class="c-Singleline">;		CollapseOnMove	- When moving item out of of its container, this option makes container collapse</span>
<span class="c-Singleline">;		EditOnInsert	- Automaticaly enters edit mode upon insertion of new item</span>
<span class="c-Singleline">;</span>
<span class="c-Singleline">; Example:</span>
<span class="c-Singleline">;&gt;</span>
<span class="c-Singleline">;&gt;	 	TVX(&quot;MyTree&quot;, &quot;Handler&quot;, &quot;HasRoot CollapseOnMove&quot;)</span>
<span class="c-Singleline">;&gt;</span>
<span class="n">TVX</span><span class="p">(</span> <span class="n">pTree</span><span class="p">,</span> <span class="n">pSub</span><span class="p">,</span> <span class="n">pOptions</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pUserData</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">)</span> <span class="p">{</span><span class="nf"></span>
<span class="nf">	global</span>

<span class="nf">	if InStr</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="s">&quot;HasRoot&quot;</span><span class="p">)</span>	<span class="p">{</span>
<span class="w">		</span><span class="n">TVX_HasRoot</span><span class="p"> </span><span class="w"> </span><span class="o">:=</span> <span class="mi">1</span>
<span class="w">		</span><span class="n">TVX_root</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetNext</span><span class="p">()</span>
	<span class="p">}</span><span class="nf"></span>
<span class="nf">	</span>
<span class="nf">	if InStr</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="s">&quot;CollapseOnMove&quot;</span><span class="p">)</span>
<span class="w">	  	</span><span class="n">TVX_CollapseOnMove</span><span class="p"> </span><span class="o">:=</span> <span class="mi">1</span><span class="nf"></span>

<span class="nf">	if InStr</span><span class="p">(</span><span class="n">pOptions</span><span class="p">,</span> <span class="s">&quot;EditOnInsert&quot;</span><span class="p">)</span>
<span class="w">		</span><span class="n">TVX_EditOnInsert</span><span class="p">	</span><span class="o">:=</span> 	<span class="mi">1</span><span class="w"></span>

<span class="w">	</span><span class="n">TVX_userData</span><span class="p"> </span><span class="o">:=</span> <span class="n">pUserData</span>
<span class="w">	</span><span class="n">TVX_sub</span><span class="p"> </span><span class="o">:=</span> <span class="n">pSub</span>
<span class="w">	</span><span class="nb">GuiControl</span><span class="p">,</span><span class="s"> +AltSubmit -ReadOnly +gTVX_OnEvent</span><span class="p">,</span><span class="s"> %pTree%</span><span class="w"></span>

<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;----------------------------------------------------------------------------------------</span>
<span class="c-Singleline">; Function: Walk</span>
<span class="c-Singleline">;			Walk the menu and rise events</span>
<span class="c-Singleline">; </span>
<span class="c-Singleline">; Parameters:</span>
<span class="c-Singleline">;			root		- menu to iterate, can be simple item also</span>
<span class="c-Singleline">;			label		- event handler</span>
<span class="c-Singleline">;			event_type	- event argument 1 - Event type</span>
<span class="c-Singleline">;			event_param	- event argument 2 - Item upon which event is rised</span>
<span class="c-Singleline">;			</span>
<span class="c-Singleline">;</span>
<span class="c-Singleline">;				   Type						  Param</span>
<span class="c-Singleline">;</span>
<span class="c-Singleline">;			+  - Iteration start,			root handle</span>
<span class="c-Singleline">;			M  - Menu item,					menu handle </span>
<span class="c-Singleline">;			I  - Item,						item handle</span>
<span class="c-Singleline">;			E  - End of menu				menu handle			(pseudo item)</span>
<span class="c-Singleline">;			-  - Iteration end				root handle			(pseudo item)</span>
<span class="c-Singleline">;</span>
<span class="n">TVX_Walk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">event_param</span><span class="p">){</span><span class="nf"></span>
<span class="nf">	local</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>	<span class="n">pref</span><span class="p">,</span> <span class="n">bSetEnd</span><span class="p">,</span> <span class="n">lastParent</span><span class="p">,</span> <span class="n">rootsParent</span><span class="p">,</span> <span class="n">tmp</span><span class="c-Singleline"></span>

<span class="c-Singleline">	; start event for menus</span>
<span class="w">	</span><span class="n">event_type</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;+&quot;</span>
<span class="w">	</span><span class="n">event_param</span><span class="p"> </span><span class="o">:=</span> <span class="n">root</span>
<span class="w">	</span><span class="nb">GoSub</span><span class="w"> </span><span class="nv">%label%</span><span class="w"></span>

<span class="w">		</span><span class="n">if</span><span class="p"> </span><span class="o">!</span><span class="nf">TV_GetChild</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		return</span><span class="c-Singleline"></span>
<span class="c-Singleline">	</span>
<span class="c-Singleline">	; this will be exit condition. If we come to roots parent, stop walking.</span>
<span class="w">	</span><span class="n">rootsParent</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"></span>
<span class="w">	</span>
<span class="w">	</span><span class="n">lastParent</span><span class="p"> </span><span class="o">:=</span> <span class="n">root</span>
<span class="w">	</span><span class="n">c</span><span class="p"> </span><span class="o">:=</span> <span class="n">root</span>
<span class="w">	</span><span class="nb">loop</span><span class="w"> </span><span class="s">{</span><span class="w"></span>
<span class="w">		</span>	<span class="n">c</span> <span class="o">:=</span><span class="nf"> TV_GetNext</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;Full&quot;</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		TV_GetText</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span><span class="c-Singleline"></span>

<span class="c-Singleline">		; Check if this item is submenu. If so, set the lastParent</span>
<span class="w">		</span><span class="n">if</span><span class="p"> (</span><span class="nf"> TV_GetChild</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">){</span><span class="w">	</span>
<span class="w">			</span><span class="n">lastParent</span><span class="p"> </span><span class="o">:=</span> <span class="n">c</span>
<span class="w">			</span><span class="n">event_type</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;M&quot;</span>
		<span class="p">}</span>
<span class="w">		</span><span class="nb">else</span><span class="w"> </span><span class="s">event_type := &quot;I&quot;			</span><span class="c-Singleline">; not a submenu, it is normal item</span><span class="w"></span>

<span class="w">		</span>	<span class="n">event_param</span> <span class="o">:=</span> <span class="n">c</span>
<span class="w">		</span><span class="nb">GoSub</span><span class="w"> </span><span class="nv">%label%</span><span class="c-Singleline">		</span>
<span class="c-Singleline">	</span>

<span class="c-Singleline">		; Check if c is the last item in the current submenu</span><span class="w"></span>
<span class="w">		</span><span class="c-Singleline">	; Do so by taking the next item and checking its parent.</span>
<span class="c-Singleline">		; If the parent is different then &quot;lastParent&quot; current item is </span>
<span class="c-Singleline">		;  at the end of the its submenu. </span>
<span class="w">		</span><span class="n">n</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetNext</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;FULL&quot;</span><span class="p">)</span>
<span class="w">		</span><span class="n">if</span><span class="p"> (</span><span class="n">n</span><span class="p">)</span>
		<span class="p">{</span>
<span class="w">			</span><span class="n">p</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="w">			</span><span class="n">if</span><span class="p"> (</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">lastParent</span><span class="p">){</span><span class="w">	</span>
<span class="w">				</span><span class="n">t</span><span class="p"> </span><span class="o">:=</span> <span class="n">lastParent</span>
<span class="w">				</span><span class="n">lastParent</span><span class="p"> </span><span class="o">:=</span> <span class="n">p</span>
			<span class="p">}</span>
<span class="w">			</span><span class="nb">else</span><span class="w"> </span><span class="s">continue</span><span class="w"></span>

<span class="w">			</span><span class="c-Singleline">	; It is the last child</span>
<span class="w">			</span><span class="nb">Loop</span><span class="w"> </span><span class="s">{	</span><span class="c-Singleline">; rise &quot;E&quot; (end of menu) event </span><span class="w"></span>
<span class="w">				</span>	<span class="n">event_type</span> <span class="o">:=</span> <span class="s">&quot;E&quot;</span>
<span class="w">				</span><span class="n">event_param</span><span class="p"> </span><span class="o">:=</span> <span class="n">t</span>
<span class="w">				</span><span class="nb">GoSub</span><span class="w"> </span><span class="nv">%label%</span><span class="w"></span>

<span class="w">				</span>	<span class="n">t</span> <span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="w">				</span><span class="n">if</span><span class="p"> (</span><span class="n">t</span> <span class="o">=</span> <span class="n">rootsParent</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline">	; rise &quot;-&quot; (end of walk) event</span>
<span class="w">					</span><span class="n">event_type</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;-&quot;</span>
<span class="w">					</span><span class="n">event_param</span><span class="p"> </span><span class="o">:=</span> <span class="n">t</span>
<span class="w">					</span><span class="nb">GoSub</span><span class="w"> </span><span class="nv">%label%</span><span class="w"></span>
<span class="w">					</span><span class="nf">	return</span>
				<span class="p">}</span>
<span class="w">				</span><span class="n">if</span><span class="p"> (</span><span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="p">)</span>
<span class="w">					</span><span class="nb">break</span><span class="w"></span>
<span class="w">			</span>	<span class="p">}</span><span class="w"></span>

		<span class="p">}</span> <span class="n">else</span><span class="w"> </span>
<span class="w">			</span><span class="nb">Loop</span><span class="w"> </span><span class="s">{</span><span class="w"></span>
<span class="w">				 </span><span class="c-Singleline"> ;this is the end of the complite menu, so close all open submenus, if any</span>
<span class="w">				 </span><span class="n">if</span><span class="p"> (</span><span class="n">lastParent</span> <span class="o">=</span> <span class="n">root</span><span class="p">)</span>	 <span class="p">{</span>
<span class="w">					</span><span class="n">event_type</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;-&quot;</span><span class="w"> </span>
<span class="w">					</span><span class="n">event_param</span><span class="p"> </span><span class="o">:=</span> <span class="n">root</span>
<span class="w">					</span><span class="nb">GoSub</span><span class="w"> </span><span class="nv">%label%</span><span class="w"></span>
<span class="w">					</span><span class="nf">	return</span>
				 <span class="p">}</span><span class="w"></span>
<span class="w">				</span>
<span class="w">				 </span><span class="n">event_type</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;E&quot;</span>
<span class="w">				 </span><span class="n">event_param</span><span class="p"> </span><span class="o">:=</span> <span class="n">lastParent</span>
<span class="w">				 </span><span class="nb">GoSub</span><span class="w"> </span><span class="nv">%label%</span><span class="w"></span>
<span class="w">				 </span> <span class="n">lastParent</span> <span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">lastParent</span><span class="p">)</span>
			<span class="p">}</span><span class="w">	</span>
	<span class="p">}</span>
<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;----------------------------------------------------------------------------------------------</span>
<span class="c-Singleline">; Function:		Move</span>
<span class="c-Singleline">;				Moves tree view item up or down</span>
<span class="c-Singleline">;</span>
<span class="c-Singleline">; Parameters:</span>
<span class="c-Singleline">;				item		-	Handle of the item to move</span>
<span class="c-Singleline">;				direction	-   &quot;u&quot; or &quot;d&quot; (Up &amp; Down)</span>
<span class="c-Singleline">;</span>
<span class="c-Singleline">; Returns:</span>
<span class="c-Singleline">;				Handle of the item</span>
<span class="c-Singleline">;</span>
<span class="c-Singleline">; Remarks:</span>
<span class="c-Singleline">;				Item to be moved is copied to the new place then source item is deleted. This</span>
<span class="c-Singleline">;				creates new handle for the moved item. New handle will be returned by the function.</span>
<span class="c-Singleline">;</span>
<span class="n">TVX_Move</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">direction</span><span class="p">){</span><span class="nf"></span>
<span class="nf">	local</span> <span class="n">newc</span><span class="p">,</span> <span class="n">newp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="w"></span>

<span class="w">	</span><span class="n">p</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetPrev</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="w">	</span><span class="n">n</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetNext</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="w"></span>

<span class="w">	</span><span class="n">if</span><span class="p"> (</span><span class="n">TVX_HasRoot</span><span class="p">)</span>
	<span class="p">{</span>
<span class="w">		 </span><span class="n">if</span><span class="p">	</span><span class="s">TV_GetNext()=item</span><span class="w"></span>
<span class="w">			</span><span class="nf">	return</span><span class="w"></span>

<span class="w">		 </span><span class="n">if</span><span class="p"> (</span><span class="n">direction</span><span class="o">=</span><span class="s">&quot;u&quot;</span><span class="p">)</span>
		 <span class="p">{</span>
<span class="w">			 </span><span class="n">if</span><span class="p"> (</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">=</span><span class="nf">TV_GetNext</span><span class="p">())</span><span class="c-Singleline">			;don&#39;t let item go above root</span>
			 <span class="p">{</span><span class="nf"></span>
<span class="nf">				TV_Modify</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="w">				</span><span class="nl">TVX_sel:</span><span class="o">=</span><span class="n">item</span><span class="nf"></span>
<span class="nf">				return</span>
			 <span class="p">}</span>
		 <span class="p">}</span>
	 <span class="p">}</span><span class="c-Singleline"></span>


<span class="c-Singleline">	; Do so by coping an item bellow calculated item and deleting the old one.</span>
<span class="c-Singleline">	; Return handle of new item</span>
<span class="c-Singleline"> 	</span>
<span class="c-Singleline">	; newc - calculated child after which &quot;item&quot; should be created. </span>
<span class="c-Singleline">	; newp -  ... and its parent</span>

<span class="c-Singleline">	; if moving down</span>
<span class="w">	</span><span class="n">if</span><span class="p"> (</span><span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;d&quot;</span><span class="p">)</span>
	<span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">		; handle end of submenu</span>
<span class="w">		</span><span class="n">if</span><span class="p"> </span><span class="o">!</span><span class="n">n</span>
		<span class="p">{</span>
<span class="w">			</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="c-Singleline"></span>

<span class="c-Singleline">			; check the end of the entire list</span>
<span class="w">			</span><span class="n">if</span><span class="p"> (</span><span class="n">TVX_HasRoot</span> <span class="o">&amp;&amp;</span> <span class="n">newc</span> <span class="o">=</span> <span class="n">TVX_root</span><span class="p">)</span><span class="nf"></span>
<span class="nf">				return</span>

<span class="nf">			if </span><span class="n">TVX_CollapseOnMove</span><span class="nf"></span>
<span class="nf">				TV_Modify</span><span class="p">(</span><span class="n">newc</span><span class="p">,</span> <span class="s">&quot;-Expand&quot;</span><span class="p">)</span><span class="w"></span>

<span class="w">			</span><span class="n">newp</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">newc</span><span class="p">)</span>
		<span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">		; somewhere in the middle </span>
<span class="w">		</span><span class="nb">else</span><span class="w"> </span>
<span class="w">		</span><span class="s">{</span><span class="w"></span>
<span class="w">   			</span><span class="c-Singleline">	; if submenu, go into it</span>
<span class="w">			</span><span class="n">t</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_Get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">)</span>
<span class="w">			</span><span class="n">if</span><span class="p"> (</span><span class="n">t</span> <span class="o">=</span> <span class="n">n</span><span class="p">)</span>
			<span class="p">{</span>
<span class="w">				</span><span class="n">newp</span><span class="p"> </span><span class="o">:=</span> <span class="n">n</span>
<span class="w">				</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;First&quot;</span>
			<span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">			; not a submenu</span>
<span class="w">			</span><span class="nb">else</span><span class="w"></span>
<span class="w">			</span>	<span class="p">{</span>
<span class="w">				</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span> <span class="n">n</span>
<span class="w">				</span><span class="n">newp</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
			<span class="p">}</span><span class="w">    </span>
		<span class="p">}</span>
	<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">	; if moving up</span>
<span class="w">	</span><span class="n">if</span><span class="p"> (</span><span class="n">direction</span> <span class="o">=</span> <span class="s">&quot;u&quot;</span><span class="p">)</span>
	<span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">		;going up - handle start of the submenu</span>
<span class="w">		</span><span class="n">if</span><span class="p"> </span><span class="o">!</span><span class="n">p</span>
		<span class="p">{</span>
<span class="w">			</span><span class="n">t</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="nf"></span>
<span class="nf">			if </span><span class="n">TVX_CollapseOnMove</span><span class="nf"></span>
<span class="nf">				TV_Modify</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;-Expand&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">																					  </span>
<span class="w">			</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetPrev</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">																											  </span>
<span class="c-Singleline">			; handle start of the menu again</span>
<span class="w">			</span><span class="n">if</span><span class="p"> </span><span class="o">!</span><span class="n">newc</span>
			<span class="p">{</span>
<span class="w">				</span><span class="n">newp</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="w">				</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;First&quot;</span>
			<span class="p">}</span>
<span class="w">			</span><span class="nb">else</span><span class="w"></span>
<span class="w">				</span>	<span class="n">newp</span> <span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">newc</span><span class="p">)</span>
		<span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">		; somewhere in the middle</span>
<span class="w">		</span><span class="nb">else</span><span class="w"></span>
<span class="w">		</span>	<span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">   			; if submenu is expanded, go into it</span>
<span class="w">			</span><span class="n">t</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_Get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">)</span>
<span class="w">			</span><span class="n">if</span><span class="p"> (</span><span class="n">t</span> <span class="o">=</span> <span class="n">p</span><span class="p">)</span>
			<span class="p">{</span>
<span class="w">				</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;First&quot;</span>
<span class="w">				</span><span class="n">newp</span><span class="p"> </span><span class="o">:=</span> <span class="n">t</span>
			<span class="p">}</span>
<span class="w">			</span><span class="nb">else</span><span class="w"></span>
<span class="w">			</span>	<span class="p">{</span>
<span class="w">				</span><span class="n">t</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetPrev</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">				;check the top of the list</span>
<span class="w">				</span><span class="n">if</span><span class="p"> </span><span class="o">!</span><span class="n">t</span>
				<span class="p">{</span>
<span class="w">					</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span> <span class="s">&quot;First&quot;</span>
<span class="w">					</span><span class="n">newp</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w">				</span>
				<span class="p">}</span>
<span class="w">				</span><span class="nb">else</span><span class="w"> </span>
<span class="w">				</span><span class="s">{</span><span class="w"></span>
<span class="w">					</span>	<span class="n">newc</span> <span class="o">:=</span> <span class="n">t</span>
<span class="w">					</span><span class="n">newp</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">newc</span><span class="p">)</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="w"></span>

<span class="w">	</span><span class="n">newc</span><span class="p"> </span><span class="o">:=</span> <span class="n">TVX_CopyItem</span><span class="p">(</span><span class="n">newc</span><span class="p">,</span> <span class="n">newp</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span><span class="nf"></span>
<span class="nf">	TV_Delete</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="nf"></span>
<span class="nf">	return</span> <span class="n">newc</span>
<span class="p">}</span><span class="c-Singleline"></span>


<span class="c-Singleline">;---------------------------------------------------------------------------------------------</span>
<span class="c-Singleline">; TVX_Walk event handler wrapped in the function</span>
<span class="c-Singleline">;	</span>
<span class="c-Singleline">; Function that copies menu item to the destination item. </span>
<span class="c-Singleline">; Handle of destination item is specified in the global variable TVX_copyDest.</span>
<span class="c-Singleline">; </span>
<span class="n">TVX_CopyProc</span><span class="p">(</span><span class="n">iType</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span><span class="nf"></span>
<span class="nf">	local</span> <span class="n">c</span><span class="p">,</span> <span class="n">txt</span><span class="nf"></span>
<span class="nf">	static</span> <span class="n">lastParent</span><span class="nf"></span>
<span class="nf">	</span>
<span class="nf">	TV_GetText</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span><span class="nf"></span>
<span class="nf">	if </span><span class="n">iType</span> <span class="ow">in</span> <span class="o">+</span>
	<span class="p">{</span>
<span class="w">		</span><span class="n">lastParent</span><span class="p"> </span><span class="o">:=</span> <span class="n">TVX_copyDest</span><span class="nf"></span>
<span class="nf">		TV_Modify</span><span class="p">(</span><span class="n">TVX_copyDest</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		</span>
<span class="nf">		if </span><span class="n">TVX_userData</span>
		<span class="p">{</span>
			<span class="nv">%TVX_userData%%TVX_copyDest%</span> <span class="o">:=</span> <span class="nv">%TVX_userData%%item%</span>
			<span class="nv">%TVX_userData%%item%</span> <span class="o">:=</span> <span class="s">&quot;&quot;</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="nf"></span>

<span class="nf">	if </span><span class="n">iType</span> <span class="ow">in</span> <span class="n">I</span><span class="p">,</span><span class="n">M</span>
	<span class="p">{</span>
<span class="w">		</span><span class="n">c</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_Add</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">lastParent</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		if </span><span class="n">iType</span> <span class="o">=</span> <span class="n">M</span>
<span class="w">			</span><span class="n">lastParent</span><span class="p"> </span><span class="o">:=</span> <span class="n">c</span><span class="nf"></span>

<span class="nf">		if </span><span class="n">TVX_userData</span>
		<span class="p">{</span>
			<span class="nv">%TVX_userData%%c%</span> <span class="o">:=</span> <span class="nv">%TVX_userData%%item%</span>
			<span class="nv">%TVX_userData%%item%</span> <span class="o">:=</span> <span class="s">&quot;&quot;</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="nf"></span>

<span class="nf">	if </span><span class="n">iType</span> <span class="o">=</span> <span class="n">E</span>
<span class="w">		</span><span class="n">lastParent</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">lastParent</span><span class="p">)</span><span class="w">	</span>
<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;----------------------------------------------</span><span class="w"></span>

<span class="nl">_TVX_CopyProc:</span>
	<span class="n">TVX_CopyProc</span><span class="p">(</span><span class="n">TVX_itemType</span><span class="p">,</span> <span class="n">TVX_param</span><span class="p">)</span><span class="nf"></span>
<span class="nf">return</span><span class="c-Singleline"></span>

<span class="c-Singleline">;-----------------------------------------------------------------------------------------------</span>
<span class="c-Singleline">; Create new item after the child &quot;destc&quot; with parent &quot;destp&quot; and copy the &quot;source&quot; item into it</span>
<span class="c-Singleline">;</span>
<span class="n">TVX_CopyItem</span><span class="p">(</span><span class="n">destc</span><span class="p">,</span> <span class="n">destp</span><span class="p">,</span> <span class="n">source</span><span class="p">){</span><span class="nf"></span>
<span class="nf">	global</span><span class="c-Singleline"> </span>

<span class="c-Singleline">	;create the holder and call the copy function</span>
<span class="w">	</span><span class="n">TVX_copyDest</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_Add</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">destp</span> <span class="p">,</span> <span class="n">destc</span> <span class="p">)</span>
	<span class="n">TVX_Walk</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;_TVX_CopyProc&quot;</span><span class="p">,</span> <span class="n">TVX_itemType</span><span class="p">,</span> <span class="n">TVX_param</span><span class="p">)</span><span class="nf"></span>

<span class="nf">	return</span> <span class="n">TVX_copyDest</span>
<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;----------------------------------------------------------------------------------------------</span>
<span class="c-Singleline">; Used to control moving</span>
<span class="c-Singleline">;</span>
<span class="n">TVX_OnItemSelect</span><span class="p">(</span><span class="n">pItemId</span><span class="p">){</span><span class="nf"></span>
<span class="nf">	global</span><span class="w"></span>

<span class="w">	</span><span class="n">if</span><span class="p"> (</span><span class="n">TVX_bSelfSelect</span><span class="p">)</span>	<span class="p">{</span><span class="w">	</span>
<span class="w">		</span><span class="n">TVX_bSelfSelect</span><span class="p"> </span><span class="o">:=</span> <span class="nv">false</span><span class="nf"></span>
<span class="nf">		return</span> <span class="nv">true</span>
	<span class="p">}</span><span class="w">	</span>

<span class="w">	</span><span class="n">TVX_prevSel</span><span class="p"> </span><span class="o">:=</span> <span class="n">TVX_sel</span>
<span class="w">	</span><span class="n">TVX_sel</span><span class="p"> </span><span class="o">:=</span> <span class="n">pItemId</span><span class="nf"></span>

<span class="nf">	if GetKeyState</span><span class="p">(</span><span class="s">&quot;Shift&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">TVX_lastKey</span><span class="o">=</span><span class="mi">38</span> <span class="o">||</span> <span class="n">TVX_lastKey</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="w">	 </span><span class="n">if</span><span class="p"> (</span><span class="n">pItemId</span> <span class="o">!=</span> <span class="n">TVX_root</span><span class="p">)</span>
	 <span class="p">{</span>
<span class="w">	  	</span><span class="n">TVX_sel</span><span class="p"> </span><span class="o">:=</span> <span class="n">TVX_Move</span><span class="p">(</span> <span class="n">TVX_prevSel</span><span class="p">,</span> <span class="n">TVX_lastKey</span><span class="o">=</span><span class="mi">40</span> <span class="o">?</span> <span class="s">&quot;d&quot;</span> <span class="o">:</span> <span class="s">&quot;u&quot;</span><span class="p">)</span>
<span class="w">		</span><span class="n">TVX_prevSel</span><span class="p"> </span><span class="o">:=</span> <span class="n">pItemId</span><span class="w"></span>

<span class="w">		</span>
<span class="w">		</span><span class="n">TVX_bSelfSelect</span><span class="p"> </span><span class="o">:=</span> <span class="nv">true</span><span class="nf"></span>
<span class="nf">		TV_Modify</span><span class="p">(</span><span class="n">TVX_sel</span><span class="p">,</span> <span class="s">&quot;Select Bold&quot;</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		return</span> <span class="nv">true</span>
	 <span class="p">}</span><span class="nf"></span>

<span class="nf">	 return</span> <span class="nv">false</span>
<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;----------------------------------------------------------------------------------------------</span><span class="w"></span>

<span class="n">TVX_OnKeyPress</span><span class="p">(</span><span class="n">pKey</span><span class="p">){</span><span class="nf"></span>
<span class="nf">	local</span> <span class="n">tp</span><span class="p">,</span> <span class="n">sel</span><span class="w"></span>

<span class="w">	</span><span class="n">TVX_lastKey</span><span class="p"> </span><span class="o">:=</span> <span class="n">pKey</span><span class="w"></span>

<span class="w">	</span><span class="n">if</span><span class="p"> (</span><span class="n">TVX_bSelfPress</span><span class="p">)</span>	<span class="p">{</span><span class="w">	</span>
<span class="w">		</span><span class="n">TVX_bSelfPress</span><span class="p"> </span><span class="o">:=</span> <span class="nv">false</span><span class="nf"></span>
<span class="nf">		return</span> <span class="nv">true</span>
	<span class="p">}</span><span class="c-Singleline">	</span>

<span class="c-Singleline">	;delete</span><span class="nf"></span>
<span class="nf">	if </span><span class="n">pKey</span> <span class="o">=</span> <span class="mi">46</span>
	<span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">		; use GetSelection instead Editor_sel since if key is pressed and hold</span>
<span class="c-Singleline">		; TVX_OnSelect handler may not be called before delete to set the TVX_sel</span><span class="w"></span>

<span class="w">		</span><span class="n">sel</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetSelection</span><span class="p">()</span>
<span class="w">		</span><span class="n">if</span><span class="p"> (</span><span class="n">TVX_HasRoot</span> <span class="o">&amp;&amp;</span> <span class="n">sel</span> <span class="o">=</span> <span class="n">TVX_root</span><span class="p">)</span><span class="nf"></span>
<span class="nf">			return</span> <span class="nv">false</span><span class="c-Singleline"></span>

<span class="c-Singleline">		; is shift delete is pressed return - some problems with this combination</span>
<span class="w">		</span><span class="n">if</span><span class="p"> (</span><span class="nf">GetKeyState</span><span class="p">(</span><span class="s">&quot;Shift&quot;</span><span class="p">))</span><span class="nf"></span>
<span class="nf">			return</span> <span class="nv">false</span><span class="nf"></span>

<span class="nf">		TV_Delete</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		return</span> <span class="nv">true</span>
	<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">	;insert</span><span class="nf"></span>
<span class="nf">	if </span><span class="n">pKey</span> <span class="o">=</span> <span class="mi">45</span>
	<span class="p">{</span>
<span class="w">		</span><span class="n">tp</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_GetParent</span><span class="p">(</span><span class="n">TVX_sel</span><span class="p">)</span>
<span class="w">		</span><span class="n">if</span><span class="p"> (</span><span class="n">TVX_sel</span> <span class="o">=</span> <span class="n">TVX_root</span><span class="p">)</span>
<span class="w">			</span><span class="n">tp</span><span class="p"> </span><span class="o">:=</span> <span class="n">TVX_root</span><span class="w"></span>

<span class="w">		</span><span class="n">tp</span><span class="p"> </span><span class="o">:=</span><span class="nf"> TV_Add</span><span class="p">(</span><span class="s">&quot;__ new item __&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="s">&quot;Bold &quot;</span> <span class="o">.</span> <span class="n">TVX_sel</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		if GetKeyState</span><span class="p">(</span><span class="s">&quot;Shift&quot;</span><span class="p">)</span>
		<span class="p">{</span><span class="nf"></span>
<span class="nf">			TV_Add</span><span class="p">(</span><span class="s">&quot;__ new item __&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="s">&quot;Bold First &quot;</span><span class="p">)</span><span class="nf"></span>
<span class="nf">			TV_Modify</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span><span class="s">&quot;Expand&quot;</span><span class="p">,</span> <span class="s">&quot;__ new group __&quot;</span><span class="p">)</span>
		<span class="p">}</span><span class="w"></span>

<span class="w">		</span><span class="n">if</span><span class="p"> (</span><span class="n">TVX_EditOnInsert</span><span class="p">)</span>
		<span class="p">{</span>
<span class="w">			</span><span class="n">TVX_bSelfPress</span><span class="p"> </span><span class="o">:=</span> <span class="n">TVX_bSelfSelect</span> <span class="o">:=</span> <span class="nv">true</span><span class="nf"></span>
<span class="nf">			TV_Modify</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="s">&quot;Select&quot;</span><span class="p">)</span>
<span class="w">			</span><span class="nb">Send</span><span class="p">,</span><span class="s"> {F2}</span><span class="w"></span>
<span class="w">		</span>	<span class="p">}</span><span class="nf"></span>

<span class="nf">		return</span> <span class="nv">true</span>
	<span class="p">}</span><span class="nf"></span>

<span class="nf">	return</span> <span class="nv">false</span>
<span class="p">}</span><span class="c-Singleline"></span>

<span class="c-Singleline">;----------------------------------------------------------------------------------------------</span>
<span class="c-Singleline">; g soubroutine for Tree View</span>
<span class="c-Singleline">;</span>
<span class="nl">TVX_OnEvent:</span>
<span class="w">	</span><span class="n">if</span><span class="p"> (</span><span class="nv">A_GuiEvent</span><span class="o">=</span><span class="s">&quot;S&quot;</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		if </span><span class="n">TVX_OnItemSelect</span><span class="p">(</span><span class="nv">A_EventInfo</span><span class="p">)</span><span class="nf"></span>
<span class="nf">			return</span><span class="w"></span>

<span class="w">	</span><span class="n">if</span><span class="p"> (</span><span class="nv">A_GuiEvent</span><span class="o">=</span><span class="s">&quot;K&quot;</span><span class="p">)</span><span class="nf"></span>
<span class="nf">		if </span><span class="n">TVX_OnKeyPress</span><span class="p">(</span><span class="nv">A_EventInfo</span><span class="p">)</span><span class="nf"></span>
<span class="nf">			return</span><span class="c-Singleline"></span>
<span class="c-Singleline">	</span>
<span class="c-Singleline">	;if not the Xtended property send event to the caller</span>
<span class="w">	</span><span class="nb">gosub</span><span class="w"> </span><span class="nv">%TVX_sub%</span><span class="w"></span>

<span class="nf">return</span><span class="w"></span>
</pre></div>
