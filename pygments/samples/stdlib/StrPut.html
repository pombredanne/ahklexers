<LINK href="styles.css" rel="stylesheet" type="text/css">old lexer: 
<div class="highlight"><pre><span class="nf">StrPut</span><span class="p">(</span>String<span class="p">,</span><span class="w"> </span>Address<span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span>Length<span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>Encoding<span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="nb">A_IsUnicode</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">MsgBox</span><span class="w"> </span><span class="nv">%A_ThisFunc%</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>support<span class="w"> </span>Unicode<span class="p">.</span><span class="w"> </span>Use<span class="w"> </span>the<span class="w"> </span><span class="nf">AutoHotkey_L</span><span class="w"> </span><span class="p">(</span>revision<span class="w"> </span><span class="mi">46</span><span class="o">+</span><span class="p">)</span><span class="w"> </span>built<span class="o">-</span>in<span class="w"> </span>version<span class="w"> </span>instead<span class="p">.</span><span class="w"> </span>The<span class="w"> </span>script<span class="w"> </span>will<span class="w"> </span>now<span class="w"> </span>exit<span class="p">.</span>
<span class="w">        </span><span class="k">ExitApp</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">; Flexible parameter handling:</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span>Address<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>integer<span class="w">       </span><span class="c1">; StrPut(String [, Encoding])</span>
<span class="w">        </span>Encoding<span class="w"> </span><span class="o">:=</span><span class="w"> </span>Address<span class="p">,</span><span class="w">  </span>Length<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">  </span>Address<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1024</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span>Length<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>integer<span class="w">   </span><span class="c1">; StrPut(String, Address, Encoding)</span>
<span class="w">        </span>Encoding<span class="w"> </span><span class="o">:=</span><span class="w"> </span>Length<span class="p">,</span><span class="w">  </span>Length<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">; Check for obvious errors.</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>Address<span class="o">+</span><span class="mi">0</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1024</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">; Ensure &#39;Encoding&#39; contains a numeric identifier.</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span>Encoding<span class="w"> </span><span class="o">=</span><span class="w"> </span>UTF<span class="o">-</span><span class="mi">16</span>
<span class="w">        </span>Encoding<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1200</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span>Encoding<span class="w"> </span><span class="o">=</span><span class="w"> </span>UTF<span class="o">-</span><span class="mi">8</span>
<span class="w">        </span>Encoding<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">65001</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nf">SubStr</span><span class="p">(</span>Encoding<span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="s">&quot;CP&quot;</span>
<span class="w">        </span>Encoding<span class="w"> </span><span class="o">:=</span><span class="w"> </span>SubStr<span class="p">(</span>Encoding<span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="o">!</span>Encoding<span class="w"> </span><span class="c1">; &quot;&quot; or 0</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">; No conversion required.</span>
<span class="w">        </span>char_count<span class="w"> </span><span class="o">:=</span><span class="w"> </span>StrLen<span class="p">(</span>String<span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">; + 1 because generally a null-terminator is wanted.</span>
<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>Length<span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">; Check for sufficient buffer space.</span>
<span class="w">            </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>StrLen<span class="p">(</span>String<span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span>Length<span class="w"> </span><span class="o">||</span><span class="w"> </span>Length<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>StrLen<span class="p">(</span>String<span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>Length<span class="p">)</span>
<span class="w">                    </span><span class="c1">; Exceptional case: caller doesn&#39;t want a null-terminator.</span>
<span class="w">                    </span>char_count<span class="o">--</span>
<span class="w">                </span><span class="c1">; Copy the string, including null-terminator if requested.</span>
<span class="w">                </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;RtlMoveMemory&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>Address<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>String<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>char_count<span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c1">; For consistency with the sections below, don&#39;t truncate the string.</span>
<span class="w">                </span>char_count<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">;else: Caller just wants the the required buffer size (char_count), which will be returned below.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span>Encoding<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1200</span><span class="w"> </span><span class="c1">; UTF-16</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">; See the &#39;else&#39; to this &#39;if&#39; below for comments.</span>
<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>Length<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span>char_count<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;MultiByteToWideChar&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>String<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>StrLen<span class="p">(</span>String<span class="p">),</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>Length<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span>char_count
<span class="w">            </span>Length<span class="w"> </span><span class="o">:=</span><span class="w"> </span>char_count
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>char_count<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;MultiByteToWideChar&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>String<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>StrLen<span class="p">(</span>String<span class="p">),</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>Address<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>Length<span class="p">)</span>
<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>char_count<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>char_count<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>Length<span class="p">)</span>
<span class="w">            </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>Address<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>char_count<span class="o">++*</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;UShort&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span>Encoding<span class="w"> </span>is<span class="w"> </span>integer
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">; Convert native ANSI string to UTF-16 first.  NOTE - wbuf_len includes the null-terminator.</span>
<span class="w">        </span><span class="nf">VarSetCapacity</span><span class="p">(</span>wbuf<span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>wbuf_len<span class="w"> </span><span class="o">:=</span><span class="w"> </span>StrPut<span class="p">(</span>String<span class="p">,</span><span class="w"> </span><span class="s">&quot;UTF-16&quot;</span><span class="p">)),</span><span class="w"> </span>StrPut<span class="p">(</span>String<span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>wbuf<span class="p">,</span><span class="w"> </span><span class="s">&quot;UTF-16&quot;</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">; UTF-8 and some other encodings do not support this flag.  Avoid it for UTF-8</span>
<span class="w">        </span><span class="c1">; (which is probably common) and rely on the fallback behaviour for other encodings.</span>
<span class="w">        </span>flags<span class="w"> </span><span class="o">:=</span><span class="w"> </span>Encoding<span class="o">=</span><span class="mi">65001</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0x400</span><span class="w">  </span><span class="c1">; WC_NO_BEST_FIT_CHARS</span>
<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>Length<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">; -1 or 0</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="c1">; Determine required buffer size.</span>
<span class="w">            </span><span class="k">loop</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>char_count<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;WideCharToMultiByte&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>Encoding<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>flags<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>wbuf<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>wbuf_len<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>char_count<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">A_LastError</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1004</span><span class="p">)</span><span class="w"> </span><span class="c1">; ERROR_INVALID_FLAGS</span>
<span class="w">                    </span><span class="k">break</span>
<span class="w">                </span>flags<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c1">; Try again without WC_NO_BEST_FIT_CHARS.</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span>char_count<span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="c1">; FAIL</span>
<span class="w">            </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>Length<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">; Caller just wants the required buffer size.</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span>char_count
<span class="w">            </span><span class="c1">; Assume there is sufficient buffer space and hope for the best:</span>
<span class="w">            </span>Length<span class="w"> </span><span class="o">:=</span><span class="w"> </span>char_count
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">; Convert to target encoding.</span>
<span class="w">        </span>char_count<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;WideCharToMultiByte&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>Encoding<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>flags<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>wbuf<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>wbuf_len<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>Address<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>Length<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="c1">; Since above did not null-terminate, check for buffer space and null-terminate if there&#39;s room.</span>
<span class="w">        </span><span class="c1">; It is tempting to always null-terminate (potentially replacing the last byte of data),</span>
<span class="w">        </span><span class="c1">; but that would exclude this function as a means to copy a string into a fixed-length array.</span>
<span class="w">        </span><span class="nf">if</span><span class="w"> </span><span class="p">(</span>char_count<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>char_count<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>Length<span class="p">)</span>
<span class="w">            </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>Address<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>char_count<span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Char&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="c1">; else no space to null-terminate; or conversion failed.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">; Return the number of characters copied.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span>char_count
<span class="p">}</span>
</pre></div>


New Lexer: 
<div class="highlight"><pre><span class="nf">StrPut</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">Length</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Encoding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="nb">if </span><span class="nv">A_IsUnicode</span>
    <span class="p">{</span>
<span class="w">        </span><span class="nb">MsgBox</span> <span class="nv">%A_ThisFunc%</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">support</span> <span class="n">Unicode</span><span class="o">.</span> <span class="n">Use</span> <span class="n">the</span> <span class="n">AutoHotkey_L</span> <span class="p">(</span><span class="n">revision</span> <span class="mi">46</span><span class="o">+</span><span class="p">)</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">version</span> <span class="n">instead</span><span class="o">.</span> <span class="n">The</span> <span class="n">script</span> <span class="n">will</span> <span class="n">now</span> <span class="n">exit</span><span class="o">.</span>
<span class="w">        </span><span class="nb">ExitApp</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ; Flexible parameter handling:</span>
<span class="w">    </span><span class="nb">if </span><span class="n">Address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">integer</span><span class="c-Singleline">       ; StrPut(String [, Encoding])</span>
        <span class="n">Encoding</span> <span class="o">:=</span> <span class="n">Address</span><span class="p">,</span>  <span class="n">Length</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">Address</span> <span class="o">:=</span> <span class="mi">1024</span>
<span class="w">    </span><span class="nb">else</span> <span class="n">if</span> <span class="n">Length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">integer</span><span class="c-Singleline">   ; StrPut(String, Address, Encoding)</span>
        <span class="n">Encoding</span> <span class="o">:=</span> <span class="n">Length</span><span class="p">,</span>  <span class="n">Length</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ; Check for obvious errors.</span>
    <span class="n">if</span> <span class="p">(</span><span class="n">Address</span><span class="o">+</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
<span class="w">        </span><span class="nb">return</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ; Ensure &#39;Encoding&#39; contains a numeric identifier.</span>
<span class="w">    </span><span class="nb">if </span><span class="n">Encoding</span> <span class="o">=</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">16</span>
        <span class="n">Encoding</span> <span class="o">=</span> <span class="mi">1200</span>
<span class="w">    </span><span class="nb">else</span> <span class="n">if</span> <span class="n">Encoding</span> <span class="o">=</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
        <span class="n">Encoding</span> <span class="o">=</span> <span class="mi">65001</span>
<span class="w">    </span><span class="nb">else</span> <span class="n">if</span> <span class="nf">SubStr</span><span class="p">(</span><span class="n">Encoding</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="s">&quot;CP&quot;</span>
        <span class="n">Encoding</span> <span class="o">:=</span> <span class="nf">SubStr</span><span class="p">(</span><span class="n">Encoding</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">if</span> <span class="o">!</span><span class="n">Encoding</span><span class="c-Singleline"> ; &quot;&quot; or 0</span>
    <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        ; No conversion required.</span>
        <span class="n">char_count</span> <span class="o">:=</span> <span class="nf">StrLen</span><span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="c-Singleline"> ; + 1 because generally a null-terminator is wanted.</span>
        <span class="n">if</span> <span class="p">(</span><span class="n">Length</span><span class="p">)</span>
        <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ; Check for sufficient buffer space.</span>
            <span class="n">if</span> <span class="p">(</span><span class="nf">StrLen</span><span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">Length</span> <span class="o">||</span> <span class="n">Length</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">if</span> <span class="p">(</span><span class="nf">StrLen</span><span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">==</span> <span class="n">Length</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">                    ; Exceptional case: caller doesn&#39;t want a null-terminator.</span>
                    <span class="n">char_count</span><span class="o">--</span><span class="c-Singleline"></span>
<span class="c-Singleline">                ; Copy the string, including null-terminator if requested.</span>
                <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;RtlMoveMemory&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">String</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">char_count</span><span class="p">)</span>
            <span class="p">}</span>
<span class="w">            </span><span class="nb">else</span><span class="c-Singleline"></span>
<span class="c-Singleline">                ; For consistency with the sections below, don&#39;t truncate the string.</span>
                <span class="n">char_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        ;else: Caller just wants the the required buffer size (char_count), which will be returned below.</span>
    <span class="p">}</span>
<span class="w">    </span><span class="nb">else</span> <span class="n">if</span> <span class="n">Encoding</span> <span class="o">=</span> <span class="mi">1200</span><span class="c-Singleline"> ; UTF-16</span>
    <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        ; See the &#39;else&#39; to this &#39;if&#39; below for comments.</span>
        <span class="n">if</span> <span class="p">(</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">char_count</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;MultiByteToWideChar&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">String</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">StrLen</span><span class="p">(</span><span class="n">String</span><span class="p">),</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">if</span> <span class="p">(</span><span class="n">Length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="nb">return</span> <span class="n">char_count</span>
            <span class="n">Length</span> <span class="o">:=</span> <span class="n">char_count</span>
        <span class="p">}</span>
        <span class="n">char_count</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;MultiByteToWideChar&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">String</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">StrLen</span><span class="p">(</span><span class="n">String</span><span class="p">),</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">Length</span><span class="p">)</span>
        <span class="n">if</span> <span class="p">(</span><span class="n">char_count</span> <span class="o">&amp;&amp;</span> <span class="n">char_count</span> <span class="o">&lt;</span> <span class="n">Length</span><span class="p">)</span>
            <span class="nf">NumPut</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Address</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">char_count</span><span class="o">++*</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;UShort&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="w">    </span><span class="nb">else</span> <span class="n">if</span> <span class="n">Encoding</span> <span class="ow">is</span> <span class="n">integer</span>
    <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        ; Convert native ANSI string to UTF-16 first.  NOTE - wbuf_len includes the null-terminator.</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">wbuf</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">wbuf_len</span> <span class="o">:=</span> <span class="nf">StrPut</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s">&quot;UTF-16&quot;</span><span class="p">)),</span> <span class="nf">StrPut</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wbuf</span><span class="p">,</span> <span class="s">&quot;UTF-16&quot;</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ; UTF-8 and some other encodings do not support this flag.  Avoid it for UTF-8</span>
<span class="c-Singleline">        ; (which is probably common) and rely on the fallback behaviour for other encodings.</span>
        <span class="n">flags</span> <span class="o">:=</span> <span class="n">Encoding</span><span class="o">=</span><span class="mi">65001</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x400</span><span class="c-Singleline">  ; WC_NO_BEST_FIT_CHARS</span>
        <span class="n">if</span> <span class="p">(</span><span class="n">Length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span><span class="c-Singleline"> ; -1 or 0</span>
        <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ; Determine required buffer size.</span>
<span class="w">            </span><span class="nb">loop</span> <span class="mi">2</span> <span class="p">{</span>
                <span class="n">char_count</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;WideCharToMultiByte&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wbuf</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">wbuf_len</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">if</span> <span class="p">(</span><span class="n">char_count</span> <span class="o">||</span> <span class="nv">A_LastError</span> <span class="o">!=</span> <span class="mi">1004</span><span class="p">)</span><span class="c-Singleline"> ; ERROR_INVALID_FLAGS</span>
<span class="w">                    </span><span class="nb">break</span>
                <span class="n">flags</span> <span class="o">:=</span> <span class="mi">0</span><span class="c-Singleline">  ; Try again without WC_NO_BEST_FIT_CHARS.</span>
            <span class="p">}</span>
            <span class="n">if</span> <span class="p">(</span><span class="o">!</span><span class="n">char_count</span><span class="p">)</span>
<span class="w">                </span><span class="nb">return</span><span class="c-Singleline"> ; FAIL</span>
            <span class="n">if</span> <span class="p">(</span><span class="n">Length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="c-Singleline"> ; Caller just wants the required buffer size.</span>
<span class="w">                </span><span class="nb">return</span> <span class="n">char_count</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ; Assume there is sufficient buffer space and hope for the best:</span>
            <span class="n">Length</span> <span class="o">:=</span> <span class="n">char_count</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        ; Convert to target encoding.</span>
        <span class="n">char_count</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;WideCharToMultiByte&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wbuf</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">wbuf_len</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">Address</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">Length</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        ; Since above did not null-terminate, check for buffer space and null-terminate if there&#39;s room.</span>
<span class="c-Singleline">        ; It is tempting to always null-terminate (potentially replacing the last byte of data),</span>
<span class="c-Singleline">        ; but that would exclude this function as a means to copy a string into a fixed-length array.</span>
        <span class="n">if</span> <span class="p">(</span><span class="n">char_count</span> <span class="o">&amp;&amp;</span> <span class="n">char_count</span> <span class="o">&lt;</span> <span class="n">Length</span><span class="p">)</span>
            <span class="nf">NumPut</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Address</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="n">char_count</span><span class="o">++</span><span class="p">,</span> <span class="s">&quot;Char&quot;</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        ; else no space to null-terminate; or conversion failed.</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    ; Return the number of characters copied.</span>
<span class="w">    </span><span class="nb">return</span> <span class="n">char_count</span>
<span class="p">}</span>
</pre></div>
