<LINK href="styles.css" rel="stylesheet" type="text/css"><div class="highlight"><pre><span class="c-Singleline">; Crazy Scripting : Safely Remove USB Flash Drive - 45L by SKAN</span>
<span class="c-Singleline">; http://www.autohotkey.com/forum/viewtopic.php?p=272661#272661</span>

<span class="n">USBD_SafelyRemove</span><span class="p">(</span> <span class="n">Drv</span> <span class="p">)</span> <span class="p">{</span>
<span class="w"> </span><span class="nb">If </span><span class="nv">A_OSVersion</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="n">WIN_VISTA</span><span class="p">,</span><span class="n">WIN_XP</span><span class="p">,</span><span class="n">WIN_2000</span>
<span class="w">   </span><span class="nb">Return</span>
 <span class="n">If</span> <span class="o">!</span> <span class="p">(</span> <span class="n">Serial</span> <span class="o">:=</span> <span class="n">USBD_GetDeviceSerial</span><span class="p">(</span> <span class="n">Drv</span> <span class="p">)</span> <span class="p">)</span>
<span class="w">   </span><span class="nb">Return</span> 
 <span class="n">DeviceID</span> <span class="o">:=</span> <span class="n">USBD_GetDeviceID</span><span class="p">(</span> <span class="n">Serial</span> <span class="p">)</span>
 <span class="n">USBD_DeviceEject</span><span class="p">(</span> <span class="n">DeviceID</span> <span class="p">)</span>
<span class="w"> </span><span class="nb">IfExist</span><span class="p">,</span> <span class="nv">%Drv%</span>\<span class="p">,</span> <span class="n">TrayTip</span><span class="p">,</span> <span class="nv">%DeviceID%</span><span class="p">,</span> <span class="n">Drive</span> <span class="nv">%Drv%</span> <span class="n">was</span> <span class="ow">not</span> <span class="n">Ejected</span><span class="o">!</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span>
<span class="w"> </span><span class="nb">Else</span><span class="p">,</span> <span class="n">TrayTip</span><span class="p">,</span> <span class="nv">%DeviceID%</span><span class="p">,</span> <span class="n">Drive</span> <span class="nv">%Drv%</span> <span class="n">was</span> <span class="n">safely</span> <span class="n">Removed</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="n">USBD_GetDeviceSerial</span><span class="p">(</span> <span class="n">Drv</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">)</span> <span class="p">{</span>
<span class="w"> </span><span class="nb">DriveGet</span><span class="p">,</span> <span class="n">DriveType</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="nv">%Drv%</span>
<span class="w"> </span><span class="nb">IfNotEqual</span><span class="p">,</span><span class="n">DriveType</span><span class="p">,</span><span class="n">Removable</span><span class="p">,</span> <span class="n">Return</span>
<span class="w"> </span><span class="nb">RegRead</span><span class="p">,</span> <span class="n">Hex</span><span class="p">,</span> <span class="n">HKLM</span><span class="p">,</span> <span class="n">SYSTEM</span>\<span class="n">MountedDevices</span><span class="p">,</span> \<span class="n">DosDevices</span>\<span class="nv">%Drv%</span>
 <span class="nf">VarSetCapacity(</span><span class="n">U</span><span class="p">,(</span><span class="n">Sz</span><span class="o">:=</span><span class="nf">StrLen(</span><span class="n">Hex</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)),</span>  <span class="nf">VarSetCapacity(</span><span class="n">A</span><span class="p">,</span><span class="n">Sz</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="w"> </span><span class="nb">Loop</span> <span class="o">%</span> <span class="n">Sz</span>
  <span class="nf">NumPut(</span> <span class="s">&quot;0x&quot;</span> <span class="o">.</span> <span class="nf">SubStr(</span><span class="n">hex</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nv">A_Index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">U</span><span class="p">,</span> <span class="nv">A_Index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Char&quot;</span> <span class="p">)</span>
 <span class="nf">DllCall(</span> <span class="s">&quot;WideCharToMultiByte&quot;</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Int</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span><span class="o">&amp;</span><span class="n">U</span><span class="p">,</span><span class="n">UInt</span><span class="p">,</span><span class="n">Sz</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">UInt</span><span class="p">,</span><span class="n">Sz</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Int</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="w"> </span><span class="nb">StringSplit</span><span class="p">,</span> <span class="n">Part</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">#</span>
 <span class="n">ParentIdPrefixCheck</span> <span class="o">:=</span> <span class="nf">SubStr(</span> <span class="n">Part3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nf">InStr(</span><span class="n">Part3</span><span class="p">,</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
<span class="w"> </span><span class="nb">IfEqual</span><span class="p">,</span><span class="nv">A_OSVersion</span><span class="p">,</span><span class="n">WIN_VISTA</span><span class="p">,</span> <span class="n">Return</span><span class="p">,</span><span class="n">ParentIdPrefixCheck</span>
<span class="w"> </span><span class="nb">Loop</span><span class="p">,</span> <span class="n">HKLM</span><span class="p">,</span> <span class="n">SYSTEM</span>\<span class="n">CurrentControlSet</span>\<span class="n">Enum</span>\<span class="n">USBSTOR</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
  <span class="p">{</span> <span class="n">Device</span> <span class="o">:=</span> <span class="nv">A_LoopRegName</span>
<span class="w">    </span><span class="nb">Loop</span><span class="p">,</span> <span class="n">HKLM</span><span class="p">,</span> <span class="n">SYSTEM</span>\<span class="n">CurrentControlSet</span>\<span class="n">Enum</span>\<span class="n">USBSTOR</span>\<span class="nv">%Device%</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
     <span class="p">{</span> <span class="n">Serial</span> <span class="o">:=</span> <span class="nv">A_LoopRegName</span>
<span class="w">       </span><span class="nb">RegRead</span><span class="p">,</span> <span class="n">PIPrefix</span><span class="p">,</span> <span class="n">HKLM</span><span class="p">,</span> <span class="n">SYSTEM</span>\<span class="n">CurrentControlSet</span>\<span class="n">Enum</span>\<span class="n">USBSTOR</span>\<span class="nv">%Device%</span>\<span class="nv">%Serial%</span>
              <span class="p">,</span> <span class="n">ParentIdPrefix</span>
       <span class="n">If</span> <span class="p">(</span> <span class="n">PIPrefix</span> <span class="o">=</span> <span class="n">ParentIdPrefixCheck</span> <span class="p">)</span>
<span class="w">         </span><span class="nb">Return</span><span class="p">,</span> <span class="nf">SubStr(</span> <span class="n">Serial</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nf">InStr(</span><span class="n">Serial</span><span class="p">,</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
     <span class="p">}</span>
<span class="p">}}</span>

<span class="n">USBD_GetDeviceID</span><span class="p">(</span> <span class="n">Serial</span> <span class="p">)</span> <span class="p">{</span>
<span class="w"> </span><span class="nb">Loop</span><span class="p">,</span> <span class="n">HKLM</span><span class="p">,</span> <span class="n">SYSTEM</span>\<span class="n">CurrentControlSet</span>\<span class="n">Enum</span>\<span class="n">USB</span>\<span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
  <span class="p">{</span> <span class="n">Device</span> <span class="o">:=</span> <span class="nv">A_LoopRegName</span>
<span class="w">    </span><span class="nb">Loop</span><span class="p">,</span> <span class="n">HKLM</span><span class="p">,</span> <span class="n">SYSTEM</span>\<span class="n">CurrentControlSet</span>\<span class="n">Enum</span>\<span class="n">USB</span>\<span class="nv">%Device%</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
    <span class="n">If</span> <span class="p">(</span> <span class="nv">A_LoopRegName</span><span class="o">=</span><span class="n">Serial</span> <span class="p">)</span>
<span class="w">      </span><span class="nb">Return</span> <span class="nf">DllCall(</span> <span class="s">&quot;CharUpperA&quot;</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="s">&quot;USB\&quot;</span> <span class="n">Device</span> <span class="s">&quot;\&quot;</span> <span class="n">Serial</span><span class="p">,</span> <span class="n">Str</span> <span class="p">)</span>
<span class="p">}}</span>

<span class="n">USBD_DeviceEject</span><span class="p">(</span> <span class="n">DeviceID</span> <span class="p">)</span> <span class="p">{</span>
 <span class="n">hMod</span> <span class="o">:=</span> <span class="nf">DllCall(</span> <span class="s">&quot;LoadLibrary&quot;</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span><span class="s">&quot;SetupAPI.dll&quot;</span> <span class="p">),</span> <span class="nf">VarSetCapacity(</span><span class="n">VE</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">If</span> <span class="o">!</span> <span class="nf">DllCall(</span> <span class="s">&quot;SetupAPI\CM_Locate_DevNodeA&quot;</span><span class="p">,</span> <span class="n">UIntP</span><span class="p">,</span><span class="n">DI</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span><span class="n">DeviceID</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span><span class="mi">0</span> <span class="p">)</span>
 <span class="n">If</span> <span class="o">!</span> <span class="nf">DllCall(</span> <span class="s">&quot;SetupAPI\CM_Get_DevNode_Status&quot;</span><span class="p">,</span> <span class="n">UIntP</span><span class="p">,</span><span class="n">STS</span><span class="p">,</span> <span class="n">UIntP</span><span class="p">,</span><span class="n">PR</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span><span class="n">DI</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
 <span class="nf">DllCall(</span> <span class="s">&quot;SetupAPI\CM_Request_Device_EjectA&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span><span class="n">DI</span><span class="p">,</span> <span class="n">UIntP</span><span class="p">,</span><span class="n">VT</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span><span class="n">VE</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
 <span class="nf">DllCall(</span> <span class="s">&quot;FreeLibrary&quot;</span><span class="p">,</span> <span class="n">UInt</span><span class="p">,</span><span class="n">hMod</span> <span class="p">)</span>
<span class="p">}</span>
</pre></div>
