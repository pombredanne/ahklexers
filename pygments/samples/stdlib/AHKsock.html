<LINK href="styles.css" rel="stylesheet" type="text/css">old lexer: 
<div class="highlight"><pre><span class="cm">/*! TheGood</span>
<span class="cm">    AHKsock - A simple AHK implementation of Winsock.</span>
<span class="cm">    http://www.autohotkey.com/forum/viewtopic.php?p=355775</span>
<span class="cm">    Last updated: August 24th, 2010</span>
<span class="cm">    </span>
<span class="cm">FUNCTION LIST:</span>

<span class="cm">________________________________________</span>
<span class="cm">AHKsock_Listen(sPort, sFunction = False)</span>

<span class="cm">Tells AHKsock to listen on the port in sPort, and call the function in sFunction when events occur. If sPort is a port on</span>
<span class="cm">which AHKsock is already listening, the action taken depends on sFunction:</span>
<span class="cm">    - If sFunction is False, AHKsock will stop listening on the port in sPort.</span>
<span class="cm">    - If sFunction is &quot;()&quot;, AHKsock will return the name of the current function AHKsock calls when</span>
<span class="cm">      a client connects on the port in sPort.</span>
<span class="cm">    - If sFunction is a valid function, AHKsock will set that function as the new function to call</span>
<span class="cm">      when a client connects on the port in sPort.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    2: sFunction is not a valid function.</span>
<span class="cm">    3: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    4: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    5: The getaddrinfo() call failed. The error is in ErrorLevel.</span>
<span class="cm">    6: The socket() call failed. The error is in ErrorLevel.</span>
<span class="cm">    7: The bind() call failed. The error is in ErrorLevel.</span>
<span class="cm">    8: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">    9: The listen() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">See the section titled &quot;STRUCTURE OF THE EVENT-HANDLING FUNCTION AND MORE INFO ABOUT SOCKETS&quot; for more info about how the</span>
<span class="cm">function in sFunction interacts with AHKsock.</span>

<span class="cm">________________________________________</span>
<span class="cm">AHKsock_Connect(sName, sPort, sFunction)</span>

<span class="cm">Tells AHKsock to connect to the hostname or IP address in sName on the port in sPort, and call the function in sFunction</span>
<span class="cm">when events occur.</span>

<span class="cm">Although the function will return right away, the connection attempt will still be in progress. Once the connection attempt</span>
<span class="cm">is over, successful or not, sFunction will receive the CONNECTED event. Note that it is important that once AHKsock_Connect</span>
<span class="cm">returns, the current thread must stay (or soon after must become) interruptible so that sFunction can be called once the</span>
<span class="cm">connection attempt is over.</span>

<span class="cm">AHKsock_Connect can only be called again once the previous connection attempt is over. To check if AHKsock_Connect is ready</span>
<span class="cm">to make another connection attempt, you may keep polling it by calling AHKsock_Connect(0,0,0) until it returns False.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    1: AHKsock_Connect is still processing a connection attempt. ErrorLevel contains the name and the port of that</span>
<span class="cm">       connection attempt, separated by a tab.</span>
<span class="cm">    2: sFunction is not a valid function.</span>
<span class="cm">    3: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    4: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    5: The getaddrinfo() call failed. The error is in ErrorLevel.</span>
<span class="cm">    6: The socket() call failed. The error is in ErrorLevel.</span>
<span class="cm">    7: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">    8: The connect() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">See the section titled &quot;STRUCTURE OF THE EVENT-HANDLING FUNCTION AND MORE INFO ABOUT SOCKETS&quot; for more info about how the</span>
<span class="cm">function in sFunction interacts with AHKsock.</span>

<span class="cm">_______________________________________</span>
<span class="cm">AHKsock_Send(iSocket, ptrData, iLength)</span>

<span class="cm">Sends the data of length iLength to which ptrData points to the connected socket in iSocket.</span>

<span class="cm">Returns the number of bytes sent on success. This can be less than the number requested to be sent in the iLength parameter,</span>
<span class="cm">i.e. between 1 and iLength. This would occur if no buffer space is available within the transport system to hold the data to</span>
<span class="cm">be transmitted, in which case the number of bytes sent can be between 1 and the requested length, depending on buffer</span>
<span class="cm">availability on both the client and server computers. On failure, it returns one of the following negative integer:</span>
<span class="cm">    -1: WSAStartup hasn&#39;t been called yet.</span>
<span class="cm">    -2: Received WSAEWOULDBLOCK. This means that calling send() would have blocked the thread.</span>
<span class="cm">    -3: The send() call failed. The error is in ErrorLevel.</span>
<span class="cm">    -4: The socket specified in iSocket is not a valid socket. This means either that the socket in iSocket hasn&#39;t been</span>
<span class="cm">        created using AHKsock_Connect or AHKsock_Listen, or that the socket has already been destroyed.</span>
<span class="cm">    -5: The socket specified in iSocket is not cleared for sending. You haven&#39;t waited for the SEND event before calling,</span>
<span class="cm">        either ever, or not since you last received WSAEWOULDBLOCK.</span>

<span class="cm">You may start sending data to the connected socket in iSocket only after the socket&#39;s associated function receives the first</span>
<span class="cm">SEND event. Upon receiving the event, you may keep calling AHKsock_Send to send data until you receive the error -2, at</span>
<span class="cm">which point you must wait once again until you receive another SEND event before sending more data. Not waiting for the SEND</span>
<span class="cm">event results in receiving error -5 when calling AHKsock_Send.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">____________________________________________</span>
<span class="cm">AHKsock_ForceSend(iSocket, ptrData, iLength)</span>

<span class="cm">This function is exactly the same as AHKsock_Send, but with three differences:</span>
<span class="cm">    - If only part of the data could be sent, it will automatically keep trying to send the remaining part.</span>
<span class="cm">    - If it receives WSAEWOULDBLOCK, it will wait for the socket&#39;s SEND event and try sending the data again.</span>
<span class="cm">    - If the data buffer to send is larger than the socket&#39;s send buffer size, it will automatically send the data in</span>
<span class="cm">      smaller chunks in order to avoid a performance hit. See http://support.microsoft.com/kb/823764 for more info.</span>

<span class="cm">Therefore, AHKsock_ForceSend will return only when all the data has been sent. Because this function relies on waiting for</span>
<span class="cm">the socket&#39;s SEND event before continuing to send data, it cannot be called in a critical thread. Also, for the same reason,</span>
<span class="cm">it cannot be called from a socket&#39;s associated function (not specifically iSocket&#39;s associated function, but any socket&#39;s</span>
<span class="cm">associated function).</span>

<span class="cm">Another limitation to consider when choosing between AHKsock_Send and AHKsock_ForceSend is that AHKsock_ForceSend will not</span>
<span class="cm">return until all the data has been sent (unless an error occurs). Although the script will still be responsive (new threads</span>
<span class="cm">will still be able to launch), the thread from which it was called will not resume until it returns. Therefore, if sending</span>
<span class="cm">a large amount of data, you should either use AHKsock_Send, or use AHKsock_ForceSend by feeding it smaller pieces of the</span>
<span class="cm">data, allowing you to update the GUI if necessary (e.g. a progress bar).</span>

<span class="cm">Returns blank on success, which means that all the data to which ptrData points of length iLength has been sent. On failure,</span>
<span class="cm">it returns one of the following negative integer:</span>
<span class="cm">    -1: WSAStartup hasn&#39;t been called yet.</span>
<span class="cm">    -2: Received WSAEWOULDBLOCK. This means that calling send() would have blocked the thread.</span>
<span class="cm">    -3: The send() call failed. The error is in ErrorLevel.</span>
<span class="cm">    -4: The socket specified in iSocket is not a valid socket. This means either that the socket in iSocket hasn&#39;t been</span>
<span class="cm">        created using AHKsock_Connect or AHKsock_Listen, or that the socket has already been destroyed.</span>
<span class="cm">    -5: The current thread is critical.</span>
<span class="cm">    -6: The getsockopt() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">____________________________________________</span>
<span class="cm">AHKsock_Close(iSocket = -1, iTimeout = 5000)</span>

<span class="cm">Closes the socket in iSocket. If no socket is specified, AHKsock_Close will close all the sockets on record, as well as</span>
<span class="cm">terminate use of the Winsock 2 DLL (by calling WSACleanup). If graceful shutdown cannot be attained after the timeout</span>
<span class="cm">specified in iTimeout (in milliseconds), it will perform a hard shutdown before calling WSACleanup to free resources. See</span>
<span class="cm">the section titled &quot;NOTES ON CLOSING SOCKETS AND AHKsock_Close&quot; for more information.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    1: The shutdown() call failed. The error is in ErrorLevel. AHKsock_Close forcefully closed the socket and freed the</span>
<span class="cm">       associated resources.</span>

<span class="cm">Note that when AHKsock_Close is called with no socket specified, it will never return an error.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">___________________________________________________________</span>
<span class="cm">AHKsock_GetAddrInfo(sHostName, ByRef sIPList, bOne = False)</span>

<span class="cm">Retrieves the list of IP addresses that correspond to the hostname in sHostName. The list is contained in sIPList, delimited</span>
<span class="cm">by newline characters. If bOne is True, only one IP (the first one) will be returned.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    1: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    2: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    3: Received WSAHOST_NOT_FOUND. No such host is known.</span>
<span class="cm">    4: The getaddrinfo() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">_________________________________________________________________________</span>
<span class="cm">AHKsock_GetNameInfo(sIP, ByRef sHostName, sPort = 0, ByRef sService = &quot;&quot;)</span>

<span class="cm">Retrieves the hostname that corresponds to the IP address in sIP. If a port in sPort is supplied, it also retrieves the</span>
<span class="cm">service that corresponds to the port in sPort.</span>

<span class="cm">Returns blank on success. On failure, it returns on of the following positive integer:</span>
<span class="cm">    1: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    2: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    3: The IP address supplied in sIP is invalid.</span>
<span class="cm">    4: The getnameinfo() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">______________________________________________</span>
<span class="cm">AHKsock_SockOpt(iSocket, sOption, iValue = -1)</span>

<span class="cm">Retrieves or sets a socket option. Supported options are:</span>
<span class="cm">    SO_KEEPALIVE: Enable/Disable sending keep-alives. iValue must be True/False to enable/disable. Disabled by default.</span>
<span class="cm">    SO_SNDBUF:    Total buffer space reserved for sends. Set iValue to 0 to completely disable the buffer. Default is 8 KB.</span>
<span class="cm">    SO_RCVBUF:    Total buffer space reserved for receives. Default is 8 KB.</span>
<span class="cm">    TCP_NODELAY:  Enable/Disable the Nagle algorithm for send coalescing. Set iValue to True to disable the Nagle algorithm,</span>
<span class="cm">                  set iValue to False to enable the Nagle algorithm, which is the default.</span>

<span class="cm">It is usually best to leave these options to their default (especially the Nagle algorithm). Only change them if you</span>
<span class="cm">understand the consequences. See MSDN for more information on those options.</span>

<span class="cm">If iValue is specified, it sets the option to iValue and returns blank on success. If iValue is left as -1, it returns the</span>
<span class="cm">value of the option specified. On failure, it returns one of the following negative integer:</span>
<span class="cm">    -1: The getsockopt() failed. The error is in ErrorLevel.</span>
<span class="cm">    -2: The setsockopt() failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">_______________________________________</span>
<span class="cm">AHKsock_Settings(sSetting, sValue = &quot;&quot;)</span>

<span class="cm">Changes the AHKsock setting in sSetting to sValue. If sValue is blank, the current value for that setting is returned. If</span>
<span class="cm">sValue is the word &quot;Reset&quot;, the setting is restored to its default value. The possible settings are:</span>
<span class="cm">    Message: Determines the Windows message numbers used to monitor network events. The message number in iMessage and the</span>
<span class="cm">             next number will be used. Default value is 0x8000. For example, calling AHKsock_Settings(&quot;Message&quot;, 0x8005)</span>
<span class="cm">             will cause AHKsock to use 0x8005 and 0x8006 to monitor network events.</span>
<span class="cm">    Buffer:  Determines the size of the buffer (in bytes) used when receiving data. This is thus the maximum size of bData</span>
<span class="cm">             when the RECEIVED event is raised. If the data received is more than the buffer size, multiple recv() calls</span>
<span class="cm">             (and thus multiple RECEIVED events) will be needed. Note that you shouldn&#39;t use this setting as a means of</span>
<span class="cm">             delimiting frames. See the &quot;NOTES ON RECEIVING AND SENDING DATA&quot; section for more information about receiving</span>
<span class="cm">             and sending data. Default value is 64 KB, which is the maximum for TCP.</span>

<span class="cm">If you do call AHKsock_Settings to change the values from their default ones, it is best to do so at the beginning of the</span>
<span class="cm">script. The message number used cannot be changed as long as there are active connections.</span>

<span class="cm">______________________________________</span>
<span class="cm">AHKsock_ErrorHandler(sFunction = &quot;&quot;&quot;&quot;)</span>

<span class="cm">Sets the function in sFunction to be the new error handler. If sFunction is left at its default value, it returns the name</span>
<span class="cm">of the current error handling function.</span>

<span class="cm">An error-handling function is optional, but may be useful when troubleshooting applications. The function will be called</span>
<span class="cm">anytime there is an error that arises in a thread which wasn&#39;t called by the user but by the receival of a Windows message</span>
<span class="cm">which was registered using OnMessage.</span>

<span class="cm">The function in sFunction must be of the following format:</span>
<span class="cm">MyErrorHandler(iError, iSocket)</span>

<span class="cm">The possible values for iError are:</span>
<span class="cm">     1: The connect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     2: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     3: The socket() call failed. The error is in ErrorLevel.</span>
<span class="cm">     4: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     5: The connect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     6: FD_READ event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">     7: The recv() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">     8: FD_WRITE event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">     9: FD_ACCEPT event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">    10: The accept() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="cm">    11: The WSAAsyncSelect() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="cm">    12: The listen() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="cm">    13: The shutdown() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">__________________________________________________________________</span>
<span class="cm">NOTES ON SOCKETS AND THE STRUCTURE OF THE EVENT-HANDLING FUNCTION:</span>

<span class="cm">The functions used in the sFunction parameter of AHKsock_Listen and AHKsock_Connect must be of the following format:</span>

<span class="cm">MyFunction(sEvent, iSocket = 0, sName = 0, sAddr = 0, sPort = 0, ByRef bData = 0, bDataLength = 0)</span>

<span class="cm">The variable sEvent contains the event for which MyFunction was called. The event raised is associated with one and only one</span>
<span class="cm">socket; the one in iSocket. The meaning of the possible events that can occur depend on the type of socket involved. AHKsock</span>
<span class="cm">deals with three different types of sockets:</span>
<span class="cm">    - Listening sockets: These sockets are created by a call to AHKsock_Listen. All they do is wait for clients to request</span>
<span class="cm">      a connection. These sockets will never appear as the iSocket parameter because requests for connections are</span>
<span class="cm">      immediately accepted, and MyFunction immediately receives the ACCEPTED event with iSocket set to the accepted socket.</span>
<span class="cm">    - Accepted sockets: These sockets are created once a listening socket receives an incoming connection attempt from a</span>
<span class="cm">      client and accepts it. They are thus the sockets that servers use to communicate with clients.</span>
<span class="cm">    - Connected sockets: These sockets are created by a successful call to AHKsock_Connect. These are the sockets that</span>
<span class="cm">      clients use to communicate with servers.</span>

<span class="cm">More info about sockets:</span>
<span class="cm">    - You may have multiple client sockets connecting to the same listening socket (ie. on the same port).</span>
<span class="cm">    - You may have multiple listening sockets for different ports.</span>
<span class="cm">    - You cannot have more than one listening socket for the same port (or you will receive a bind() error).</span>
<span class="cm">    - Every single connection between a client and a server will have its own client socket on the client side, and its own</span>
<span class="cm">      server (accepted) socket on the server side.</span>

<span class="cm">For all of the events that the event-handling function receives,</span>
<span class="cm">    - sEvent contains the event that occurred (as described below),</span>
<span class="cm">    - iSocket contains the socket on which the event occurred,</span>
<span class="cm">    - sName contains a value which depends on the type of socket in iSocket:</span>
<span class="cm">        - If the socket is an accepted socket, sName is empty.</span>
<span class="cm">        - If the socket is a connected socket, sName is the same value as the sName parameter that was used when</span>
<span class="cm">          AHKsock_Connect was called to create the socket. Since AHKsock_Connect accepts both hostnames and IP addresses,</span>
<span class="cm">          sName may contain either.</span>
<span class="cm">    - sAddr contains the IP address of the socket&#39;s endpoint (i.e. the peer&#39;s IP address). This means that if the socket in</span>
<span class="cm">      iSocket is an accepted socket, sAddr contains the IP address of the client. Conversely, if it is a connected socket,</span>
<span class="cm">      sAddr contains the server&#39;s IP.</span>
<span class="cm">    - sPort contains the server port on which the connection was accepted.</span>

<span class="cm">Obviously, if your script only calls AHKsock_Listen (acting as a server) or AHKsock_Connect (acting as a client) you don&#39;t</span>
<span class="cm">need to check if the socket in iSocket is an accepted socket or a connected socket, since it can only be one or the other.</span>
<span class="cm">But if you do call both AHKsock_Listen and AHKsock_Connect with both of them using the same function (e.g. MyFunction), then</span>
<span class="cm">you will need to check what type of socket iSocket is by checking the sName parameter.</span>

<span class="cm">Of course, it would be easier to simply have two different functions, for example, MyFunction1 and MyFunction2, with one</span>
<span class="cm">handling the server part and the other handling the client part so that you don&#39;t need to check what type of socket iSocket</span>
<span class="cm">is when each function is called. However, this might not be necessary if both server and client are &quot;symmetrical&quot; (i.e. the</span>
<span class="cm">conversation doesn&#39;t actually change whether or not we&#39;re on the server side or the client side). See Example 3 for an</span>
<span class="cm">example of this, where only one function is used for both server and client sockets.</span>

<span class="cm">The variable sEvent can be one of the following values if iSocket is an accepted socket:</span>
<span class="cm">    sEvent =      Event Description:</span>
<span class="cm">    ACCEPTED      A client connection was accepted (see the &quot;Listening sockets&quot; section above for more details).</span>
<span class="cm">    CONNECTED     &lt;Does not occur on accepted sockets&gt;</span>
<span class="cm">    DISCONNECTED  The client disconnected (see AHKsock_Close for more details).</span>
<span class="cm">    SEND          You may now send data to the client (see AHKsock_Send for more details).</span>
<span class="cm">    RECEIVED      You received data from the client. The data received is in bData and the length is in bDataLength.</span>
<span class="cm">    SENDLAST      The client is disconnecting. This is your last chance to send data to it. Once this function returns,</span>
<span class="cm">                  disconnection will occur. This event only occurs on the side which did not initiate shutdown (see</span>
<span class="cm">                  AHKsock_Close for more details).</span>

<span class="cm">The variable sEvent can be one of the following values if iSocket is a connected socket:</span>
<span class="cm">    sEvent =      Event Description:</span>
<span class="cm">    ACCEPTED      &lt;Does not occur on connected sockets&gt;</span>
<span class="cm">    CONNECTED     The connection attempt initiated by calling AHKsock_Connect has completed (see AHKsock_Connect for more</span>
<span class="cm">                  details). If it was successful, iSocket will equal the client socket. If it failed, iSocket will equal -1.</span>
<span class="cm">                  To get the error code that the failure returned, set an error handling function with AHKsock_ErrorHandler,</span>
<span class="cm">                  and read ErrorLevel when iError is equal to 1.</span>
<span class="cm">    DISCONNECTED  The server disconnected (see AHKsock_Close for more details).</span>
<span class="cm">    SEND          You may now send data to the server (see AHKsock_Send for more details).</span>
<span class="cm">    RECEIVED      You received data from the server. The data received is in bData and the length is in bDataLength.</span>
<span class="cm">    SENDLAST      The server is disconnecting. This is your last chance to send data to it. Once this function returns,</span>
<span class="cm">                  disconnection will occur. This event only occurs on the side which did not initiate shutdown (see </span>
<span class="cm">                  AHKsock_Close for more details).</span>

<span class="cm">More information: The event-handling functions described in here are always called with the Critical setting on. This is</span>
<span class="cm">necessary in order to ensure proper processing of messages. Note that as long as the event-handling function does not</span>
<span class="cm">return, AHKsock cannot process other network messages. Although messages are buffered, smooth operation might suffer when</span>
<span class="cm">letting the function run for longer than it should.</span>

<span class="cm">___________________________________________</span>
<span class="cm">NOTES ON CLOSING SOCKETS AND AHKsock_Close:</span>

<span class="cm">There are a few things to note about the AHKsock_Close function. The most important one is this: because the OnExit</span>
<span class="cm">subroutine cannot be made interruptible if running due to a call to Exit/ExitApp, AHKsock_Close will not be able to execute</span>
<span class="cm">a graceful shutdown if it is called from there. </span>

<span class="cm">A graceful shutdown refers to the proper way of closing a TCP connection. It consists of an exchange of special TCP messages</span>
<span class="cm">between the two endpoints to acknowledge that the connection is about to close. It also fires the SENDLAST event in the</span>
<span class="cm">socket&#39;s associated function to notify that this is the last chance it will have to send data before disconnection. Note</span>
<span class="cm">that listening sockets cannot (and therefore do not need to) be gracefully shutdown as it is not an end-to-end connection.</span>
<span class="cm">(In practice, you will never have to manually call AHKsock_Close on a listening socket because you do not have access to</span>
<span class="cm">them. The socket is closed when you stop listening by calling AHKsock_Listen with no specified value for the second</span>
<span class="cm">parameter.)</span>

<span class="cm">In order to allow the socket(s) connection(s) to gracefully shutdown (which is always preferable), AHKsock_Close must be</span>
<span class="cm">called in a thread which is, or can be made, interruptible. If it is called with a specified socket in iSocket, it will</span>
<span class="cm">initiate a graceful shutdown for that socket alone. If it is called with no socket specified, it will initiate a graceful</span>
<span class="cm">shutdown for all connected/accepted sockets, and once done, deregister itself from the Windows Sockets implementation and</span>
<span class="cm">allow the implementation to free any resources allocated for Winsock (by calling WSACleanup). In that case, if any</span>
<span class="cm">subsequent AHKsock function is called, Winsock will automatically be restarted.</span>

<span class="cm">Therefore, before exiting your application, AHKsock_Close must be called at least once with no socket specified in order to</span>
<span class="cm">free Winsock resources. This can be done in the OnExit subroutine, either if you do not wish to perform a graceful shutdown</span>
<span class="cm">(which is not recommended), or if you have already gracefully shutdown all the sockets individually before calling</span>
<span class="cm">Exit/ExitApp. Of course, it doesn&#39;t have to be done in the OnExit subroutine and can be done anytime before (which is the</span>
<span class="cm">recommended method because AHKsock will automatically gracefully shutdown all the sockets on record).</span>

<span class="cm">This behaviour has a few repercussions on your application&#39;s design. If the only way for the user to terminate your</span>
<span class="cm">application is through AHK&#39;s default Exit menu item in the tray menu, then upon selecting the Exit menu item, the OnExit sub</span>
<span class="cm">will fire, and your application will not have a chance to gracefully shutdown connected sockets. One way around this is to</span>
<span class="cm">add your own menu item which will in turn call AHKsock_Close with no socket specified before calling ExitApp to enter the</span>
<span class="cm">OnExit sub. See AHKsock Example 1 for an example of this.</span>

<span class="cm">This is how the graceful shutdown process occurs between two connected peers:</span>
<span class="cm">    a&gt; Once one of the peers (it may be the server of the client) is done sending all its data, it calls AHKsock_Close to</span>
<span class="cm">       shutdown the socket. (It is not a good idea to have the last peer receiving data call AHKsock_Close. This will result</span>
<span class="cm">       in AHKsock_Send errors on the other peer if more data needs to be sent.) In the next steps, we refer to the peer that</span>
<span class="cm">       first calls AHKsock_Close as the invoker, and the other peer simply as the peer.</span>
<span class="cm">    b&gt; The peer receives the invoker&#39;s intention to close the connection and is given one last chance to send any remaining</span>
<span class="cm">       data. This is when the peer&#39;s socket&#39;s associated function receives the SENDLAST event.</span>
<span class="cm">    c&gt; Once the peer is done sending any remaining data (if any), it also calls AHKsock_Close on that same socket to shut it</span>
<span class="cm">       down, and then close the socket for good. This happens once the peer&#39;s function that received the SENDLAST event</span>
<span class="cm">       returns from the event. At this point, the peer&#39;s socket&#39;s associated function receives the DISCONNECTED event.</span>
<span class="cm">    d&gt; This happens in parallel with c&gt;. After the invoker receives the peer&#39;s final data (if any), as well as notice that</span>
<span class="cm">       the peer has also called AHKsock_Close on the socket, the invoker finally also closes the socket for good. At this</span>
<span class="cm">       point, the socket&#39;s associated function also receives the DISCONNECTED event.</span>

<span class="cm">When AHKsock_Close is called with no socket specified, this process occurs (in parallel) for every connected socket on record.</span>

<span class="cm">____________________________________</span>
<span class="cm">NOTES ON RECEIVING AND SENDING DATA:</span>

<span class="cm">It&#39;s important to understand that AHKsock uses the TCP protocol, which is a stream protocol. This means that the data</span>
<span class="cm">received comes as a stream, with no apparent boundaries (i.e. frames or packets). For example, if a peer sends you a string,</span>
<span class="cm">it&#39;s possible that half the string is received in one RECEIVED event and the other half is received in the next. Of course,</span>
<span class="cm">the smaller the string, the less likely this happens. Conversely, the larger the string, the more likely this will occur.</span>

<span class="cm">Similarly, calling AHKsock_Send will not necessarily send the data right away. If multiple AHKsock_Send calls are issued,</span>
<span class="cm">Winsock might, under certain conditions, wait and accumulate data to send before sending it all at once. This process is</span>
<span class="cm">called coalescing. For example, if you send two strings to your peer by using two individual AHKsock_Send calls, the peer</span>
<span class="cm">will not necessarily receive two consecutive RECEIVED events for each string, but might instead receive both strings through</span>
<span class="cm">a single RECEIVED event.</span>

<span class="cm">One efficient method of receiving data as frames is to use length-prefixing. Length-prefixing means that before sending a</span>
<span class="cm">frame of variable length to your peer, you first tell it how many bytes will be in the frame. This way, your peer can</span>
<span class="cm">divide the received data into frames that can be individually processed. If it received less than a frame, it can store the</span>
<span class="cm">received data and wait for the remaining data to arrive before processing the completed frame with the length specified.</span>
<span class="cm">This technique is used in in AHKsock Example 3, where peers send each other strings by first declaring how long the string</span>
<span class="cm">will be (see the StreamProcessor function of Example 3).</span>

<span class="cm">____________________________________</span>
<span class="cm">NOTES ON TESTING A STREAM PROCESSOR:</span>

<span class="cm">As you write applications that use length-prefixing as described above, you might find it hard to test their ability to</span>
<span class="cm">properly cut up and/or put together the data into frames when testing them on the same machine or on a LAN (because the</span>
<span class="cm">latency is too low and it is thus harder to stress the connection).</span>

<span class="cm">In this case, what you can do to properly test them is to uncomment the comment block in AHKsock_Send, which will sometimes</span>
<span class="cm">purposely fail to send part of the data requested. This will allow you to simulate what could happen on a connection going</span>
<span class="cm">through the Internet. You may change the probability of failure by changing the number in the If statement.</span>

<span class="cm">If your application can still work after uncommenting the block, then it is a sign that it is properly handling frames split</span>
<span class="cm">across multiple RECEIVED events. This would also demonstrate your application&#39;s ability to cope with partially sent data.</span>
<span class="cm">*/</span>

<span class="o">/****************</span><span class="p">\</span>
<span class="w"> </span>Main<span class="w"> </span>functions<span class="w">  </span><span class="o">|</span>
<span class="w">               </span><span class="o">*/</span>

<span class="nf">AHKsock_Listen</span><span class="p">(</span>sPort<span class="p">,</span><span class="w"> </span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span>False<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Check if there is already a socket listening on this port</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sktListen<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetSocketFromNamePort&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">A_Space</span><span class="p">,</span><span class="w"> </span>sPort<span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check if we&#39;re stopping the listening</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span>sFunction<span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nf">AHKsock_Close</span><span class="p">(</span>sktListen<span class="p">)</span><span class="w"> </span><span class="c1">;Close the socket</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check if we&#39;re retrieving the current function</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;()&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check if it&#39;s a different function</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">))</span>
<span class="w">            </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetFunction&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">,</span><span class="w"> </span>sFunction<span class="p">)</span><span class="w"> </span><span class="c1">;Update it</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="c1">;We&#39;re done</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure we even have a function</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunction<span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">;sFunction is not a valid function.</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Startup<span class="p">())</span>
<span class="w">        </span><span class="nf">Return</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c1">;The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="w">                       </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="c1">;The Winsock DLL does not support version 2.2.</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Resolve the local address and port to be used by the server</span>
<span class="w">    </span><span class="nf">VarSetCapacity</span><span class="p">(</span>aiHints<span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_flags = AI_PASSIVE</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_family = AF_INET</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w">  </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_socktype = SOCK_STREAM</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_protocol = IPPROTO_TCP</span>
<span class="w">    </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\getaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>sPort<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>aiHints<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint*&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for error</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>iResult
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="c1">;The getaddrinfo() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span>sktListen<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="w"> </span><span class="c1">;INVALID_SOCKET</span>
<span class="w">    </span>sktListen<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\socket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>aiResult<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>aiResult<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
<span class="w">                                        </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">NumGet</span><span class="p">(</span>aiResult<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sktListen<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for INVALID_SOCKET</span>
<span class="w">        </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="c1">;The socket() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Setup the TCP listening socket</span>
<span class="w">    </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\bind&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>aiResult<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>aiResult<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for SOCKET_ERROR</span>
<span class="w">        </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ushort&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">)</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="c1">;The bind() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Add socket to array with A_Space for Name and IP to indicate that it&#39;s a listening socket</span>
<span class="w">    </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Add&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">,</span><span class="w"> </span><span class="nb">A_Space</span><span class="p">,</span><span class="w"> </span><span class="nb">A_Space</span><span class="p">,</span><span class="w"> </span>sPort<span class="p">,</span><span class="w"> </span>sFunction<span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;We must now actually register the socket</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span><span class="nf">AHKsock_RegisterAsyncSelect</span><span class="p">(</span>sktListen<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">)</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">)</span><span class="w"> </span><span class="c1">;Remove from array</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="c1">;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Start listening for incoming connections</span>
<span class="w">    </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\listen&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7FFFFFFF</span><span class="p">)</span><span class="w"> </span><span class="c1">;SOMAXCONN</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for SOCKET_ERROR</span>
<span class="w">        </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">)</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span><span class="w"> </span>sktListen<span class="p">)</span><span class="w"> </span><span class="c1">;Remove from array</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="c1">;The listen() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nf">AHKsock_Connect</span><span class="p">(</span>sName<span class="p">,</span><span class="w"> </span>sPort<span class="p">,</span><span class="w"> </span>sFunction<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>aiResult<span class="p">,</span><span class="w"> </span>iPointer<span class="p">,</span><span class="w"> </span>bProcessing<span class="p">,</span><span class="w"> </span>iMessage
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>sCurName<span class="p">,</span><span class="w"> </span>sCurPort<span class="p">,</span><span class="w"> </span>sCurFunction<span class="p">,</span><span class="w"> </span>sktConnect
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Check if it&#39;s just to inquire whether or not a call is possible</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>Not<span class="w"> </span>sName<span class="w"> </span><span class="kr">And</span><span class="w"> </span>Not<span class="w"> </span>sPort<span class="w"> </span><span class="kr">And</span><span class="w"> </span>Not<span class="w"> </span>sFunction<span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span>bProcessing
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Check if we&#39;re busy</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>bProcessing<span class="w"> </span><span class="nf">And</span><span class="w"> </span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">!=</span><span class="w"> </span>iMessage<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sCurName<span class="w"> </span><span class="nb">A_Tab</span><span class="w"> </span>sCurPort
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;AHKsock_Connect is still processing a connection attempt. ErrorLevel contains the name and the port,</span>
<span class="w">                 </span><span class="c1">;delimited by a tab.</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span>bProcessing<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;sFunction = iMessage. The connect operation has finished.</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check if it was successful</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sPort<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Close the socket that failed</span>
<span class="w">            </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Get the next pointer. ai_next</span>
<span class="w">            </span>iPointer<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Check if we reached the end of the linked structs</span>
<span class="w">            </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iPointer<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>
<span class="w">                </span><span class="c1">;We can now free the chain of addrinfo structs</span>
<span class="w">                </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="c1">;This is to ensure that the user can call AHKsock_Connect() right away upon receiving the message.</span>
<span class="w">                </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">                </span>
<span class="w">                </span><span class="c1">;Raise an error (can&#39;t use Return 1 because we were called asynchronously)</span>
<span class="w">                </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>i
<span class="w">                </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">;The connect() call failed. The error is in ErrorLevel.</span>
<span class="w">                </span>
<span class="w">                </span><span class="c1">;Call the function to signal that connection failed</span>
<span class="w">                </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sCurFunction<span class="p">)</span>
<span class="w">                    </span><span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>sCurName<span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>sCurPort<span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="k">Return</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Successful connection!</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Get the IP we successfully connected to</span>
<span class="w">            </span>sIP<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;str&quot;</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;We can now free the chain of ADDRINFO structs</span>
<span class="w">            </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Add socket to array</span>
<span class="w">            </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Add&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">,</span><span class="w"> </span>sCurName<span class="p">,</span><span class="w"> </span>sIP<span class="p">,</span><span class="w"> </span>sCurPort<span class="p">,</span><span class="w"> </span>sCurFunction<span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;This is to ensure that the user can call AHKsock_Connect() right away upon receiving the message.</span>
<span class="w">            </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Do this small bit in Critical so that AHKsock_AsyncSelect doesn&#39;t receive</span>
<span class="w">            </span><span class="c1">;any FD messages before we call the user function</span>
<span class="w">            </span><span class="k">Critical</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;We must now actually register the socket</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">AHKsock_RegisterAsyncSelect</span><span class="p">(</span>sktConnect<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">                </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">)</span>
<span class="w">                </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">)</span><span class="w"> </span><span class="c1">;Remove from array</span>
<span class="w">                </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">                </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="w">                </span>
<span class="w">                </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sCurFunction<span class="p">)</span><span class="w"> </span><span class="c1">;Call the function to signal that connection failed</span>
<span class="w">                    </span><span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>sCurName<span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>sCurPort<span class="p">)</span>
<span class="w">                </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sCurFunction<span class="p">)</span><span class="w"> </span><span class="c1">;Call the function to signal that connection was successful</span>
<span class="w">                </span><span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">,</span><span class="w"> </span>sCurName<span class="p">,</span><span class="w"> </span>sIP<span class="p">,</span><span class="w"> </span>sCurPort<span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">Return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;We were called</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Make sure we even have a function</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunction<span class="p">)</span>
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">;sFunction is not a valid function.</span>
<span class="w">        </span>
<span class="w">        </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>True<span class="w"> </span><span class="c1">;Block future calls to AHKsock_Connect() until we&#39;re done</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Keep the values</span>
<span class="w">        </span>sCurName<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sName
<span class="w">        </span>sCurPort<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sPort
<span class="w">        </span>sCurFunction<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sFunction
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Make sure Winsock has been started up</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Startup<span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">            </span><span class="nf">Return</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c1">;The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="w">                           </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="c1">;The Winsock DLL does not support version 2.2.</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Resolve the server address and port    </span>
<span class="w">        </span><span class="nf">VarSetCapacity</span><span class="p">(</span>aiHints<span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_family = AF_INET</span>
<span class="w">        </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w">  </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_socktype = SOCK_STREAM</span>
<span class="w">        </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_protocol = IPPROTO_TCP</span>
<span class="w">        </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\getaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>sName<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>sPort<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>aiHints<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint*&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for error</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>iResult
<span class="w">            </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="c1">;The getaddrinfo() call failed. The error is in ErrorLevel.</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Start with the first struct</span>
<span class="w">        </span>iPointer<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aiResult
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Create a SOCKET for connecting to server</span>
<span class="w">    </span>sktConnect<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\socket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
<span class="w">                                         </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="nf">NumGet</span><span class="p">(</span>iPointer<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sktConnect<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for INVALID_SOCKET</span>
<span class="w">        </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">        </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span>iMessage<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check if we were called asynchronously</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">;The socket() call failed. The error is in ErrorLevel.</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Call the function to signal that connection failed</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sCurFunction<span class="p">)</span>
<span class="w">                </span><span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="c1">;The socket() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Register the socket to know when the connect() function is done. FD_CONNECT = 16</span>
<span class="w">    </span>iMessage<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Settings<span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span><span class="nf">AHKsock_RegisterAsyncSelect</span><span class="p">(</span>sktConnect<span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AHKsock_Connect&quot;</span><span class="p">,</span><span class="w"> </span>iMessage<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">)</span>
<span class="w">        </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span>iMessage<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check if we were called asynchronously</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="c1">;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Call the function to signal that connection failed</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sCurFunction<span class="p">)</span>
<span class="w">                </span><span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="c1">;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Connect to server</span>
<span class="w">    </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\connect&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="nf">Or</span><span class="w"> </span><span class="p">((</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">And</span><span class="w"> </span><span class="p">(</span>AHKsock_LastError<span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">10035</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for any error other than WSAEWOULDBLOCK</span>
<span class="w">        </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sktConnect<span class="p">)</span>
<span class="w">        </span>bProcessing<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span>iMessage<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check if we were called asynchronously</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="c1">;The connect() call failed. The error is in ErrorLevel.</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Call the function to signal that connection failed</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sCurFunction<span class="p">)</span>
<span class="w">                </span><span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="c1">;The connect() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nf">AHKsock_Send</span><span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span>ptrData<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>iLength<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure the socket is on record. Fail-safe</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span><span class="w"> </span><span class="c1">;The socket specified in iSocket is not a recognized socket.</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Startup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c1">;WSAStartup hasn&#39;t been called yet.</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure the socket is cleared for sending</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSend&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span><span class="w"> </span><span class="c1">;The socket specified in iSocket is not cleared for sending.</span>
<span class="w">    </span>
<span class="w">    </span><span class="o">/*!</span><span class="w"> </span>Uncomment<span class="w"> </span>this<span class="w"> </span>block<span class="w"> </span>to<span class="w"> </span>simulate<span class="w"> </span>the<span class="w"> </span>possibility<span class="w"> </span>of<span class="w"> </span>an<span class="w"> </span>incomplete<span class="w"> </span>send<span class="p">()</span>
<span class="w">    </span><span class="k">Random</span><span class="p">,</span><span class="w"> </span>iRand<span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iRand<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Probability of failure of 30%</span>
<span class="w">        </span><span class="k">Random</span><span class="p">,</span><span class="w"> </span>iRand<span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>iLength<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;Randomize how much of the data will not be sent</span>
<span class="w">        </span>iLength<span class="w"> </span><span class="o">-=</span><span class="w"> </span>iRand
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*/</span>
<span class="w">    </span>
<span class="w">    </span>iSendResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\send&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">,</span><span class="w"> </span><span class="s">&quot;char&quot;</span><span class="p">,</span><span class="w"> </span>ptrData<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>iLength<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSendResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">And</span><span class="w"> </span><span class="p">((</span>iErr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_LastError<span class="p">())</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10035</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetSend&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">,</span><span class="w"> </span>False<span class="p">)</span><span class="w"> </span><span class="c1">;Update socket&#39;s send status</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="c1">;Calling send() would have blocked the thread. Try again once you get the proper update.</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSendResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>iErr
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="w"> </span><span class="c1">;The send() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span>iSendResult<span class="w"> </span><span class="c1">;The send() operation was successful</span>
<span class="p">}</span>

<span class="nf">AHKsock_ForceSend</span><span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span>ptrData<span class="p">,</span><span class="w"> </span>iLength<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Startup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c1">;WSAStartup hasn&#39;t been called yet</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure the socket is on record. Fail-safe</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure that we&#39;re not in Critical, or we won&#39;t be able to wait for FD_WRITE messages</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span><span class="nb">A_IsCritical</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">5</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Extra precaution to make sure FD_WRITE messages can make it</span>
<span class="w">    </span><span class="k">Thread</span><span class="p">,</span><span class="w"> </span>Priority<span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;We need to make sure not to fill up the send buffer in one call, or we&#39;ll get a performance hit.</span>
<span class="w">    </span><span class="c1">;http://support.microsoft.com/kb/823764</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Get the socket&#39;s send buffer size</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">((</span>iMaxChunk<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_SockOpt<span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span><span class="s">&quot;SO_SNDBUF&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">6</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Check if we&#39;ll be sending in chunks or not</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iMaxChunk<span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;We&#39;ll be sending as much as possible everytime!</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">Loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Keep sending the data until we&#39;re done or until an error occurs</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Wait until we can send data (ie. when FD_WRITE arrives)</span>
<span class="w">            </span><span class="k">While</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSend&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">                </span><span class="k">Sleep</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">Loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Keep sending the data until we get WSAEWOULDBLOCK or until an error occurs</span>
<span class="w">                </span><span class="nf">If</span><span class="w"> </span><span class="p">((</span>iSendResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Send<span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span>ptrData<span class="p">,</span><span class="w"> </span>iLength<span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSendResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">                        </span><span class="k">Break</span><span class="w"> </span><span class="c1">;Calling send() would have blocked the thread. Break the loop and we&#39;ll try again after we</span>
<span class="w">                              </span><span class="c1">;receive FD_WRITE</span>
<span class="w">                    </span><span class="k">Else</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span>iSendResult<span class="w"> </span><span class="c1">;Something bad happened with AHKsock_Send. Return the same value we got.</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span>
<span class="w">                    </span><span class="c1">;AHKsock_Send was able to send bytes. Let&#39;s check if it sent only part of what we requested</span>
<span class="w">                    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSendResult<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>iLength<span class="p">)</span><span class="w"> </span><span class="c1">;Move the offset up by what we were able to send</span>
<span class="w">                        </span>ptrData<span class="w"> </span><span class="o">+=</span><span class="w"> </span>iSendResult<span class="p">,</span><span class="w"> </span>iLength<span class="w"> </span><span class="o">-=</span><span class="w"> </span>iSendResult
<span class="w">                    </span><span class="k">Else</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span><span class="c1">;We&#39;re done sending all the data</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;We&#39;ll be sending in chunks of just under the send buffer size to avoid the performance hit</span>
<span class="w">        </span>
<span class="w">        </span>iMaxChunk<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;Reduce by 1 to be smaller than the send buffer</span>
<span class="w">        </span><span class="k">Loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Keep sending the data until we&#39;re done or until an error occurs</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Wait until we can send data (ie. when FD_WRITE arrives)</span>
<span class="w">            </span><span class="k">While</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSend&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">                </span><span class="k">Sleep</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Check if we have less than the max chunk to send</span>
<span class="w">            </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iLength<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>iMaxChunk<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>
<span class="w">                </span><span class="k">Loop</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Keep sending the data until we get WSAEWOULDBLOCK or until an error occurs</span>
<span class="w">                    </span><span class="c1">;Send using the traditional offset method</span>
<span class="w">                    </span><span class="nf">If</span><span class="w"> </span><span class="p">((</span>iSendResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Send<span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span>ptrData<span class="p">,</span><span class="w"> </span>iLength<span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSendResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">                            </span><span class="k">Break</span><span class="w"> </span><span class="c1">;Calling send() would have blocked the thread. Break the loop and we&#39;ll try again after we</span>
<span class="w">                                  </span><span class="c1">;receive FD_WRITE</span>
<span class="w">                        </span><span class="k">Else</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span>iSendResult<span class="w"> </span><span class="c1">;Something bad happened with AHKsock_Send. Return the same value we got.</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span>
<span class="w">                        </span><span class="c1">;AHKsock_Send was able to send bytes. Let&#39;s check if it sent only part of what we requested</span>
<span class="w">                        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSendResult<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>iLength<span class="p">)</span><span class="w"> </span><span class="c1">;Move the offset up by what we were able to send</span>
<span class="w">                            </span>ptrData<span class="w"> </span><span class="o">+=</span><span class="w"> </span>iSendResult<span class="p">,</span><span class="w"> </span>iLength<span class="w"> </span><span class="o">-=</span><span class="w"> </span>iSendResult
<span class="w">                        </span><span class="k">Else</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span><span class="c1">;We&#39;re done sending all the data</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>
<span class="w">                </span><span class="c1">;Send up to max chunk</span>
<span class="w">                </span><span class="nf">If</span><span class="w"> </span><span class="p">((</span>iSendResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Send<span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span>ptrData<span class="p">,</span><span class="w"> </span>iMaxChunk<span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSendResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">                        </span><span class="k">Continue</span><span class="w"> </span><span class="c1">;Calling send() would have blocked the thread. Continue the loop and we&#39;ll try again after</span>
<span class="w">                                 </span><span class="c1">;we receive FD_WRITE</span>
<span class="w">                    </span><span class="k">Else</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span>iSendResult<span class="w"> </span><span class="c1">;Something bad happened with AHKsock_Send. Return the same value we got.</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span>ptrData<span class="w"> </span><span class="o">+=</span><span class="w"> </span>iSendResult<span class="p">,</span><span class="w"> </span>iLength<span class="w"> </span><span class="o">-=</span><span class="w"> </span>iSendResult<span class="w"> </span><span class="c1">;Move up offset by updating the pointer and length</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nf">AHKsock_Close</span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>iTimeout<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Startup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="c1">;There&#39;s nothing to close</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;We need to close all the sockets</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check if we even have sockets to close</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSACleanup&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="nf">AHKsock_Startup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;Reset the value to show that we&#39;ve turned off Winsock</span>
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="c1">;We&#39;re done!</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Take the current time (needed for time-outing)</span>
<span class="w">        </span>iStartClose<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">A_TickCount</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">Loop</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>AHKsock_Sockets<span class="p">()</span><span class="w"> </span><span class="c1">;Close all sockets and cleanup</span>
<span class="w">            </span><span class="nf">AHKsock_ShutdownSocket</span><span class="p">(</span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetSocketFromIndex&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">A_Index</span><span class="p">))</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check if we&#39;re in the OnExit subroutine</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nb">A_ExitReason</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>
<span class="w">            </span><span class="nb">A_IsCriticalOld</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">A_IsCritical</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Make sure we can still receive FD_CLOSE msgs</span>
<span class="w">            </span><span class="k">Critical</span><span class="p">,</span><span class="w"> </span>Off
<span class="w">            </span><span class="k">Thread</span><span class="p">,</span><span class="w"> </span>Priority<span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;We can try a graceful shutdown or wait for a timeout</span>
<span class="w">            </span><span class="nf">While</span><span class="w"> </span><span class="p">(</span>AHKsock_Sockets<span class="p">())</span><span class="w"> </span><span class="nf">And</span><span class="w"> </span><span class="p">(</span><span class="nb">A_TickCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>iStartClose<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>iTimeout<span class="p">)</span>
<span class="w">                </span><span class="k">Sleep</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Restore previous Critical</span>
<span class="w">            </span><span class="k">Critical</span><span class="p">,</span><span class="w"> </span><span class="nv">%A_IsCriticalOld%</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="o">/*!</span><span class="w"> </span>Used<span class="w"> </span>for<span class="w"> </span>debugging<span class="w"> </span>purposes<span class="w"> </span>only
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="k">OutputDebug</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;Cleaning up now, with the socket &quot;</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetSocketFromIndex&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="s">&quot; remaining...&quot;</span>
<span class="w">            </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">OutputDebug</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;Cleaning up now, with the following sockets remaining:&quot;</span>
<span class="w">                </span><span class="k">Loop</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>AHKsock_Sockets<span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">OutputDebug</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetSocketFromIndex&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">A_Index</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="o">*/</span>
<span class="w">        </span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSACleanup&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nf">AHKsock_Startup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;Reset the value to show that we&#39;ve turned off Winsock</span>
<span class="w">        </span>
<span class="w">    </span><span class="c1">;Close only one socket</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span><span class="nf">AHKsock_ShutdownSocket</span><span class="p">(</span>iSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Error-checking</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;The shutdown() call failed. The error is in ErrorLevel.</span>
<span class="p">}</span>

<span class="nf">AHKsock_GetAddrInfo</span><span class="p">(</span>sHostName<span class="p">,</span><span class="w"> </span>ByRef<span class="w"> </span>sIPList<span class="p">,</span><span class="w"> </span>bOne<span class="w"> </span><span class="o">=</span><span class="w"> </span>False<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Startup<span class="p">())</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span>i<span class="w"> </span><span class="c1">;Return the same error (error 1 and 2)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Resolve the address and port    </span>
<span class="w">    </span><span class="nf">VarSetCapacity</span><span class="p">(</span>aiHints<span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_family = AF_INET</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w">  </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_socktype = SOCK_STREAM</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span>aiHints<span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_protocol = IPPROTO_TCP</span>
<span class="w">    </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\getaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>sHostName<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>aiHints<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint*&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11001</span><span class="p">)</span><span class="w"> </span><span class="c1">;Check specifically for WSAHOST_NOT_FOUND since it&#39;s the most common error</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c1">;Received WSAHOST_NOT_FOUND. No such host is known.</span>
<span class="w">    </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for any other error</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>iResult
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="c1">;The getaddrinfo() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>bOne
<span class="w">        </span>sIPList<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>NumGet<span class="p">(</span>aiResult<span class="o">+</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;str&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Start with the first addrinfo struct</span>
<span class="w">        </span>iPointer<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aiResult<span class="p">,</span><span class="w"> </span>sIPList<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">        </span><span class="k">While</span><span class="w"> </span>iPointer<span class="w"> </span><span class="p">{</span>
<span class="w">            </span>s<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;str&quot;</span><span class="p">)</span>
<span class="w">            </span>iPointer<span class="w"> </span><span class="o">:=</span><span class="w"> </span>NumGet<span class="p">(</span>iPointer<span class="o">+</span><span class="mi">28</span><span class="p">)</span><span class="w"> </span><span class="c1">;Go to the next addrinfo struct</span>
<span class="w">            </span>sIPList<span class="w"> </span><span class="p">.</span><span class="o">=</span><span class="w">  </span>s<span class="w"> </span><span class="p">(</span>iPointer<span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;</span><span class="se">`n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;Add newline only if it&#39;s not the last one</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;We&#39;re done</span>
<span class="w">    </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>aiResult<span class="p">)</span>
<span class="p">}</span>

<span class="nf">AHKsock_GetNameInfo</span><span class="p">(</span>sIP<span class="p">,</span><span class="w"> </span>ByRef<span class="w"> </span>sHostName<span class="p">,</span><span class="w"> </span>sPort<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>ByRef<span class="w"> </span>sService<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Startup<span class="p">())</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span>i<span class="w"> </span><span class="c1">;Return the same error (error 1 and 2)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Translate to IN_ADDR</span>
<span class="w">    </span>iIP<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\inet_addr&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>sIP<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iIP<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>iIP<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="p">)</span><span class="w"> </span><span class="c1">;Check for INADDR_NONE or INADDR_ANY</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c1">;The IP address supplied in sIP is invalid.</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Construct a sockaddr struct</span>
<span class="w">    </span><span class="nf">VarSetCapacity</span><span class="p">(</span>tSockAddr<span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span>tSockAddr<span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;short&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;ai_family = AF_INET</span>
<span class="w">    </span><span class="nf">NumPut</span><span class="p">(</span>iIP<span class="p">,</span><span class="w"> </span>tSockAddr<span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="c1">;Put in the IN_ADDR</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Fill in the port field if we&#39;re also looking up the service name</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>sPort<span class="w">           </span><span class="c1">;Translate to network byte order</span>
<span class="w">        </span><span class="nf">NumPut</span><span class="p">(</span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\htons&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ushort&quot;</span><span class="p">,</span><span class="w"> </span>sPort<span class="p">),</span><span class="w"> </span>tSockAddr<span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ushort&quot;</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Prep vars</span>
<span class="w">    </span><span class="nf">VarSetCapacity</span><span class="p">(</span>sHostName<span class="p">,</span><span class="w"> </span><span class="mi">1025</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">;NI_MAXHOST</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>sPort
<span class="w">        </span><span class="nf">VarSetCapacity</span><span class="p">(</span>sService<span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">;NI_MAXSERV</span>
<span class="w">    </span>
<span class="w">    </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\getnameinfo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>tSockAddr<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;str&quot;</span><span class="p">,</span><span class="w"> </span>sHostName<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1025</span>
<span class="w">                                           </span><span class="p">,</span><span class="w"> </span>sPort<span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;str&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>sPort<span class="w"> </span><span class="o">?</span><span class="w"> </span>sService<span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\WSAGetLastError&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="c1">;The getnameinfo() call failed. The error is in ErrorLevel.</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nf">AHKsock_SockOpt</span><span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span>sOption<span class="p">,</span><span class="w"> </span>iValue<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Prep variable</span>
<span class="w">    </span><span class="nf">VarSetCapacity</span><span class="p">(</span>iOptVal<span class="p">,</span><span class="w"> </span>iOptValLength<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iValue<span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nf">NumPut</span><span class="p">(</span>iValue<span class="p">,</span><span class="w"> </span>iOptVal<span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sOption<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SO_KEEPALIVE&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>intLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="w"> </span><span class="c1">;SOL_SOCKET</span>
<span class="w">        </span>intOptName<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x0008</span><span class="w"> </span><span class="c1">;SO_KEEPALIVE</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sOption<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SO_SNDBUF&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>intLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="w"> </span><span class="c1">;SOL_SOCKET</span>
<span class="w">        </span>intOptName<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x1001</span><span class="w"> </span><span class="c1">;SO_SNDBUF</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sOption<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SO_RCVBUF&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>intLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="w"> </span><span class="c1">;SOL_SOCKET</span>
<span class="w">        </span>intOptName<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x1002</span><span class="w"> </span><span class="c1">;SO_SNDBUF</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sOption<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;TCP_NODELAY&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>intLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="c1">;IPPROTO_TCP</span>
<span class="w">        </span>intOptName<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x0001</span><span class="w"> </span><span class="c1">;TCP_NODELAY</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Check if we&#39;re getting or setting</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iValue<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\getsockopt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>intLevel<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>intOptName
<span class="w">                                              </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint*&quot;</span><span class="p">,</span><span class="w">  </span>iOptVal<span class="p">,</span><span class="w"> </span><span class="s">&quot;int*&quot;</span><span class="p">,</span><span class="w"> </span>iOptValLength<span class="p">)</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for SOCKET_ERROR</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="k">Return</span><span class="w"> </span>iOptVal
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\setsockopt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>intLevel<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>intOptName
<span class="w">                                              </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span>iOptVal<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w">  </span>iOptValLength<span class="p">)</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for SOCKET_ERROR</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="o">-</span><span class="mi">2</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="o">/*******************</span><span class="p">\</span>
<span class="w"> </span>Support<span class="w"> </span>functions<span class="w">  </span><span class="o">|</span>
<span class="w">                  </span><span class="o">*/</span>

<span class="nf">AHKsock_Startup</span><span class="p">(</span>iMode<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>bAlreadyStarted
<span class="w">    </span>
<span class="w">    </span><span class="o">/*</span>
<span class="w">    </span>iMode<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">;Turns on WSAStartup()</span>
<span class="w">    </span>iMode<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;Returns whether or not WSAStartup has been called</span>
<span class="w">    </span>iMode<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="c1">;Resets the static variable to force another call next time iMode = 0</span>
<span class="w">    </span><span class="o">*/</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iMode<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span>bAlreadyStarted<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">    </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iMode<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span>bAlreadyStarted
<span class="w">    </span><span class="k">Else</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span>bAlreadyStarted<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;iMode = 0. Call the function only if it hasn&#39;t already been called.</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Start it up - request version 2.2</span>
<span class="w">        </span><span class="nf">VarSetCapacity</span><span class="p">(</span>wsaData<span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\WSAStartup&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ushort&quot;</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0202</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>wsaData<span class="p">)</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>iResult
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Make sure the Winsock DLL supports at least version 2.2</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>NumGet<span class="p">(</span>wsaData<span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ushort&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x0202</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSACleanup&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">;Abort</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;The Winsock DLL does not support version 2.2.&quot;</span>
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span>bAlreadyStarted<span class="w"> </span><span class="o">:=</span><span class="w"> </span>True
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nf">AHKsock_ShutdownSocket</span><span class="p">(</span>iSocket<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Check if it&#39;s a listening socket</span>
<span class="w">    </span>sName<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sName<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">A_Space</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;It&#39;s not a listening socket. Shutdown send operations.</span>
<span class="w">        </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\shutdown&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">;SD_SEND</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span>
<span class="w">            </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">            </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">            </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Mark it</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetShutdown&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span><span class="w"> </span><span class="c1">;It&#39;s only a listening socket</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Remove it from the array</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="o">/***********************</span><span class="p">\</span>
<span class="w"> </span>AsyncSelect<span class="w"> </span>functions<span class="w">  </span><span class="o">|</span>
<span class="w">                      </span><span class="o">*/</span>
<span class="w">                                     </span><span class="c1">;FD_READ | FD_WRITE | FD_ACCEPT | FD_CLOSE</span>
<span class="nf">AHKsock_RegisterAsyncSelect</span><span class="p">(</span>iSocket<span class="p">,</span><span class="w"> </span>fFlags<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">43</span><span class="p">,</span><span class="w"> </span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AHKsock_AsyncSelect&quot;</span><span class="p">,</span><span class="w"> </span>iMsg<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>hGui<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">    </span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span>hGui<span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">Gui</span><span class="p">,</span><span class="w"> </span><span class="o">+</span>LastFound
<span class="w">        </span>hGui<span class="w"> </span><span class="o">:=</span><span class="w"> </span>WinExist<span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span>iMsg<span class="w"> </span><span class="o">:=</span><span class="w"> </span>iMsg<span class="w"> </span><span class="o">?</span><span class="w"> </span>iMsg<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_Settings<span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>OnMessage<span class="p">(</span>iMsg<span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span>sFunction<span class="p">)</span>
<span class="w">        </span><span class="nf">OnMessage</span><span class="p">(</span>iMsg<span class="p">,</span><span class="w"> </span>sFunction<span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\WSAAsyncSelect&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>hGui<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>iMsg<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>fFlags<span class="p">)</span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for SOCKET_ERROR</span>
<span class="w">        </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nf">AHKsock_AsyncSelect</span><span class="p">(</span>wParam<span class="p">,</span><span class="w"> </span>lParam<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">Critical</span><span class="w"> </span><span class="c1">;So that messages are buffered</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;wParam parameter identifies the socket on which a network event has occurred</span>
<span class="w">    </span><span class="c1">;The low word of lParam specifies the network event that has occurred.</span>
<span class="w">    </span><span class="c1">;The high word of lParam contains any error code</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Make sure the socket is on record. Fail-safe</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span><span class="k">Return</span>
<span class="w">    </span>
<span class="w">    </span>iEvent<span class="w"> </span><span class="o">:=</span><span class="w"> </span>lParam<span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="p">,</span><span class="w"> </span>iErrorCode<span class="w"> </span><span class="o">:=</span><span class="w"> </span>lParam<span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span>
<span class="w">    </span>
<span class="w">    </span><span class="o">/*!</span><span class="w"> </span>Used<span class="w"> </span>for<span class="w"> </span>debugging<span class="w"> </span>purposes
<span class="w">    </span><span class="k">OutputDebug</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;AsyncSelect - A network event &quot;</span><span class="w"> </span>iEvent<span class="w"> </span><span class="s">&quot; has occurred on socket &quot;</span><span class="w"> </span>wParam
<span class="w">    </span><span class="kr">If</span><span class="w"> </span>iErrorCode
<span class="w">        </span><span class="k">OutputDebug</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="s">&quot;AsyncSelect - Error code = &quot;</span><span class="w"> </span>iErrorCode
<span class="w">    </span><span class="o">*/</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iEvent<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;FD_READ</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check for error</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>iErrorCode<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;WSAENETDOWN is the only possible</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>iErrorCode
<span class="w">            </span><span class="c1">;FD_READ event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">            </span><span class="k">Return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="nf">VarSetCapacity</span><span class="p">(</span>bufReceived<span class="p">,</span><span class="w"> </span>bufReceivedLength<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Settings<span class="p">(</span><span class="s">&quot;Buffer&quot;</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\recv&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span><span class="s">&quot;char&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>bufReceived<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span>bufReceivedLength<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;We received data!</span>
<span class="w">            </span><span class="nf">VarSetCapacity</span><span class="p">(</span>bufReceived<span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">;Update the internal length</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Get associated function and call it</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunc<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">))</span>
<span class="w">                </span><span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;RECEIVED&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">                                          </span><span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">                                          </span><span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">),</span><span class="w"> </span>bufReceived<span class="p">,</span><span class="w"> </span>iResult<span class="p">)</span>
<span class="w">            </span>
<span class="w">        </span><span class="c1">;Check for error other than WSAEWOULDBLOCK</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="kr">If</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="nf">Or</span><span class="w"> </span><span class="p">((</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">And</span><span class="w"> </span>Not<span class="w"> </span><span class="p">((</span>iErrorCode<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_LastError<span class="p">())</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10035</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>iErrorCode
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span><span class="w"> </span><span class="c1">;The recv() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="w">            </span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="c1">;So that if it&#39;s a spoofed call from FD_CLOSE, we exit the loop and close the socket</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Here, we bother with returning a value in case it&#39;s a spoofed call from FD_CLOSE</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span>iResult
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iEvent<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;FD_WRITE</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check for error</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>iErrorCode<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;WSAENETDOWN is the only possible</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>iErrorCode
<span class="w">            </span><span class="c1">;FD_WRITE event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">            </span><span class="k">Return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Update socket&#39;s setting</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetSend&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span>True<span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Make sure the socket isn&#39;t already shut down</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetShutdown&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunc<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">))</span>
<span class="w">                </span><span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;SEND&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">                                      </span><span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">                                      </span><span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">))</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iEvent<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;FD_ACCEPT</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check for error</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>iErrorCode<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;WSAENETDOWN is the only possible</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>iErrorCode
<span class="w">            </span><span class="c1">;FD_ACCEPT event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">            </span><span class="k">Return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;We need to accept the connection</span>
<span class="w">        </span><span class="nf">VarSetCapacity</span><span class="p">(</span>tSockAddr<span class="p">,</span><span class="w"> </span>tSockAddrLength<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span>sktClient<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\accept&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span>tSockAddr<span class="p">,</span><span class="w"> </span><span class="s">&quot;int*&quot;</span><span class="p">,</span><span class="w"> </span>tSockAddrLength<span class="p">)</span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sktClient<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">And</span><span class="w"> </span><span class="p">((</span>iErrorCode<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_LastError<span class="p">())</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10035</span><span class="p">)</span><span class="w"> </span><span class="c1">;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">            </span><span class="k">Return</span><span class="w"> </span><span class="c1">;We&#39;ll be called again next time we can retry accept()</span>
<span class="w">        </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sktClient<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for INVALID_SOCKET</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>iErrorCode
<span class="w">            </span><span class="c1">;The accept() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">            </span><span class="k">Return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Add to array</span>
<span class="w">        </span>sName<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">        </span>sAddr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>NumGet<span class="p">(</span>tSockAddr<span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;str&quot;</span><span class="p">)</span>
<span class="w">        </span>sPort<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span>sFunc<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Add&quot;</span><span class="p">,</span><span class="w"> </span>sktClient<span class="p">,</span><span class="w"> </span>sName<span class="p">,</span><span class="w"> </span>sAddr<span class="p">,</span><span class="w"> </span>sPort<span class="p">,</span><span class="w"> </span>sFunc<span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Go back to listening</span>
<span class="w">        </span>iResult<span class="w"> </span><span class="o">:=</span><span class="w"> </span>DllCall<span class="p">(</span><span class="s">&quot;Ws2_32\listen&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7FFFFFFF</span><span class="p">)</span><span class="w"> </span><span class="c1">;SOMAXCONN       </span>
<span class="w">        </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iResult<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">Or</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Check for SOCKET_ERROR</span>
<span class="w">            </span>sErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">?</span><span class="w"> </span>ErrorLevel<span class="w"> </span><span class="o">:</span><span class="w"> </span>AHKsock_LastError<span class="p">()</span>
<span class="w">            </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">            </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span><span class="w"> </span><span class="c1">;Remove from array</span>
<span class="w">            </span>ErrorLevel<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sErrorLevel
<span class="w">            </span><span class="c1">;The listen() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="w">            </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">            </span><span class="k">Return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Get associated function and call it</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunc<span class="p">)</span>
<span class="w">            </span><span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;ACCEPTED&quot;</span><span class="p">,</span><span class="w"> </span>sktClient<span class="p">,</span><span class="w"> </span>sName<span class="p">,</span><span class="w"> </span>sAddr<span class="p">,</span><span class="w"> </span>sPort<span class="p">)</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>iEvent<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;FD_CLOSE</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Keep receiving data before closing the socket by spoofing an FD_READ event to call recv()</span>
<span class="w">        </span><span class="nf">While</span><span class="w"> </span><span class="p">(</span>AHKsock_AsyncSelect<span class="p">(</span>wParam<span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">Sleep</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Check if we initiated it</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetShutdown&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Last chance to send data. Get associated function and call it.</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunc<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">))</span>
<span class="w">                </span><span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;SENDLAST&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">                                          </span><span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">                                          </span><span class="p">,</span><span class="w"> </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">))</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">;Shutdown the socket. This is to attempt a graceful shutdown</span>
<span class="w">            </span><span class="kr">If</span><span class="w"> </span><span class="nf">AHKsock_ShutdownSocket</span><span class="p">(</span>wParam<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">;The shutdown() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="w">                </span><span class="nf">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">                </span><span class="k">Return</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;We just have to close the socket then</span>
<span class="w">        </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uint&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;Get associated data before deleting</span>
<span class="w">        </span>sFunc<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span>sName<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span>sAddr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span>sPort<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;We can remove it from the array</span>
<span class="w">        </span><span class="nf">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunc<span class="p">)</span>
<span class="w">            </span><span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;DISCONNECTED&quot;</span><span class="p">,</span><span class="w"> </span>wParam<span class="p">,</span><span class="w"> </span>sName<span class="p">,</span><span class="w"> </span>sAddr<span class="p">,</span><span class="w"> </span>sPort<span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="o">/******************</span><span class="p">\</span>
<span class="w"> </span>Array<span class="w"> </span>controller<span class="w">  </span><span class="o">|</span>
<span class="w">                 </span><span class="o">*/</span>

<span class="nf">AHKsock_Sockets</span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Count&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span>sName<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span>sAddr<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span>sPort<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">Static</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>aSockets0<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>iLastSocket<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xFFFFFFFF</span><span class="w"> </span><span class="c1">;Cache to lessen index lookups on the same socket</span>
<span class="w">    </span><span class="kt">Local</span><span class="w"> </span>i<span class="p">,</span><span class="w"> </span>ret
<span class="w">    </span>
<span class="w">    </span><span class="nb">A_IsCriticalOld</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">A_IsCritical</span>
<span class="w">    </span><span class="k">Critical</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Count&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets0
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Add&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>aSockets0<span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;Expand array</span>
<span class="w">        </span>aSockets<span class="nv">%aSockets0%</span>_Sock<span class="w"> </span><span class="o">:=</span><span class="w"> </span>iSocket
<span class="w">        </span>aSockets<span class="nv">%aSockets0%</span>_Name<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sName
<span class="w">        </span>aSockets<span class="nv">%aSockets0%</span>_Addr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sAddr
<span class="w">        </span>aSockets<span class="nv">%aSockets0%</span>_Port<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sPort
<span class="w">        </span>aSockets<span class="nv">%aSockets0%</span>_Func<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sFunction
<span class="w">        </span>aSockets<span class="nv">%aSockets0%</span>_Shutdown<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">        </span>aSockets<span class="nv">%aSockets0%</span>_Send<span class="w"> </span><span class="o">:=</span><span class="w"> </span>False
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Delete&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">;First we need the index</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>i<span class="w"> </span><span class="p">{</span>
<span class="w">            </span>iLastSocket<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0xFFFF</span><span class="w"> </span><span class="c1">;Clear cache</span>
<span class="w">            </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>i<span class="w"> </span><span class="o">&lt;</span><span class="w"> </span>aSockets0<span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">;Let the last item overwrite this one</span>
<span class="w">                </span>aSockets<span class="nv">%i%</span>_Sock<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%aSockets0%</span>_Sock
<span class="w">                </span>aSockets<span class="nv">%i%</span>_Name<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%aSockets0%</span>_Name
<span class="w">                </span>aSockets<span class="nv">%i%</span>_Addr<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%aSockets0%</span>_Addr
<span class="w">                </span>aSockets<span class="nv">%i%</span>_Port<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%aSockets0%</span>_Port
<span class="w">                </span>aSockets<span class="nv">%i%</span>_Func<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%aSockets0%</span>_Func
<span class="w">                </span>aSockets<span class="nv">%i%</span>_Shutdown<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%aSockets0%</span>_Shutdown
<span class="w">                </span>aSockets<span class="nv">%i%</span>_Send<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%aSockets0%</span>_Send
<span class="w">                </span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>aSockets0<span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">;Remove element</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetName&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%i%</span>_Name
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetAddr&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%i%</span>_Addr
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetPort&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%i%</span>_Port
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetFunction&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%i%</span>_Func
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SetFunction&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>aSockets<span class="nv">%i%</span>_Func<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sName
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetSend&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%i%</span>_Send
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SetSend&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>aSockets<span class="nv">%i%</span>_Send<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sName
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetShutdown&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%i%</span>_Shutdown
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SetShutdown&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>i<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span>iLastSocket<span class="p">)</span><span class="w"> </span><span class="c1">;Check cache</span>
<span class="w">        </span><span class="o">?</span><span class="w"> </span>iLastSocketIndex
<span class="w">        </span><span class="o">:</span><span class="w"> </span>AHKsock_Sockets<span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">        </span>aSockets<span class="nv">%i%</span>_Shutdown<span class="w"> </span><span class="o">:=</span><span class="w"> </span>True
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetSocketFromNamePort&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">Loop</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>aSockets0<span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>aSockets<span class="nv">%A_Index%</span>_Name<span class="w"> </span><span class="o">=</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="w">            </span><span class="nf">And</span><span class="w"> </span><span class="p">(</span>aSockets<span class="nv">%A_Index%</span>_Port<span class="w"> </span><span class="o">=</span><span class="w"> </span>sName<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%A_Index%</span>_Sock
<span class="w">                </span><span class="k">Break</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GetSocketFromIndex&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span>aSockets<span class="nv">%iSocket%</span>_Sock
<span class="w">    </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sAction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Index&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">Loop</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>aSockets0<span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>aSockets<span class="nv">%A_Index%</span>_Sock<span class="w"> </span><span class="o">=</span><span class="w"> </span>iSocket<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span>iLastSocketIndex<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">A_Index</span><span class="p">,</span><span class="w"> </span>iLastSocket<span class="w"> </span><span class="o">:=</span><span class="w"> </span>iSocket
<span class="w">                </span>ret<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">A_Index</span>
<span class="w">                </span><span class="k">Break</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">;Restore old Critical setting</span>
<span class="w">    </span><span class="k">Critical</span><span class="w"> </span><span class="nv">%A_IsCriticalOld%</span>
<span class="w">    </span><span class="k">Return</span><span class="w"> </span>ret
<span class="p">}</span>

<span class="o">/*****************</span><span class="p">\</span>
<span class="w"> </span>Error<span class="w"> </span>Functions<span class="w">  </span><span class="o">|</span>
<span class="w">                </span><span class="o">*/</span>

<span class="nf">AHKsock_LastError</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">Return</span><span class="w"> </span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSAGetLastError&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">AHKsock_ErrorHandler</span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>sCurrentFunction
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sFunction<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">Return</span><span class="w"> </span>sCurrentFunction
<span class="w">    </span><span class="k">Else</span><span class="w"> </span>sCurrentFunction<span class="w"> </span><span class="o">:=</span><span class="w"> </span>sFunction
<span class="p">}</span>

<span class="nf">AHKsock_RaiseError</span><span class="p">(</span>iError<span class="p">,</span><span class="w"> </span>iSocket<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">If</span><span class="w"> </span><span class="nf">IsFunc</span><span class="p">(</span>sFunc<span class="w"> </span><span class="o">:=</span><span class="w"> </span>AHKsock_ErrorHandler<span class="p">())</span>
<span class="w">        </span><span class="nv">%sFunc%</span><span class="p">(</span>iError<span class="p">,</span><span class="w"> </span>iSocket<span class="p">)</span>
<span class="p">}</span>

<span class="o">/*******************</span><span class="p">\</span>
<span class="w"> </span>Settings<span class="w"> </span>Function<span class="w">  </span><span class="o">|</span>
<span class="w">                  </span><span class="o">*/</span>

<span class="nf">AHKsock_Settings</span><span class="p">(</span>sSetting<span class="p">,</span><span class="w"> </span>sValue<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>iMessage<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mh">0x8000</span>
<span class="w">    </span><span class="kt">Static</span><span class="w"> </span>iBuffer<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">65536</span>
<span class="w">    </span>
<span class="w">    </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sSetting<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Message&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span>sValue
<span class="w">            </span><span class="k">Return</span><span class="w"> </span>iMessage
<span class="w">        </span><span class="k">Else</span><span class="w"> </span>iMessage<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>sValue<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Reset&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0x8000</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>sValue
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">Else</span><span class="w"> </span><span class="nf">If</span><span class="w"> </span><span class="p">(</span>sSetting<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Buffer&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">If</span><span class="w"> </span>Not<span class="w"> </span>sValue
<span class="w">            </span><span class="k">Return</span><span class="w"> </span>iBuffer
<span class="w">        </span><span class="k">Else</span><span class="w"> </span>iBuffer<span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span>sValue<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Reset&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>sValue
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


New Lexer: 
<div class="highlight"><pre><span class="cm">/*! TheGood</span>
<span class="cm">    AHKsock - A simple AHK implementation of Winsock.</span>
<span class="cm">    http://www.autohotkey.com/forum/viewtopic.php?p=355775</span>
<span class="cm">    Last updated: August 24th, 2010</span>
<span class="cm">    </span>
<span class="cm">FUNCTION LIST:</span>

<span class="cm">________________________________________</span>
<span class="cm">AHKsock_Listen(sPort, sFunction = False)</span>

<span class="cm">Tells AHKsock to listen on the port in sPort, and call the function in sFunction when events occur. If sPort is a port on</span>
<span class="cm">which AHKsock is already listening, the action taken depends on sFunction:</span>
<span class="cm">    - If sFunction is False, AHKsock will stop listening on the port in sPort.</span>
<span class="cm">    - If sFunction is &quot;()&quot;, AHKsock will return the name of the current function AHKsock calls when</span>
<span class="cm">      a client connects on the port in sPort.</span>
<span class="cm">    - If sFunction is a valid function, AHKsock will set that function as the new function to call</span>
<span class="cm">      when a client connects on the port in sPort.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    2: sFunction is not a valid function.</span>
<span class="cm">    3: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    4: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    5: The getaddrinfo() call failed. The error is in ErrorLevel.</span>
<span class="cm">    6: The socket() call failed. The error is in ErrorLevel.</span>
<span class="cm">    7: The bind() call failed. The error is in ErrorLevel.</span>
<span class="cm">    8: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">    9: The listen() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">See the section titled &quot;STRUCTURE OF THE EVENT-HANDLING FUNCTION AND MORE INFO ABOUT SOCKETS&quot; for more info about how the</span>
<span class="cm">function in sFunction interacts with AHKsock.</span>

<span class="cm">________________________________________</span>
<span class="cm">AHKsock_Connect(sName, sPort, sFunction)</span>

<span class="cm">Tells AHKsock to connect to the hostname or IP address in sName on the port in sPort, and call the function in sFunction</span>
<span class="cm">when events occur.</span>

<span class="cm">Although the function will return right away, the connection attempt will still be in progress. Once the connection attempt</span>
<span class="cm">is over, successful or not, sFunction will receive the CONNECTED event. Note that it is important that once AHKsock_Connect</span>
<span class="cm">returns, the current thread must stay (or soon after must become) interruptible so that sFunction can be called once the</span>
<span class="cm">connection attempt is over.</span>

<span class="cm">AHKsock_Connect can only be called again once the previous connection attempt is over. To check if AHKsock_Connect is ready</span>
<span class="cm">to make another connection attempt, you may keep polling it by calling AHKsock_Connect(0,0,0) until it returns False.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    1: AHKsock_Connect is still processing a connection attempt. ErrorLevel contains the name and the port of that</span>
<span class="cm">       connection attempt, separated by a tab.</span>
<span class="cm">    2: sFunction is not a valid function.</span>
<span class="cm">    3: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    4: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    5: The getaddrinfo() call failed. The error is in ErrorLevel.</span>
<span class="cm">    6: The socket() call failed. The error is in ErrorLevel.</span>
<span class="cm">    7: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">    8: The connect() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">See the section titled &quot;STRUCTURE OF THE EVENT-HANDLING FUNCTION AND MORE INFO ABOUT SOCKETS&quot; for more info about how the</span>
<span class="cm">function in sFunction interacts with AHKsock.</span>

<span class="cm">_______________________________________</span>
<span class="cm">AHKsock_Send(iSocket, ptrData, iLength)</span>

<span class="cm">Sends the data of length iLength to which ptrData points to the connected socket in iSocket.</span>

<span class="cm">Returns the number of bytes sent on success. This can be less than the number requested to be sent in the iLength parameter,</span>
<span class="cm">i.e. between 1 and iLength. This would occur if no buffer space is available within the transport system to hold the data to</span>
<span class="cm">be transmitted, in which case the number of bytes sent can be between 1 and the requested length, depending on buffer</span>
<span class="cm">availability on both the client and server computers. On failure, it returns one of the following negative integer:</span>
<span class="cm">    -1: WSAStartup hasn&#39;t been called yet.</span>
<span class="cm">    -2: Received WSAEWOULDBLOCK. This means that calling send() would have blocked the thread.</span>
<span class="cm">    -3: The send() call failed. The error is in ErrorLevel.</span>
<span class="cm">    -4: The socket specified in iSocket is not a valid socket. This means either that the socket in iSocket hasn&#39;t been</span>
<span class="cm">        created using AHKsock_Connect or AHKsock_Listen, or that the socket has already been destroyed.</span>
<span class="cm">    -5: The socket specified in iSocket is not cleared for sending. You haven&#39;t waited for the SEND event before calling,</span>
<span class="cm">        either ever, or not since you last received WSAEWOULDBLOCK.</span>

<span class="cm">You may start sending data to the connected socket in iSocket only after the socket&#39;s associated function receives the first</span>
<span class="cm">SEND event. Upon receiving the event, you may keep calling AHKsock_Send to send data until you receive the error -2, at</span>
<span class="cm">which point you must wait once again until you receive another SEND event before sending more data. Not waiting for the SEND</span>
<span class="cm">event results in receiving error -5 when calling AHKsock_Send.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">____________________________________________</span>
<span class="cm">AHKsock_ForceSend(iSocket, ptrData, iLength)</span>

<span class="cm">This function is exactly the same as AHKsock_Send, but with three differences:</span>
<span class="cm">    - If only part of the data could be sent, it will automatically keep trying to send the remaining part.</span>
<span class="cm">    - If it receives WSAEWOULDBLOCK, it will wait for the socket&#39;s SEND event and try sending the data again.</span>
<span class="cm">    - If the data buffer to send is larger than the socket&#39;s send buffer size, it will automatically send the data in</span>
<span class="cm">      smaller chunks in order to avoid a performance hit. See http://support.microsoft.com/kb/823764 for more info.</span>

<span class="cm">Therefore, AHKsock_ForceSend will return only when all the data has been sent. Because this function relies on waiting for</span>
<span class="cm">the socket&#39;s SEND event before continuing to send data, it cannot be called in a critical thread. Also, for the same reason,</span>
<span class="cm">it cannot be called from a socket&#39;s associated function (not specifically iSocket&#39;s associated function, but any socket&#39;s</span>
<span class="cm">associated function).</span>

<span class="cm">Another limitation to consider when choosing between AHKsock_Send and AHKsock_ForceSend is that AHKsock_ForceSend will not</span>
<span class="cm">return until all the data has been sent (unless an error occurs). Although the script will still be responsive (new threads</span>
<span class="cm">will still be able to launch), the thread from which it was called will not resume until it returns. Therefore, if sending</span>
<span class="cm">a large amount of data, you should either use AHKsock_Send, or use AHKsock_ForceSend by feeding it smaller pieces of the</span>
<span class="cm">data, allowing you to update the GUI if necessary (e.g. a progress bar).</span>

<span class="cm">Returns blank on success, which means that all the data to which ptrData points of length iLength has been sent. On failure,</span>
<span class="cm">it returns one of the following negative integer:</span>
<span class="cm">    -1: WSAStartup hasn&#39;t been called yet.</span>
<span class="cm">    -2: Received WSAEWOULDBLOCK. This means that calling send() would have blocked the thread.</span>
<span class="cm">    -3: The send() call failed. The error is in ErrorLevel.</span>
<span class="cm">    -4: The socket specified in iSocket is not a valid socket. This means either that the socket in iSocket hasn&#39;t been</span>
<span class="cm">        created using AHKsock_Connect or AHKsock_Listen, or that the socket has already been destroyed.</span>
<span class="cm">    -5: The current thread is critical.</span>
<span class="cm">    -6: The getsockopt() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">____________________________________________</span>
<span class="cm">AHKsock_Close(iSocket = -1, iTimeout = 5000)</span>

<span class="cm">Closes the socket in iSocket. If no socket is specified, AHKsock_Close will close all the sockets on record, as well as</span>
<span class="cm">terminate use of the Winsock 2 DLL (by calling WSACleanup). If graceful shutdown cannot be attained after the timeout</span>
<span class="cm">specified in iTimeout (in milliseconds), it will perform a hard shutdown before calling WSACleanup to free resources. See</span>
<span class="cm">the section titled &quot;NOTES ON CLOSING SOCKETS AND AHKsock_Close&quot; for more information.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    1: The shutdown() call failed. The error is in ErrorLevel. AHKsock_Close forcefully closed the socket and freed the</span>
<span class="cm">       associated resources.</span>

<span class="cm">Note that when AHKsock_Close is called with no socket specified, it will never return an error.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">___________________________________________________________</span>
<span class="cm">AHKsock_GetAddrInfo(sHostName, ByRef sIPList, bOne = False)</span>

<span class="cm">Retrieves the list of IP addresses that correspond to the hostname in sHostName. The list is contained in sIPList, delimited</span>
<span class="cm">by newline characters. If bOne is True, only one IP (the first one) will be returned.</span>

<span class="cm">Returns blank on success. On failure, it returns one of the following positive integer:</span>
<span class="cm">    1: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    2: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    3: Received WSAHOST_NOT_FOUND. No such host is known.</span>
<span class="cm">    4: The getaddrinfo() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">_________________________________________________________________________</span>
<span class="cm">AHKsock_GetNameInfo(sIP, ByRef sHostName, sPort = 0, ByRef sService = &quot;&quot;)</span>

<span class="cm">Retrieves the hostname that corresponds to the IP address in sIP. If a port in sPort is supplied, it also retrieves the</span>
<span class="cm">service that corresponds to the port in sPort.</span>

<span class="cm">Returns blank on success. On failure, it returns on of the following positive integer:</span>
<span class="cm">    1: The WSAStartup() call failed. The error is in ErrorLevel.</span>
<span class="cm">    2: The Winsock DLL does not support version 2.2.</span>
<span class="cm">    3: The IP address supplied in sIP is invalid.</span>
<span class="cm">    4: The getnameinfo() call failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">______________________________________________</span>
<span class="cm">AHKsock_SockOpt(iSocket, sOption, iValue = -1)</span>

<span class="cm">Retrieves or sets a socket option. Supported options are:</span>
<span class="cm">    SO_KEEPALIVE: Enable/Disable sending keep-alives. iValue must be True/False to enable/disable. Disabled by default.</span>
<span class="cm">    SO_SNDBUF:    Total buffer space reserved for sends. Set iValue to 0 to completely disable the buffer. Default is 8 KB.</span>
<span class="cm">    SO_RCVBUF:    Total buffer space reserved for receives. Default is 8 KB.</span>
<span class="cm">    TCP_NODELAY:  Enable/Disable the Nagle algorithm for send coalescing. Set iValue to True to disable the Nagle algorithm,</span>
<span class="cm">                  set iValue to False to enable the Nagle algorithm, which is the default.</span>

<span class="cm">It is usually best to leave these options to their default (especially the Nagle algorithm). Only change them if you</span>
<span class="cm">understand the consequences. See MSDN for more information on those options.</span>

<span class="cm">If iValue is specified, it sets the option to iValue and returns blank on success. If iValue is left as -1, it returns the</span>
<span class="cm">value of the option specified. On failure, it returns one of the following negative integer:</span>
<span class="cm">    -1: The getsockopt() failed. The error is in ErrorLevel.</span>
<span class="cm">    -2: The setsockopt() failed. The error is in ErrorLevel.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">_______________________________________</span>
<span class="cm">AHKsock_Settings(sSetting, sValue = &quot;&quot;)</span>

<span class="cm">Changes the AHKsock setting in sSetting to sValue. If sValue is blank, the current value for that setting is returned. If</span>
<span class="cm">sValue is the word &quot;Reset&quot;, the setting is restored to its default value. The possible settings are:</span>
<span class="cm">    Message: Determines the Windows message numbers used to monitor network events. The message number in iMessage and the</span>
<span class="cm">             next number will be used. Default value is 0x8000. For example, calling AHKsock_Settings(&quot;Message&quot;, 0x8005)</span>
<span class="cm">             will cause AHKsock to use 0x8005 and 0x8006 to monitor network events.</span>
<span class="cm">    Buffer:  Determines the size of the buffer (in bytes) used when receiving data. This is thus the maximum size of bData</span>
<span class="cm">             when the RECEIVED event is raised. If the data received is more than the buffer size, multiple recv() calls</span>
<span class="cm">             (and thus multiple RECEIVED events) will be needed. Note that you shouldn&#39;t use this setting as a means of</span>
<span class="cm">             delimiting frames. See the &quot;NOTES ON RECEIVING AND SENDING DATA&quot; section for more information about receiving</span>
<span class="cm">             and sending data. Default value is 64 KB, which is the maximum for TCP.</span>

<span class="cm">If you do call AHKsock_Settings to change the values from their default ones, it is best to do so at the beginning of the</span>
<span class="cm">script. The message number used cannot be changed as long as there are active connections.</span>

<span class="cm">______________________________________</span>
<span class="cm">AHKsock_ErrorHandler(sFunction = &quot;&quot;&quot;&quot;)</span>

<span class="cm">Sets the function in sFunction to be the new error handler. If sFunction is left at its default value, it returns the name</span>
<span class="cm">of the current error handling function.</span>

<span class="cm">An error-handling function is optional, but may be useful when troubleshooting applications. The function will be called</span>
<span class="cm">anytime there is an error that arises in a thread which wasn&#39;t called by the user but by the receival of a Windows message</span>
<span class="cm">which was registered using OnMessage.</span>

<span class="cm">The function in sFunction must be of the following format:</span>
<span class="cm">MyErrorHandler(iError, iSocket)</span>

<span class="cm">The possible values for iError are:</span>
<span class="cm">     1: The connect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     2: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     3: The socket() call failed. The error is in ErrorLevel.</span>
<span class="cm">     4: The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     5: The connect() call failed. The error is in ErrorLevel.</span>
<span class="cm">     6: FD_READ event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">     7: The recv() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">     8: FD_WRITE event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">     9: FD_ACCEPT event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
<span class="cm">    10: The accept() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="cm">    11: The WSAAsyncSelect() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="cm">    12: The listen() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
<span class="cm">    13: The shutdown() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>

<span class="cm">For the failures which affect ErrorLevel, ErrorLevel will contain either the reason the DllCall itself failed (ie. -1, -2,</span>
<span class="cm">An, etc... as laid out in the AHK docs for DllCall) or the Windows Sockets Error Code as defined at:</span>
<span class="cm">http://msdn.microsoft.com/en-us/library/ms740668</span>

<span class="cm">__________________________________________________________________</span>
<span class="cm">NOTES ON SOCKETS AND THE STRUCTURE OF THE EVENT-HANDLING FUNCTION:</span>

<span class="cm">The functions used in the sFunction parameter of AHKsock_Listen and AHKsock_Connect must be of the following format:</span>

<span class="cm">MyFunction(sEvent, iSocket = 0, sName = 0, sAddr = 0, sPort = 0, ByRef bData = 0, bDataLength = 0)</span>

<span class="cm">The variable sEvent contains the event for which MyFunction was called. The event raised is associated with one and only one</span>
<span class="cm">socket; the one in iSocket. The meaning of the possible events that can occur depend on the type of socket involved. AHKsock</span>
<span class="cm">deals with three different types of sockets:</span>
<span class="cm">    - Listening sockets: These sockets are created by a call to AHKsock_Listen. All they do is wait for clients to request</span>
<span class="cm">      a connection. These sockets will never appear as the iSocket parameter because requests for connections are</span>
<span class="cm">      immediately accepted, and MyFunction immediately receives the ACCEPTED event with iSocket set to the accepted socket.</span>
<span class="cm">    - Accepted sockets: These sockets are created once a listening socket receives an incoming connection attempt from a</span>
<span class="cm">      client and accepts it. They are thus the sockets that servers use to communicate with clients.</span>
<span class="cm">    - Connected sockets: These sockets are created by a successful call to AHKsock_Connect. These are the sockets that</span>
<span class="cm">      clients use to communicate with servers.</span>

<span class="cm">More info about sockets:</span>
<span class="cm">    - You may have multiple client sockets connecting to the same listening socket (ie. on the same port).</span>
<span class="cm">    - You may have multiple listening sockets for different ports.</span>
<span class="cm">    - You cannot have more than one listening socket for the same port (or you will receive a bind() error).</span>
<span class="cm">    - Every single connection between a client and a server will have its own client socket on the client side, and its own</span>
<span class="cm">      server (accepted) socket on the server side.</span>

<span class="cm">For all of the events that the event-handling function receives,</span>
<span class="cm">    - sEvent contains the event that occurred (as described below),</span>
<span class="cm">    - iSocket contains the socket on which the event occurred,</span>
<span class="cm">    - sName contains a value which depends on the type of socket in iSocket:</span>
<span class="cm">        - If the socket is an accepted socket, sName is empty.</span>
<span class="cm">        - If the socket is a connected socket, sName is the same value as the sName parameter that was used when</span>
<span class="cm">          AHKsock_Connect was called to create the socket. Since AHKsock_Connect accepts both hostnames and IP addresses,</span>
<span class="cm">          sName may contain either.</span>
<span class="cm">    - sAddr contains the IP address of the socket&#39;s endpoint (i.e. the peer&#39;s IP address). This means that if the socket in</span>
<span class="cm">      iSocket is an accepted socket, sAddr contains the IP address of the client. Conversely, if it is a connected socket,</span>
<span class="cm">      sAddr contains the server&#39;s IP.</span>
<span class="cm">    - sPort contains the server port on which the connection was accepted.</span>

<span class="cm">Obviously, if your script only calls AHKsock_Listen (acting as a server) or AHKsock_Connect (acting as a client) you don&#39;t</span>
<span class="cm">need to check if the socket in iSocket is an accepted socket or a connected socket, since it can only be one or the other.</span>
<span class="cm">But if you do call both AHKsock_Listen and AHKsock_Connect with both of them using the same function (e.g. MyFunction), then</span>
<span class="cm">you will need to check what type of socket iSocket is by checking the sName parameter.</span>

<span class="cm">Of course, it would be easier to simply have two different functions, for example, MyFunction1 and MyFunction2, with one</span>
<span class="cm">handling the server part and the other handling the client part so that you don&#39;t need to check what type of socket iSocket</span>
<span class="cm">is when each function is called. However, this might not be necessary if both server and client are &quot;symmetrical&quot; (i.e. the</span>
<span class="cm">conversation doesn&#39;t actually change whether or not we&#39;re on the server side or the client side). See Example 3 for an</span>
<span class="cm">example of this, where only one function is used for both server and client sockets.</span>

<span class="cm">The variable sEvent can be one of the following values if iSocket is an accepted socket:</span>
<span class="cm">    sEvent =      Event Description:</span>
<span class="cm">    ACCEPTED      A client connection was accepted (see the &quot;Listening sockets&quot; section above for more details).</span>
<span class="cm">    CONNECTED     &lt;Does not occur on accepted sockets&gt;</span>
<span class="cm">    DISCONNECTED  The client disconnected (see AHKsock_Close for more details).</span>
<span class="cm">    SEND          You may now send data to the client (see AHKsock_Send for more details).</span>
<span class="cm">    RECEIVED      You received data from the client. The data received is in bData and the length is in bDataLength.</span>
<span class="cm">    SENDLAST      The client is disconnecting. This is your last chance to send data to it. Once this function returns,</span>
<span class="cm">                  disconnection will occur. This event only occurs on the side which did not initiate shutdown (see</span>
<span class="cm">                  AHKsock_Close for more details).</span>

<span class="cm">The variable sEvent can be one of the following values if iSocket is a connected socket:</span>
<span class="cm">    sEvent =      Event Description:</span>
<span class="cm">    ACCEPTED      &lt;Does not occur on connected sockets&gt;</span>
<span class="cm">    CONNECTED     The connection attempt initiated by calling AHKsock_Connect has completed (see AHKsock_Connect for more</span>
<span class="cm">                  details). If it was successful, iSocket will equal the client socket. If it failed, iSocket will equal -1.</span>
<span class="cm">                  To get the error code that the failure returned, set an error handling function with AHKsock_ErrorHandler,</span>
<span class="cm">                  and read ErrorLevel when iError is equal to 1.</span>
<span class="cm">    DISCONNECTED  The server disconnected (see AHKsock_Close for more details).</span>
<span class="cm">    SEND          You may now send data to the server (see AHKsock_Send for more details).</span>
<span class="cm">    RECEIVED      You received data from the server. The data received is in bData and the length is in bDataLength.</span>
<span class="cm">    SENDLAST      The server is disconnecting. This is your last chance to send data to it. Once this function returns,</span>
<span class="cm">                  disconnection will occur. This event only occurs on the side which did not initiate shutdown (see </span>
<span class="cm">                  AHKsock_Close for more details).</span>

<span class="cm">More information: The event-handling functions described in here are always called with the Critical setting on. This is</span>
<span class="cm">necessary in order to ensure proper processing of messages. Note that as long as the event-handling function does not</span>
<span class="cm">return, AHKsock cannot process other network messages. Although messages are buffered, smooth operation might suffer when</span>
<span class="cm">letting the function run for longer than it should.</span>

<span class="cm">___________________________________________</span>
<span class="cm">NOTES ON CLOSING SOCKETS AND AHKsock_Close:</span>

<span class="cm">There are a few things to note about the AHKsock_Close function. The most important one is this: because the OnExit</span>
<span class="cm">subroutine cannot be made interruptible if running due to a call to Exit/ExitApp, AHKsock_Close will not be able to execute</span>
<span class="cm">a graceful shutdown if it is called from there. </span>

<span class="cm">A graceful shutdown refers to the proper way of closing a TCP connection. It consists of an exchange of special TCP messages</span>
<span class="cm">between the two endpoints to acknowledge that the connection is about to close. It also fires the SENDLAST event in the</span>
<span class="cm">socket&#39;s associated function to notify that this is the last chance it will have to send data before disconnection. Note</span>
<span class="cm">that listening sockets cannot (and therefore do not need to) be gracefully shutdown as it is not an end-to-end connection.</span>
<span class="cm">(In practice, you will never have to manually call AHKsock_Close on a listening socket because you do not have access to</span>
<span class="cm">them. The socket is closed when you stop listening by calling AHKsock_Listen with no specified value for the second</span>
<span class="cm">parameter.)</span>

<span class="cm">In order to allow the socket(s) connection(s) to gracefully shutdown (which is always preferable), AHKsock_Close must be</span>
<span class="cm">called in a thread which is, or can be made, interruptible. If it is called with a specified socket in iSocket, it will</span>
<span class="cm">initiate a graceful shutdown for that socket alone. If it is called with no socket specified, it will initiate a graceful</span>
<span class="cm">shutdown for all connected/accepted sockets, and once done, deregister itself from the Windows Sockets implementation and</span>
<span class="cm">allow the implementation to free any resources allocated for Winsock (by calling WSACleanup). In that case, if any</span>
<span class="cm">subsequent AHKsock function is called, Winsock will automatically be restarted.</span>

<span class="cm">Therefore, before exiting your application, AHKsock_Close must be called at least once with no socket specified in order to</span>
<span class="cm">free Winsock resources. This can be done in the OnExit subroutine, either if you do not wish to perform a graceful shutdown</span>
<span class="cm">(which is not recommended), or if you have already gracefully shutdown all the sockets individually before calling</span>
<span class="cm">Exit/ExitApp. Of course, it doesn&#39;t have to be done in the OnExit subroutine and can be done anytime before (which is the</span>
<span class="cm">recommended method because AHKsock will automatically gracefully shutdown all the sockets on record).</span>

<span class="cm">This behaviour has a few repercussions on your application&#39;s design. If the only way for the user to terminate your</span>
<span class="cm">application is through AHK&#39;s default Exit menu item in the tray menu, then upon selecting the Exit menu item, the OnExit sub</span>
<span class="cm">will fire, and your application will not have a chance to gracefully shutdown connected sockets. One way around this is to</span>
<span class="cm">add your own menu item which will in turn call AHKsock_Close with no socket specified before calling ExitApp to enter the</span>
<span class="cm">OnExit sub. See AHKsock Example 1 for an example of this.</span>

<span class="cm">This is how the graceful shutdown process occurs between two connected peers:</span>
<span class="cm">    a&gt; Once one of the peers (it may be the server of the client) is done sending all its data, it calls AHKsock_Close to</span>
<span class="cm">       shutdown the socket. (It is not a good idea to have the last peer receiving data call AHKsock_Close. This will result</span>
<span class="cm">       in AHKsock_Send errors on the other peer if more data needs to be sent.) In the next steps, we refer to the peer that</span>
<span class="cm">       first calls AHKsock_Close as the invoker, and the other peer simply as the peer.</span>
<span class="cm">    b&gt; The peer receives the invoker&#39;s intention to close the connection and is given one last chance to send any remaining</span>
<span class="cm">       data. This is when the peer&#39;s socket&#39;s associated function receives the SENDLAST event.</span>
<span class="cm">    c&gt; Once the peer is done sending any remaining data (if any), it also calls AHKsock_Close on that same socket to shut it</span>
<span class="cm">       down, and then close the socket for good. This happens once the peer&#39;s function that received the SENDLAST event</span>
<span class="cm">       returns from the event. At this point, the peer&#39;s socket&#39;s associated function receives the DISCONNECTED event.</span>
<span class="cm">    d&gt; This happens in parallel with c&gt;. After the invoker receives the peer&#39;s final data (if any), as well as notice that</span>
<span class="cm">       the peer has also called AHKsock_Close on the socket, the invoker finally also closes the socket for good. At this</span>
<span class="cm">       point, the socket&#39;s associated function also receives the DISCONNECTED event.</span>

<span class="cm">When AHKsock_Close is called with no socket specified, this process occurs (in parallel) for every connected socket on record.</span>

<span class="cm">____________________________________</span>
<span class="cm">NOTES ON RECEIVING AND SENDING DATA:</span>

<span class="cm">It&#39;s important to understand that AHKsock uses the TCP protocol, which is a stream protocol. This means that the data</span>
<span class="cm">received comes as a stream, with no apparent boundaries (i.e. frames or packets). For example, if a peer sends you a string,</span>
<span class="cm">it&#39;s possible that half the string is received in one RECEIVED event and the other half is received in the next. Of course,</span>
<span class="cm">the smaller the string, the less likely this happens. Conversely, the larger the string, the more likely this will occur.</span>

<span class="cm">Similarly, calling AHKsock_Send will not necessarily send the data right away. If multiple AHKsock_Send calls are issued,</span>
<span class="cm">Winsock might, under certain conditions, wait and accumulate data to send before sending it all at once. This process is</span>
<span class="cm">called coalescing. For example, if you send two strings to your peer by using two individual AHKsock_Send calls, the peer</span>
<span class="cm">will not necessarily receive two consecutive RECEIVED events for each string, but might instead receive both strings through</span>
<span class="cm">a single RECEIVED event.</span>

<span class="cm">One efficient method of receiving data as frames is to use length-prefixing. Length-prefixing means that before sending a</span>
<span class="cm">frame of variable length to your peer, you first tell it how many bytes will be in the frame. This way, your peer can</span>
<span class="cm">divide the received data into frames that can be individually processed. If it received less than a frame, it can store the</span>
<span class="cm">received data and wait for the remaining data to arrive before processing the completed frame with the length specified.</span>
<span class="cm">This technique is used in in AHKsock Example 3, where peers send each other strings by first declaring how long the string</span>
<span class="cm">will be (see the StreamProcessor function of Example 3).</span>

<span class="cm">____________________________________</span>
<span class="cm">NOTES ON TESTING A STREAM PROCESSOR:</span>

<span class="cm">As you write applications that use length-prefixing as described above, you might find it hard to test their ability to</span>
<span class="cm">properly cut up and/or put together the data into frames when testing them on the same machine or on a LAN (because the</span>
<span class="cm">latency is too low and it is thus harder to stress the connection).</span>

<span class="cm">In this case, what you can do to properly test them is to uncomment the comment block in AHKsock_Send, which will sometimes</span>
<span class="cm">purposely fail to send part of the data requested. This will allow you to simulate what could happen on a connection going</span>
<span class="cm">through the Internet. You may change the probability of failure by changing the number in the If statement.</span>

<span class="cm">If your application can still work after uncommenting the block, then it is a sign that it is properly handling frames split</span>
<span class="cm">across multiple RECEIVED events. This would also demonstrate your application&#39;s ability to cope with partially sent data.</span>
<span class="cm">*/</span>

<span class="cm">/****************\</span>
<span class="cm"> Main functions  |</span>
<span class="cm">               */</span>

<span class="n">AHKsock_Listen</span><span class="p">(</span><span class="n">sPort</span><span class="p">,</span> <span class="n">sFunction</span> <span class="o">=</span> <span class="nv">False</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if there is already a socket listening on this port</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">sktListen</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSocketFromNamePort&quot;</span><span class="p">,</span> <span class="nv">A_Space</span><span class="p">,</span> <span class="n">sPort</span><span class="p">))</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if we&#39;re stopping the listening</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">sFunction</span> <span class="p">{</span>
            <span class="n">AHKsock_Close</span><span class="p">(</span><span class="n">sktListen</span><span class="p">)</span><span class="c-Singleline"> ;Close the socket</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if we&#39;re retrieving the current function</span>
        <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sFunction</span> <span class="o">=</span> <span class="s">&quot;()&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">            </span><span class="nb">Return</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if it&#39;s a different function</span>
        <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sFunction</span> <span class="o">&lt;&gt;</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">))</span>
            <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetFunction&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">,</span> <span class="n">sFunction</span><span class="p">)</span><span class="c-Singleline"> ;Update it</span>
<span class="w">        </span>
<span class="w">        </span><span class="nb">Return</span><span class="c-Singleline"> ;We&#39;re done</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure we even have a function</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunction</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">2</span><span class="c-Singleline"> ;sFunction is not a valid function.</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure Winsock has been started up</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">i</span> <span class="o">:=</span> <span class="n">AHKsock_Startup</span><span class="p">())</span>
<span class="w">        </span><span class="nb">Return</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span><span class="c-Singleline"> ;The WSAStartup() call failed. The error is in ErrorLevel.</span>
                       <span class="o">:</span> <span class="mi">4</span><span class="c-Singleline"> ;The Winsock DLL does not support version 2.2.</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Resolve the local address and port to be used by the server</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">aiHints</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_flags = AI_PASSIVE</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_family = AF_INET</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_socktype = SOCK_STREAM</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_protocol = IPPROTO_TCP</span>
    <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\getaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sPort</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiHints</span><span class="p">,</span> <span class="s">&quot;uint*&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for error</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">iResult</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">5</span><span class="c-Singleline"> ;The getaddrinfo() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span>
    
    <span class="n">sktListen</span> <span class="o">:=</span> <span class="mh">0xFFFFFFFF</span><span class="c-Singleline"> ;INVALID_SOCKET</span>
    <span class="n">sktListen</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\socket&quot;</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">aiResult</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">aiResult</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
                                        <span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">aiResult</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span> <span class="s">&quot;uint&quot;</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">sktListen</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for INVALID_SOCKET</span>
        <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">6</span><span class="c-Singleline"> ;The socket() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Setup the TCP listening socket</span>
    <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\bind&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">aiResult</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">),</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">aiResult</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for SOCKET_ERROR</span>
        <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;ushort&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">)</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">7</span><span class="c-Singleline"> ;The bind() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span>
    
    <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Add socket to array with A_Space for Name and IP to indicate that it&#39;s a listening socket</span>
    <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Add&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">,</span> <span class="nv">A_Space</span><span class="p">,</span> <span class="nv">A_Space</span><span class="p">,</span> <span class="n">sPort</span><span class="p">,</span> <span class="n">sFunction</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;We must now actually register the socket</span>
<span class="w">    </span><span class="nb">If </span><span class="n">AHKsock_RegisterAsyncSelect</span><span class="p">(</span><span class="n">sktListen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">)</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">)</span><span class="c-Singleline"> ;Remove from array</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">8</span><span class="c-Singleline"> ;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Start listening for incoming connections</span>
    <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\listen&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span><span class="p">)</span><span class="c-Singleline"> ;SOMAXCONN</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for SOCKET_ERROR</span>
        <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">)</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">sktListen</span><span class="p">)</span><span class="c-Singleline"> ;Remove from array</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">9</span><span class="c-Singleline"> ;The listen() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">AHKsock_Connect</span><span class="p">(</span><span class="n">sName</span><span class="p">,</span> <span class="n">sPort</span><span class="p">,</span> <span class="n">sFunction</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">aiResult</span><span class="p">,</span> <span class="n">iPointer</span><span class="p">,</span> <span class="n">bProcessing</span><span class="p">,</span> <span class="n">iMessage</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">sCurName</span><span class="p">,</span> <span class="n">sCurPort</span><span class="p">,</span> <span class="n">sCurFunction</span><span class="p">,</span> <span class="n">sktConnect</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if it&#39;s just to inquire whether or not a call is possible</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">Not</span> <span class="n">sName</span> <span class="n">And</span> <span class="n">Not</span> <span class="n">sPort</span> <span class="n">And</span> <span class="n">Not</span> <span class="n">sFunction</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="n">bProcessing</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if we&#39;re busy</span>
<span class="w">    </span><span class="nb">If </span><span class="n">bProcessing</span> <span class="n">And</span> <span class="p">(</span><span class="n">sFunction</span> <span class="o">!=</span> <span class="n">iMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sCurName</span> <span class="nv">A_Tab</span> <span class="n">sCurPort</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">1</span><span class="c-Singleline"> ;AHKsock_Connect is still processing a connection attempt. ErrorLevel contains the name and the port,</span>
<span class="c-Singleline">                 ;delimited by a tab.</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="n">bProcessing</span> <span class="p">{</span><span class="c-Singleline"> ;sFunction = iMessage. The connect operation has finished.</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if it was successful</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">i</span> <span class="o">:=</span> <span class="n">sPort</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Close the socket that failed</span>
            <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Get the next pointer. ai_next</span>
            <span class="n">iPointer</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Check if we reached the end of the linked structs</span>
            <span class="n">If</span> <span class="p">(</span><span class="n">iPointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">                </span>
<span class="c-Singleline">                ;We can now free the chain of addrinfo structs</span>
                <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">                </span>
<span class="c-Singleline">                ;This is to ensure that the user can call AHKsock_Connect() right away upon receiving the message.</span>
                <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">False</span><span class="c-Singleline"></span>
<span class="c-Singleline">                </span>
<span class="c-Singleline">                ;Raise an error (can&#39;t use Return 1 because we were called asynchronously)</span>
                <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">i</span>
                <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="c-Singleline"> ;The connect() call failed. The error is in ErrorLevel.</span>
<span class="c-Singleline">                </span>
<span class="c-Singleline">                ;Call the function to signal that connection failed</span>
<span class="w">                </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sCurFunction</span><span class="p">)</span>
                    <span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sCurName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sCurPort</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">                </span><span class="nb">Return</span>
            <span class="p">}</span>
            
        <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span><span class="c-Singleline"> ;Successful connection!</span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Get the IP we successfully connected to</span>
            <span class="n">sIP</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;str&quot;</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;We can now free the chain of ADDRINFO structs</span>
            <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Add socket to array</span>
            <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Add&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">,</span> <span class="n">sCurName</span><span class="p">,</span> <span class="n">sIP</span><span class="p">,</span> <span class="n">sCurPort</span><span class="p">,</span> <span class="n">sCurFunction</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;This is to ensure that the user can call AHKsock_Connect() right away upon receiving the message.</span>
            <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">False</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Do this small bit in Critical so that AHKsock_AsyncSelect doesn&#39;t receive</span>
<span class="c-Singleline">            ;any FD messages before we call the user function</span>
<span class="w">            </span><span class="nb">Critical</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;We must now actually register the socket</span>
<span class="w">            </span><span class="nb">If </span><span class="n">AHKsock_RegisterAsyncSelect</span><span class="p">(</span><span class="n">sktConnect</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
                <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">)</span>
                <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">)</span><span class="c-Singleline"> ;Remove from array</span>
                <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
                <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="c-Singleline"> ;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="w">                </span>
<span class="w">                </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sCurFunction</span><span class="p">)</span><span class="c-Singleline"> ;Call the function to signal that connection failed</span>
                    <span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sCurName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sCurPort</span><span class="p">)</span>
                
            <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="nf">IsFunc</span><span class="p">(</span><span class="n">sCurFunction</span><span class="p">)</span><span class="c-Singleline"> ;Call the function to signal that connection was successful</span>
                <span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">,</span> <span class="n">sCurName</span><span class="p">,</span> <span class="n">sIP</span><span class="p">,</span> <span class="n">sCurPort</span><span class="p">)</span>
<span class="w">            </span>
<span class="w">            </span><span class="nb">Return</span>
        <span class="p">}</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span><span class="c-Singleline"> ;We were called</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Make sure we even have a function</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunction</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Return</span> <span class="mi">2</span><span class="c-Singleline"> ;sFunction is not a valid function.</span>
        
        <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">True</span><span class="c-Singleline"> ;Block future calls to AHKsock_Connect() until we&#39;re done</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Keep the values</span>
        <span class="n">sCurName</span> <span class="o">:=</span> <span class="n">sName</span>
        <span class="n">sCurPort</span> <span class="o">:=</span> <span class="n">sPort</span>
        <span class="n">sCurFunction</span> <span class="o">:=</span> <span class="n">sFunction</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Make sure Winsock has been started up</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">i</span> <span class="o">:=</span> <span class="n">AHKsock_Startup</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">False</span>
<span class="w">            </span><span class="nb">Return</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span><span class="c-Singleline"> ;The WSAStartup() call failed. The error is in ErrorLevel.</span>
                           <span class="o">:</span> <span class="mi">4</span><span class="c-Singleline"> ;The Winsock DLL does not support version 2.2.</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Resolve the server address and port    </span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">aiHints</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_family = AF_INET</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_socktype = SOCK_STREAM</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_protocol = IPPROTO_TCP</span>
        <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\getaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sName</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sPort</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiHints</span><span class="p">,</span> <span class="s">&quot;uint*&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for error</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">iResult</span>
            <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">False</span>
<span class="w">            </span><span class="nb">Return</span> <span class="mi">5</span><span class="c-Singleline"> ;The getaddrinfo() call failed. The error is in ErrorLevel.</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Start with the first struct</span>
        <span class="n">iPointer</span> <span class="o">:=</span> <span class="n">aiResult</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Create a SOCKET for connecting to server</span>
    <span class="n">sktConnect</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\socket&quot;</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">)</span>
                                         <span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="s">&quot;int&quot;</span><span class="p">),</span> <span class="s">&quot;uint&quot;</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">sktConnect</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for INVALID_SOCKET</span>
        <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
        <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">False</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">sFunction</span> <span class="o">=</span> <span class="n">iMessage</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;Check if we were called asynchronously</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="c-Singleline"> ;The socket() call failed. The error is in ErrorLevel.</span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Call the function to signal that connection failed</span>
<span class="w">            </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sCurFunction</span><span class="p">)</span>
                <span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">6</span><span class="c-Singleline"> ;The socket() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Register the socket to know when the connect() function is done. FD_CONNECT = 16</span>
    <span class="n">iMessage</span> <span class="o">:=</span> <span class="n">AHKsock_Settings</span><span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="w">    </span><span class="nb">If </span><span class="n">AHKsock_RegisterAsyncSelect</span><span class="p">(</span><span class="n">sktConnect</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;AHKsock_Connect&quot;</span><span class="p">,</span> <span class="n">iMessage</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">)</span>
        <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">False</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">sFunction</span> <span class="o">=</span> <span class="n">iMessage</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;Check if we were called asynchronously</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="c-Singleline"> ;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Call the function to signal that connection failed</span>
<span class="w">            </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sCurFunction</span><span class="p">)</span>
                <span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">7</span><span class="c-Singleline"> ;The WSAAsyncSelect() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Connect to server</span>
    <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\connect&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">24</span><span class="p">),</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
<span class="w">    </span><span class="nb">If </span><span class="nv">ErrorLevel</span> <span class="n">Or</span> <span class="p">((</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">And</span> <span class="p">(</span><span class="n">AHKsock_LastError</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">10035</span><span class="p">))</span> <span class="p">{</span><span class="c-Singleline"> ;Check for any error other than WSAEWOULDBLOCK</span>
        <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sktConnect</span><span class="p">)</span>
        <span class="n">bProcessing</span> <span class="o">:=</span> <span class="nv">False</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">sFunction</span> <span class="o">=</span> <span class="n">iMessage</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;Check if we were called asynchronously</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="c-Singleline"> ;The connect() call failed. The error is in ErrorLevel.</span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Call the function to signal that connection failed</span>
<span class="w">            </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sCurFunction</span><span class="p">)</span>
                <span class="nv">%sCurFunction%</span><span class="p">(</span><span class="s">&quot;CONNECTED&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">8</span><span class="c-Singleline"> ;The connect() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">AHKsock_Send</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="n">ptrData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure the socket is on record. Fail-safe</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">4</span><span class="c-Singleline"> ;The socket specified in iSocket is not a recognized socket.</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Startup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline"> ;WSAStartup hasn&#39;t been called yet.</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure the socket is cleared for sending</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSend&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">5</span><span class="c-Singleline"> ;The socket specified in iSocket is not cleared for sending.</span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*! Uncomment this block to simulate the possibility of an incomplete send()</span>
<span class="cm">    Random, iRand, 1, 100</span>
<span class="cm">    If (iRand &lt;= 30) { ;Probability of failure of 30%</span>
<span class="cm">        Random, iRand, 1, iLength - 1 ;Randomize how much of the data will not be sent</span>
<span class="cm">        iLength -= iRand</span>
<span class="cm">    }</span>
<span class="cm">    */</span>
    
    <span class="n">iSendResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\send&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">,</span> <span class="s">&quot;char&quot;</span><span class="p">,</span> <span class="n">ptrData</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">iLength</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iSendResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">And</span> <span class="p">((</span><span class="n">iErr</span> <span class="o">:=</span> <span class="n">AHKsock_LastError</span><span class="p">())</span> <span class="o">=</span> <span class="mi">10035</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;Check specifically for WSAEWOULDBLOCK</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetSend&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">,</span> <span class="nv">False</span><span class="p">)</span><span class="c-Singleline"> ;Update socket&#39;s send status</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">2</span><span class="c-Singleline"> ;Calling send() would have blocked the thread. Try again once you get the proper update.</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">iSendResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">iErr</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">3</span><span class="c-Singleline"> ;The send() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">Return</span> <span class="n">iSendResult</span><span class="c-Singleline"> ;The send() operation was successful</span>
<span class="p">}</span>

<span class="n">AHKsock_ForceSend</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="n">ptrData</span><span class="p">,</span> <span class="n">iLength</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Startup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline"> ;WSAStartup hasn&#39;t been called yet</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure the socket is on record. Fail-safe</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">4</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure that we&#39;re not in Critical, or we won&#39;t be able to wait for FD_WRITE messages</span>
<span class="w">    </span><span class="nb">If </span><span class="nv">A_IsCritical</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">5</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Extra precaution to make sure FD_WRITE messages can make it</span>
<span class="w">    </span><span class="nb">Thread</span><span class="p">,</span> <span class="n">Priority</span><span class="p">,</span> <span class="mi">0</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;We need to make sure not to fill up the send buffer in one call, or we&#39;ll get a performance hit.</span>
<span class="c-Singleline">    ;http://support.microsoft.com/kb/823764</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Get the socket&#39;s send buffer size</span>
    <span class="n">If</span> <span class="p">((</span><span class="n">iMaxChunk</span> <span class="o">:=</span> <span class="n">AHKsock_SockOpt</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="s">&quot;SO_SNDBUF&quot;</span><span class="p">))</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">6</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if we&#39;ll be sending in chunks or not</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iMaxChunk</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;We&#39;ll be sending as much as possible everytime!</span>
<span class="w">        </span>
<span class="w">        </span><span class="nb">Loop</span> <span class="p">{</span><span class="c-Singleline"> ;Keep sending the data until we&#39;re done or until an error occurs</span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Wait until we can send data (ie. when FD_WRITE arrives)</span>
<span class="w">            </span><span class="nb">While</span> <span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSend&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
<span class="w">                </span><span class="nb">Sleep</span> <span class="o">-</span><span class="mi">1</span>
<span class="w">            </span>
<span class="w">            </span><span class="nb">Loop</span> <span class="p">{</span><span class="c-Singleline"> ;Keep sending the data until we get WSAEWOULDBLOCK or until an error occurs</span>
                <span class="n">If</span> <span class="p">((</span><span class="n">iSendResult</span> <span class="o">:=</span> <span class="n">AHKsock_Send</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="n">ptrData</span><span class="p">,</span> <span class="n">iLength</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">If</span> <span class="p">(</span><span class="n">iSendResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="c-Singleline"> ;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">                        </span><span class="nb">Break</span><span class="c-Singleline"> ;Calling send() would have blocked the thread. Break the loop and we&#39;ll try again after we</span>
<span class="c-Singleline">                              ;receive FD_WRITE</span>
<span class="w">                    </span><span class="nb">Else</span> <span class="n">Return</span> <span class="n">iSendResult</span><span class="c-Singleline"> ;Something bad happened with AHKsock_Send. Return the same value we got.</span>
                <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">                    </span>
<span class="c-Singleline">                    ;AHKsock_Send was able to send bytes. Let&#39;s check if it sent only part of what we requested</span>
                    <span class="n">If</span> <span class="p">(</span><span class="n">iSendResult</span> <span class="o">&lt;</span> <span class="n">iLength</span><span class="p">)</span><span class="c-Singleline"> ;Move the offset up by what we were able to send</span>
                        <span class="n">ptrData</span> <span class="o">+=</span> <span class="n">iSendResult</span><span class="p">,</span> <span class="n">iLength</span> <span class="o">-=</span> <span class="n">iSendResult</span>
<span class="w">                    </span><span class="nb">Else</span> <span class="n">Return</span><span class="c-Singleline"> ;We&#39;re done sending all the data</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;We&#39;ll be sending in chunks of just under the send buffer size to avoid the performance hit</span>
        
        <span class="n">iMaxChunk</span> <span class="o">-=</span> <span class="mi">1</span><span class="c-Singleline"> ;Reduce by 1 to be smaller than the send buffer</span>
<span class="w">        </span><span class="nb">Loop</span> <span class="p">{</span><span class="c-Singleline"> ;Keep sending the data until we&#39;re done or until an error occurs</span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Wait until we can send data (ie. when FD_WRITE arrives)</span>
<span class="w">            </span><span class="nb">While</span> <span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSend&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
<span class="w">                </span><span class="nb">Sleep</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Check if we have less than the max chunk to send</span>
            <span class="n">If</span> <span class="p">(</span><span class="n">iLength</span> <span class="o">&lt;</span> <span class="n">iMaxChunk</span><span class="p">)</span> <span class="p">{</span>
<span class="w">                </span>
<span class="w">                </span><span class="nb">Loop</span> <span class="p">{</span><span class="c-Singleline"> ;Keep sending the data until we get WSAEWOULDBLOCK or until an error occurs</span>
<span class="c-Singleline">                    ;Send using the traditional offset method</span>
                    <span class="n">If</span> <span class="p">((</span><span class="n">iSendResult</span> <span class="o">:=</span> <span class="n">AHKsock_Send</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="n">ptrData</span><span class="p">,</span> <span class="n">iLength</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">If</span> <span class="p">(</span><span class="n">iSendResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="c-Singleline"> ;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">                            </span><span class="nb">Break</span><span class="c-Singleline"> ;Calling send() would have blocked the thread. Break the loop and we&#39;ll try again after we</span>
<span class="c-Singleline">                                  ;receive FD_WRITE</span>
<span class="w">                        </span><span class="nb">Else</span> <span class="n">Return</span> <span class="n">iSendResult</span><span class="c-Singleline"> ;Something bad happened with AHKsock_Send. Return the same value we got.</span>
                    <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">                        </span>
<span class="c-Singleline">                        ;AHKsock_Send was able to send bytes. Let&#39;s check if it sent only part of what we requested</span>
                        <span class="n">If</span> <span class="p">(</span><span class="n">iSendResult</span> <span class="o">&lt;</span> <span class="n">iLength</span><span class="p">)</span><span class="c-Singleline"> ;Move the offset up by what we were able to send</span>
                            <span class="n">ptrData</span> <span class="o">+=</span> <span class="n">iSendResult</span><span class="p">,</span> <span class="n">iLength</span> <span class="o">-=</span> <span class="n">iSendResult</span>
<span class="w">                        </span><span class="nb">Else</span> <span class="n">Return</span><span class="c-Singleline"> ;We&#39;re done sending all the data</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">                </span>
<span class="c-Singleline">                ;Send up to max chunk</span>
                <span class="n">If</span> <span class="p">((</span><span class="n">iSendResult</span> <span class="o">:=</span> <span class="n">AHKsock_Send</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="n">ptrData</span><span class="p">,</span> <span class="n">iMaxChunk</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">If</span> <span class="p">(</span><span class="n">iSendResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="c-Singleline"> ;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">                        </span><span class="nb">Continue</span><span class="c-Singleline"> ;Calling send() would have blocked the thread. Continue the loop and we&#39;ll try again after</span>
<span class="c-Singleline">                                 ;we receive FD_WRITE</span>
<span class="w">                    </span><span class="nb">Else</span> <span class="n">Return</span> <span class="n">iSendResult</span><span class="c-Singleline"> ;Something bad happened with AHKsock_Send. Return the same value we got.</span>
                <span class="p">}</span> <span class="n">Else</span> <span class="n">ptrData</span> <span class="o">+=</span> <span class="n">iSendResult</span><span class="p">,</span> <span class="n">iLength</span> <span class="o">-=</span> <span class="n">iSendResult</span><span class="c-Singleline"> ;Move up offset by updating the pointer and length</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">AHKsock_Close</span><span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">iTimeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure Winsock has been started up</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Startup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span><span class="c-Singleline"> ;There&#39;s nothing to close</span>
    
    <span class="n">If</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;We need to close all the sockets</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if we even have sockets to close</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSACleanup&quot;</span><span class="p">)</span>
            <span class="n">AHKsock_Startup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="c-Singleline"> ;Reset the value to show that we&#39;ve turned off Winsock</span>
<span class="w">            </span><span class="nb">Return</span><span class="c-Singleline"> ;We&#39;re done!</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Take the current time (needed for time-outing)</span>
        <span class="n">iStartClose</span> <span class="o">:=</span> <span class="nv">A_TickCount</span>
<span class="w">        </span>
<span class="w">        </span><span class="nb">Loop</span> <span class="o">%</span> <span class="n">AHKsock_Sockets</span><span class="p">()</span><span class="c-Singleline"> ;Close all sockets and cleanup</span>
            <span class="n">AHKsock_ShutdownSocket</span><span class="p">(</span><span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetSocketFromIndex&quot;</span><span class="p">,</span> <span class="nv">A_Index</span><span class="p">))</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if we&#39;re in the OnExit subroutine</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="nv">A_ExitReason</span> <span class="p">{</span>
            
            <span class="n">A_IsCriticalOld</span> <span class="o">:=</span> <span class="nv">A_IsCritical</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Make sure we can still receive FD_CLOSE msgs</span>
<span class="w">            </span><span class="nb">Critical</span><span class="p">,</span> <span class="n">Off</span>
<span class="w">            </span><span class="nb">Thread</span><span class="p">,</span> <span class="n">Priority</span><span class="p">,</span> <span class="mi">0</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;We can try a graceful shutdown or wait for a timeout</span>
<span class="w">            </span><span class="nb">While</span> <span class="p">(</span><span class="n">AHKsock_Sockets</span><span class="p">())</span> <span class="n">And</span> <span class="p">(</span><span class="nv">A_TickCount</span> <span class="o">-</span> <span class="n">iStartClose</span> <span class="o">&lt;</span> <span class="n">iTimeout</span><span class="p">)</span>
<span class="w">                </span><span class="nb">Sleep</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Restore previous Critical</span>
<span class="w">            </span><span class="nb">Critical</span><span class="p">,</span> <span class="nv">%A_IsCriticalOld%</span>
        <span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="cm">/*! Used for debugging purposes only</span>
<span class="cm">        If (i := AHKsock_Sockets()) {</span>
<span class="cm">            If (i = 1)</span>
<span class="cm">                OutputDebug, % &quot;Cleaning up now, with the socket &quot; AHKsock_Sockets(&quot;GetSocketFromIndex&quot;, 1) &quot; remaining...&quot;</span>
<span class="cm">            Else {</span>
<span class="cm">                OutputDebug, % &quot;Cleaning up now, with the following sockets remaining:&quot;</span>
<span class="cm">                Loop % AHKsock_Sockets() {</span>
<span class="cm">                    OutputDebug, % AHKsock_Sockets(&quot;GetSocketFromIndex&quot;, A_Index)</span>
<span class="cm">                }</span>
<span class="cm">            }</span>
<span class="cm">        }</span>
<span class="cm">        */</span>
        
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSACleanup&quot;</span><span class="p">)</span>
        <span class="n">AHKsock_Startup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="c-Singleline"> ;Reset the value to show that we&#39;ve turned off Winsock</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">    ;Close only one socket</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="n">AHKsock_ShutdownSocket</span><span class="p">(</span><span class="n">iSocket</span><span class="p">)</span><span class="c-Singleline"> ;Error-checking</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">1</span><span class="c-Singleline"> ;The shutdown() call failed. The error is in ErrorLevel.</span>
<span class="p">}</span>

<span class="n">AHKsock_GetAddrInfo</span><span class="p">(</span><span class="n">sHostName</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">sIPList</span><span class="p">,</span> <span class="n">bOne</span> <span class="o">=</span> <span class="nv">False</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure Winsock has been started up</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">i</span> <span class="o">:=</span> <span class="n">AHKsock_Startup</span><span class="p">())</span>
<span class="w">        </span><span class="nb">Return</span> <span class="n">i</span><span class="c-Singleline"> ;Return the same error (error 1 and 2)</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Resolve the address and port    </span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">aiHints</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_family = AF_INET</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_socktype = SOCK_STREAM</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">aiHints</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_protocol = IPPROTO_TCP</span>
    <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\getaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sHostName</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aiHints</span><span class="p">,</span> <span class="s">&quot;uint*&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="mi">11001</span><span class="p">)</span><span class="c-Singleline"> ;Check specifically for WSAHOST_NOT_FOUND since it&#39;s the most common error</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">3</span><span class="c-Singleline"> ;Received WSAHOST_NOT_FOUND. No such host is known.</span>
<span class="w">    </span><span class="nb">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for any other error</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">iResult</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">4</span><span class="c-Singleline"> ;The getaddrinfo() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">If </span><span class="n">bOne</span>
        <span class="n">sIPList</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="nf">NumGet</span><span class="p">(</span><span class="n">aiResult</span><span class="o">+</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;str&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nb">Else</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Start with the first addrinfo struct</span>
        <span class="n">iPointer</span> <span class="o">:=</span> <span class="n">aiResult</span><span class="p">,</span> <span class="n">sIPList</span> <span class="o">:=</span> <span class="s">&quot;&quot;</span>
<span class="w">        </span><span class="nb">While</span> <span class="n">iPointer</span> <span class="p">{</span>
            <span class="n">s</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">24</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="s">&quot;str&quot;</span><span class="p">)</span>
            <span class="n">iPointer</span> <span class="o">:=</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">iPointer</span><span class="o">+</span><span class="mi">28</span><span class="p">)</span><span class="c-Singleline"> ;Go to the next addrinfo struct</span>
            <span class="n">sIPList</span> <span class="o">.=</span>  <span class="n">s</span> <span class="p">(</span><span class="n">iPointer</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">`n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">)</span><span class="c-Singleline"> ;Add newline only if it&#39;s not the last one</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;We&#39;re done</span>
    <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\freeaddrinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">aiResult</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">AHKsock_GetNameInfo</span><span class="p">(</span><span class="n">sIP</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">sHostName</span><span class="p">,</span> <span class="n">sPort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ByRef</span> <span class="n">sService</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure Winsock has been started up</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">i</span> <span class="o">:=</span> <span class="n">AHKsock_Startup</span><span class="p">())</span>
<span class="w">        </span><span class="nb">Return</span> <span class="n">i</span><span class="c-Singleline"> ;Return the same error (error 1 and 2)</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Translate to IN_ADDR</span>
    <span class="n">iIP</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\inet_addr&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sIP</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iIP</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">Or</span> <span class="n">iIP</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span><span class="c-Singleline"> ;Check for INADDR_NONE or INADDR_ANY</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">3</span><span class="c-Singleline"> ;The IP address supplied in sIP is invalid.</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Construct a sockaddr struct</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">tSockAddr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">tSockAddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;short&quot;</span><span class="p">)</span><span class="c-Singleline"> ;ai_family = AF_INET</span>
    <span class="nf">NumPut</span><span class="p">(</span><span class="n">iIP</span><span class="p">,</span> <span class="n">tSockAddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="c-Singleline"> ;Put in the IN_ADDR</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Fill in the port field if we&#39;re also looking up the service name</span>
<span class="w">    </span><span class="nb">If </span><span class="n">sPort</span><span class="c-Singleline">           ;Translate to network byte order</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\htons&quot;</span><span class="p">,</span> <span class="s">&quot;ushort&quot;</span><span class="p">,</span> <span class="n">sPort</span><span class="p">),</span> <span class="n">tSockAddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ushort&quot;</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Prep vars</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">sHostName</span><span class="p">,</span> <span class="mi">1025</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="c-Singleline"> ;NI_MAXHOST</span>
<span class="w">    </span><span class="nb">If </span><span class="n">sPort</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">sService</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="c-Singleline"> ;NI_MAXSERV</span>
    
    <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\getnameinfo&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tSockAddr</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;str&quot;</span><span class="p">,</span> <span class="n">sHostName</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">1025</span>
                                           <span class="p">,</span> <span class="n">sPort</span> <span class="o">?</span> <span class="s">&quot;str&quot;</span> <span class="o">:</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">sPort</span> <span class="o">?</span> <span class="n">sService</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSAGetLastError&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">4</span><span class="c-Singleline"> ;The getnameinfo() call failed. The error is in ErrorLevel.</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">AHKsock_SockOpt</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="n">sOption</span><span class="p">,</span> <span class="n">iValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Prep variable</span>
    <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">iOptVal</span><span class="p">,</span> <span class="n">iOptValLength</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iValue</span> <span class="o">&lt;&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="nf">NumPut</span><span class="p">(</span><span class="n">iValue</span><span class="p">,</span> <span class="n">iOptVal</span><span class="p">)</span>
    
    <span class="n">If</span> <span class="p">(</span><span class="n">sOption</span> <span class="o">=</span> <span class="s">&quot;SO_KEEPALIVE&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">intLevel</span> <span class="o">:=</span> <span class="mh">0xFFFF</span><span class="c-Singleline"> ;SOL_SOCKET</span>
        <span class="n">intOptName</span> <span class="o">:=</span> <span class="mh">0x0008</span><span class="c-Singleline"> ;SO_KEEPALIVE</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sOption</span> <span class="o">=</span> <span class="s">&quot;SO_SNDBUF&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">intLevel</span> <span class="o">:=</span> <span class="mh">0xFFFF</span><span class="c-Singleline"> ;SOL_SOCKET</span>
        <span class="n">intOptName</span> <span class="o">:=</span> <span class="mh">0x1001</span><span class="c-Singleline"> ;SO_SNDBUF</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sOption</span> <span class="o">=</span> <span class="s">&quot;SO_RCVBUF&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">intLevel</span> <span class="o">:=</span> <span class="mh">0xFFFF</span><span class="c-Singleline"> ;SOL_SOCKET</span>
        <span class="n">intOptName</span> <span class="o">:=</span> <span class="mh">0x1002</span><span class="c-Singleline"> ;SO_SNDBUF</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sOption</span> <span class="o">=</span> <span class="s">&quot;TCP_NODELAY&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">intLevel</span> <span class="o">:=</span> <span class="mi">6</span><span class="c-Singleline"> ;IPPROTO_TCP</span>
        <span class="n">intOptName</span> <span class="o">:=</span> <span class="mh">0x0001</span><span class="c-Singleline"> ;TCP_NODELAY</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if we&#39;re getting or setting</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\getsockopt&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">intLevel</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">intOptName</span>
                                              <span class="p">,</span> <span class="s">&quot;uint*&quot;</span><span class="p">,</span>  <span class="n">iOptVal</span><span class="p">,</span> <span class="s">&quot;int*&quot;</span><span class="p">,</span> <span class="n">iOptValLength</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for SOCKET_ERROR</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">}</span> <span class="n">Else</span> <span class="n">Return</span> <span class="n">iOptVal</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span>
        <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\setsockopt&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">intLevel</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">intOptName</span>
                                              <span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">iOptVal</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span>  <span class="n">iOptValLength</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for SOCKET_ERROR</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
<span class="w">            </span><span class="nb">Return</span> <span class="o">-</span><span class="mi">2</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*******************\</span>
<span class="cm"> Support functions  |</span>
<span class="cm">                  */</span>

<span class="n">AHKsock_Startup</span><span class="p">(</span><span class="n">iMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">bAlreadyStarted</span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">    iMode = 0 ;Turns on WSAStartup()</span>
<span class="cm">    iMode = 1 ;Returns whether or not WSAStartup has been called</span>
<span class="cm">    iMode = 2 ;Resets the static variable to force another call next time iMode = 0</span>
<span class="cm">    */</span>
    
    <span class="n">If</span> <span class="p">(</span><span class="n">iMode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">bAlreadyStarted</span> <span class="o">:=</span> <span class="nv">False</span>
<span class="w">    </span><span class="nb">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">iMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="n">bAlreadyStarted</span>
<span class="w">    </span><span class="nb">Else</span> <span class="n">If</span> <span class="n">Not</span> <span class="n">bAlreadyStarted</span> <span class="p">{</span><span class="c-Singleline"> ;iMode = 0. Call the function only if it hasn&#39;t already been called.</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Start it up - request version 2.2</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">wsaData</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSAStartup&quot;</span><span class="p">,</span> <span class="s">&quot;ushort&quot;</span><span class="p">,</span> <span class="mh">0x0202</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wsaData</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">iResult</span>
<span class="w">            </span><span class="nb">Return</span> <span class="mi">1</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Make sure the Winsock DLL supports at least version 2.2</span>
        <span class="n">If</span> <span class="p">(</span><span class="nf">NumGet</span><span class="p">(</span><span class="n">wsaData</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ushort&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x0202</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSACleanup&quot;</span><span class="p">)</span><span class="c-Singleline"> ;Abort</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="s">&quot;The Winsock DLL does not support version 2.2.&quot;</span>
<span class="w">            </span><span class="nb">Return</span> <span class="mi">2</span>
        <span class="p">}</span>
        
        <span class="n">bAlreadyStarted</span> <span class="o">:=</span> <span class="nv">True</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">AHKsock_ShutdownSocket</span><span class="p">(</span><span class="n">iSocket</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Check if it&#39;s a listening socket</span>
    <span class="n">sName</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">sName</span> <span class="o">!=</span> <span class="nv">A_Space</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;It&#39;s not a listening socket. Shutdown send operations.</span>
        <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\shutdown&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="c-Singleline"> ;SD_SEND</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span>
            <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
            <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
            <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span>
<span class="w">            </span><span class="nb">Return</span> <span class="mi">1</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Mark it</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetShutdown&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="p">{</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span><span class="c-Singleline"> ;It&#39;s only a listening socket</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span><span class="c-Singleline"> ;Remove it from the array</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***********************\</span>
<span class="cm"> AsyncSelect functions  |</span>
<span class="cm">                      */</span><span class="c-Singleline"></span>
<span class="c-Singleline">                                     ;FD_READ | FD_WRITE | FD_ACCEPT | FD_CLOSE</span>
<span class="n">AHKsock_RegisterAsyncSelect</span><span class="p">(</span><span class="n">iSocket</span><span class="p">,</span> <span class="n">fFlags</span> <span class="o">=</span> <span class="mi">43</span><span class="p">,</span> <span class="n">sFunction</span> <span class="o">=</span> <span class="s">&quot;AHKsock_AsyncSelect&quot;</span><span class="p">,</span> <span class="n">iMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">hGui</span> <span class="o">:=</span> <span class="nv">False</span>
<span class="w">    </span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">hGui</span> <span class="p">{</span>
<span class="w">        </span><span class="nb">Gui</span><span class="p">,</span> <span class="o">+</span><span class="n">LastFound</span>
        <span class="n">hGui</span> <span class="o">:=</span> <span class="nf">WinExist</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="n">iMsg</span> <span class="o">:=</span> <span class="n">iMsg</span> <span class="o">?</span> <span class="n">iMsg</span> <span class="o">:</span> <span class="n">AHKsock_Settings</span><span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="nf">OnMessage</span><span class="p">(</span><span class="n">iMsg</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="n">sFunction</span><span class="p">)</span>
        <span class="nf">OnMessage</span><span class="p">(</span><span class="n">iMsg</span><span class="p">,</span> <span class="n">sFunction</span><span class="p">)</span>
    
    <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSAAsyncSelect&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">hGui</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">iMsg</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">fFlags</span><span class="p">)</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for SOCKET_ERROR</span>
        <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
<span class="w">        </span><span class="nb">Return</span> <span class="mi">1</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">AHKsock_AsyncSelect</span><span class="p">(</span><span class="n">wParam</span><span class="p">,</span> <span class="n">lParam</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Critical</span><span class="c-Singleline"> ;So that messages are buffered</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;wParam parameter identifies the socket on which a network event has occurred</span>
<span class="c-Singleline">    ;The low word of lParam specifies the network event that has occurred.</span>
<span class="c-Singleline">    ;The high word of lParam contains any error code</span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Make sure the socket is on record. Fail-safe</span>
<span class="w">    </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span>
    
    <span class="n">iEvent</span> <span class="o">:=</span> <span class="n">lParam</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">iErrorCode</span> <span class="o">:=</span> <span class="n">lParam</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*! Used for debugging purposes</span>
<span class="cm">    OutputDebug, % &quot;AsyncSelect - A network event &quot; iEvent &quot; has occurred on socket &quot; wParam</span>
<span class="cm">    If iErrorCode</span>
<span class="cm">        OutputDebug, % &quot;AsyncSelect - Error code = &quot; iErrorCode</span>
<span class="cm">    */</span>
    
    <span class="n">If</span> <span class="p">(</span><span class="n">iEvent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;FD_READ</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check for error</span>
<span class="w">        </span><span class="nb">If </span><span class="n">iErrorCode</span> <span class="p">{</span><span class="c-Singleline"> ;WSAENETDOWN is the only possible</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">iErrorCode</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ;FD_READ event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Return</span>
        <span class="p">}</span>
        
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">bufReceived</span><span class="p">,</span> <span class="n">bufReceivedLength</span> <span class="o">:=</span> <span class="n">AHKsock_Settings</span><span class="p">(</span><span class="s">&quot;Buffer&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\recv&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="s">&quot;char&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufReceived</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="n">bufReceivedLength</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;We received data!</span>
            <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">bufReceived</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="c-Singleline"> ;Update the internal length</span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Get associated function and call it</span>
<span class="w">            </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunc</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">))</span>
                <span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;RECEIVED&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
                                          <span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
                                          <span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">),</span> <span class="n">bufReceived</span><span class="p">,</span> <span class="n">iResult</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">        ;Check for error other than WSAEWOULDBLOCK</span>
        <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="nv">ErrorLevel</span> <span class="n">Or</span> <span class="p">((</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">And</span> <span class="n">Not</span> <span class="p">((</span><span class="n">iErrorCode</span> <span class="o">:=</span> <span class="n">AHKsock_LastError</span><span class="p">())</span> <span class="o">=</span> <span class="mi">10035</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">iErrorCode</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span><span class="c-Singleline"> ;The recv() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>
            <span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline"> ;So that if it&#39;s a spoofed call from FD_CLOSE, we exit the loop and close the socket</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Here, we bother with returning a value in case it&#39;s a spoofed call from FD_CLOSE</span>
<span class="w">        </span><span class="nb">Return</span> <span class="n">iResult</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">iEvent</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;FD_WRITE</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check for error</span>
<span class="w">        </span><span class="nb">If </span><span class="n">iErrorCode</span> <span class="p">{</span><span class="c-Singleline"> ;WSAENETDOWN is the only possible</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">iErrorCode</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ;FD_WRITE event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Return</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Update socket&#39;s setting</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;SetSend&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="nv">True</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Make sure the socket isn&#39;t already shut down</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetShutdown&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">            </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunc</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">))</span>
                <span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;SEND&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
                                      <span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
                                      <span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">))</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">iEvent</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;FD_ACCEPT</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check for error</span>
<span class="w">        </span><span class="nb">If </span><span class="n">iErrorCode</span> <span class="p">{</span><span class="c-Singleline"> ;WSAENETDOWN is the only possible</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">iErrorCode</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ;FD_ACCEPT event received with an error. The error is in ErrorLevel. The socket is in iSocket.</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Return</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;We need to accept the connection</span>
        <span class="nf">VarSetCapacity</span><span class="p">(</span><span class="n">tSockAddr</span><span class="p">,</span> <span class="n">tSockAddrLength</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sktClient</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\accept&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tSockAddr</span><span class="p">,</span> <span class="s">&quot;int*&quot;</span><span class="p">,</span> <span class="n">tSockAddrLength</span><span class="p">)</span>
        <span class="n">If</span> <span class="p">(</span><span class="n">sktClient</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">And</span> <span class="p">((</span><span class="n">iErrorCode</span> <span class="o">:=</span> <span class="n">AHKsock_LastError</span><span class="p">())</span> <span class="o">=</span> <span class="mi">10035</span><span class="p">)</span><span class="c-Singleline"> ;Check specifically for WSAEWOULDBLOCK</span>
<span class="w">            </span><span class="nb">Return</span><span class="c-Singleline"> ;We&#39;ll be called again next time we can retry accept()</span>
<span class="w">        </span><span class="nb">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sktClient</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for INVALID_SOCKET</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">iErrorCode</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ;The accept() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Return</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Add to array</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="s">&quot;&quot;</span>
        <span class="n">sAddr</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\inet_ntoa&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="nf">NumGet</span><span class="p">(</span><span class="n">tSockAddr</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s">&quot;str&quot;</span><span class="p">)</span>
        <span class="n">sPort</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
        <span class="n">sFunc</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Add&quot;</span><span class="p">,</span> <span class="n">sktClient</span><span class="p">,</span> <span class="n">sName</span><span class="p">,</span> <span class="n">sAddr</span><span class="p">,</span> <span class="n">sPort</span><span class="p">,</span> <span class="n">sFunc</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Go back to listening</span>
        <span class="n">iResult</span> <span class="o">:=</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\listen&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="s">&quot;int&quot;</span><span class="p">,</span> <span class="mh">0x7FFFFFFF</span><span class="p">)</span><span class="c-Singleline"> ;SOMAXCONN       </span>
        <span class="n">If</span> <span class="p">(</span><span class="n">iResult</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">Or</span> <span class="nv">ErrorLevel</span> <span class="p">{</span><span class="c-Singleline"> ;Check for SOCKET_ERROR</span>
            <span class="n">sErrorLevel</span> <span class="o">:=</span> <span class="nv">ErrorLevel</span> <span class="o">?</span> <span class="nv">ErrorLevel</span> <span class="o">:</span> <span class="n">AHKsock_LastError</span><span class="p">()</span>
            <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
            <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span><span class="c-Singleline"> ;Remove from array</span>
            <span class="nv">ErrorLevel</span> <span class="o">:=</span> <span class="n">sErrorLevel</span><span class="c-Singleline"></span>
<span class="c-Singleline">            ;The listen() call failed. The error is in ErrorLevel. The listening socket is in iSocket.</span>
            <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Return</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Get associated function and call it</span>
<span class="w">        </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunc</span><span class="p">)</span>
            <span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;ACCEPTED&quot;</span><span class="p">,</span> <span class="n">sktClient</span><span class="p">,</span> <span class="n">sName</span><span class="p">,</span> <span class="n">sAddr</span><span class="p">,</span> <span class="n">sPort</span><span class="p">)</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">iEvent</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;FD_CLOSE</span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Keep receiving data before closing the socket by spoofing an FD_READ event to call recv()</span>
<span class="w">        </span><span class="nb">While</span> <span class="p">(</span><span class="n">AHKsock_AsyncSelect</span><span class="p">(</span><span class="n">wParam</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="nb">Sleep</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Check if we initiated it</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetShutdown&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Last chance to send data. Get associated function and call it.</span>
<span class="w">            </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunc</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">))</span>
                <span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;SENDLAST&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
                                          <span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
                                          <span class="p">,</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">))</span><span class="c-Singleline"></span>
<span class="c-Singleline">            </span>
<span class="c-Singleline">            ;Shutdown the socket. This is to attempt a graceful shutdown</span>
<span class="w">            </span><span class="nb">If </span><span class="n">AHKsock_ShutdownSocket</span><span class="p">(</span><span class="n">wParam</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">                ;The shutdown() call failed. The error is in ErrorLevel. The socket is in iSocket.</span>
                <span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">                </span><span class="nb">Return</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;We just have to close the socket then</span>
        <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\closesocket&quot;</span><span class="p">,</span> <span class="s">&quot;uint&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;Get associated data before deleting</span>
        <span class="n">sFunc</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetFunction&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
        <span class="n">sName</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetName&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
        <span class="n">sAddr</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetAddr&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
        <span class="n">sPort</span> <span class="o">:=</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;GetPort&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;We can remove it from the array</span>
        <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunc</span><span class="p">)</span>
            <span class="nv">%sFunc%</span><span class="p">(</span><span class="s">&quot;DISCONNECTED&quot;</span><span class="p">,</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">sName</span><span class="p">,</span> <span class="n">sAddr</span><span class="p">,</span> <span class="n">sPort</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************\</span>
<span class="cm"> Array controller  |</span>
<span class="cm">                 */</span>

<span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;Count&quot;</span><span class="p">,</span> <span class="n">iSocket</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">sName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">sAddr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">sPort</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">sFunction</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">aSockets0</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">iLastSocket</span> <span class="o">:=</span> <span class="mh">0xFFFFFFFF</span><span class="c-Singleline"> ;Cache to lessen index lookups on the same socket</span>
<span class="w">    </span><span class="nb">Local</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span>
    
    <span class="n">A_IsCriticalOld</span> <span class="o">:=</span> <span class="nv">A_IsCritical</span>
<span class="w">    </span><span class="nb">Critical</span>
    
    <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;Count&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets0</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;Add&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">aSockets0</span> <span class="o">+=</span> <span class="mi">1</span><span class="c-Singleline"> ;Expand array</span>
        <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Sock</span> <span class="o">:=</span> <span class="n">iSocket</span>
        <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Name</span> <span class="o">:=</span> <span class="n">sName</span>
        <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Addr</span> <span class="o">:=</span> <span class="n">sAddr</span>
        <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Port</span> <span class="o">:=</span> <span class="n">sPort</span>
        <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Func</span> <span class="o">:=</span> <span class="n">sFunction</span>
        <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Shutdown</span> <span class="o">:=</span> <span class="nv">False</span>
        <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Send</span> <span class="o">:=</span> <span class="nv">False</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;Delete&quot;</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"></span>
<span class="c-Singleline">        </span>
<span class="c-Singleline">        ;First we need the index</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
<span class="w">        </span>
<span class="w">        </span><span class="nb">If </span><span class="n">i</span> <span class="p">{</span>
            <span class="n">iLastSocket</span> <span class="o">:=</span> <span class="mh">0xFFFF</span><span class="c-Singleline"> ;Clear cache</span>
            <span class="n">If</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">aSockets0</span><span class="p">)</span> <span class="p">{</span><span class="c-Singleline"> ;Let the last item overwrite this one</span>
                <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Sock</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Sock</span>
                <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Name</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Name</span>
                <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Addr</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Addr</span>
                <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Port</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Port</span>
                <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Func</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Func</span>
                <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Shutdown</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Shutdown</span>
                <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Send</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%aSockets0%</span><span class="n">_Send</span>
                
            <span class="p">}</span>
            <span class="n">aSockets0</span> <span class="o">-=</span> <span class="mi">1</span><span class="c-Singleline"> ;Remove element</span>
        <span class="p">}</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetName&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Name</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetAddr&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Addr</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetPort&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Port</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetFunction&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Func</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;SetFunction&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Func</span> <span class="o">:=</span> <span class="n">sName</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetSend&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Send</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;SetSend&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Send</span> <span class="o">:=</span> <span class="n">sName</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetShutdown&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Shutdown</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;SetShutdown&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iSocket</span> <span class="o">=</span> <span class="n">iLastSocket</span><span class="p">)</span><span class="c-Singleline"> ;Check cache</span>
        <span class="o">?</span> <span class="n">iLastSocketIndex</span>
        <span class="o">:</span> <span class="n">AHKsock_Sockets</span><span class="p">(</span><span class="s">&quot;Index&quot;</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
        <span class="n">aSockets</span><span class="nv">%i%</span><span class="n">_Shutdown</span> <span class="o">:=</span> <span class="nv">True</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetSocketFromNamePort&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">        </span><span class="nb">Loop</span> <span class="o">%</span> <span class="n">aSockets0</span> <span class="p">{</span>
            <span class="n">If</span> <span class="p">(</span><span class="n">aSockets</span><span class="nv">%A_Index%</span><span class="n">_Name</span> <span class="o">=</span> <span class="n">iSocket</span><span class="p">)</span>
            <span class="n">And</span> <span class="p">(</span><span class="n">aSockets</span><span class="nv">%A_Index%</span><span class="n">_Port</span> <span class="o">=</span> <span class="n">sName</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%A_Index%</span><span class="n">_Sock</span>
<span class="w">                </span><span class="nb">Break</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;GetSocketFromIndex&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">:=</span> <span class="n">aSockets</span><span class="nv">%iSocket%</span><span class="n">_Sock</span>
    
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sAction</span> <span class="o">=</span> <span class="s">&quot;Index&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">        </span><span class="nb">Loop</span> <span class="o">%</span> <span class="n">aSockets0</span> <span class="p">{</span>
            <span class="n">If</span> <span class="p">(</span><span class="n">aSockets</span><span class="nv">%A_Index%</span><span class="n">_Sock</span> <span class="o">=</span> <span class="n">iSocket</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">iLastSocketIndex</span> <span class="o">:=</span> <span class="nv">A_Index</span><span class="p">,</span> <span class="n">iLastSocket</span> <span class="o">:=</span> <span class="n">iSocket</span>
                <span class="n">ret</span> <span class="o">:=</span> <span class="nv">A_Index</span>
<span class="w">                </span><span class="nb">Break</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="c-Singleline"></span>
<span class="c-Singleline">    </span>
<span class="c-Singleline">    ;Restore old Critical setting</span>
<span class="w">    </span><span class="nb">Critical</span> <span class="nv">%A_IsCriticalOld%</span>
<span class="w">    </span><span class="nb">Return</span> <span class="n">ret</span>
<span class="p">}</span>

<span class="cm">/*****************\</span>
<span class="cm"> Error Functions  |</span>
<span class="cm">                */</span>

<span class="n">AHKsock_LastError</span><span class="p">()</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Return</span> <span class="nf">DllCall</span><span class="p">(</span><span class="s">&quot;Ws2_32\WSAGetLastError&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">AHKsock_ErrorHandler</span><span class="p">(</span><span class="n">sFunction</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">&quot;&quot;</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">sCurrentFunction</span>
    <span class="n">If</span> <span class="p">(</span><span class="n">sFunction</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">&quot;&quot;</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">Return</span> <span class="n">sCurrentFunction</span>
<span class="w">    </span><span class="nb">Else</span> <span class="n">sCurrentFunction</span> <span class="o">:=</span> <span class="n">sFunction</span>
<span class="p">}</span>

<span class="n">AHKsock_RaiseError</span><span class="p">(</span><span class="n">iError</span><span class="p">,</span> <span class="n">iSocket</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">If </span><span class="nf">IsFunc</span><span class="p">(</span><span class="n">sFunc</span> <span class="o">:=</span> <span class="n">AHKsock_ErrorHandler</span><span class="p">())</span>
        <span class="nv">%sFunc%</span><span class="p">(</span><span class="n">iError</span><span class="p">,</span> <span class="n">iSocket</span><span class="p">)</span>
<span class="p">}</span>

<span class="cm">/*******************\</span>
<span class="cm"> Settings Function  |</span>
<span class="cm">                  */</span>

<span class="n">AHKsock_Settings</span><span class="p">(</span><span class="n">sSetting</span><span class="p">,</span> <span class="n">sValue</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">iMessage</span> <span class="o">:=</span> <span class="mh">0x8000</span>
<span class="w">    </span><span class="nb">Static</span> <span class="n">iBuffer</span> <span class="o">:=</span> <span class="mi">65536</span>
    
    <span class="n">If</span> <span class="p">(</span><span class="n">sSetting</span> <span class="o">=</span> <span class="s">&quot;Message&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">sValue</span>
<span class="w">            </span><span class="nb">Return</span> <span class="n">iMessage</span>
<span class="w">        </span><span class="nb">Else</span> <span class="n">iMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">sValue</span> <span class="o">=</span> <span class="s">&quot;Reset&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x8000</span> <span class="o">:</span> <span class="n">sValue</span>
    <span class="p">}</span> <span class="n">Else</span> <span class="n">If</span> <span class="p">(</span><span class="n">sSetting</span> <span class="o">=</span> <span class="s">&quot;Buffer&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="w">        </span><span class="nb">If </span><span class="n">Not</span> <span class="n">sValue</span>
<span class="w">            </span><span class="nb">Return</span> <span class="n">iBuffer</span>
<span class="w">        </span><span class="nb">Else</span> <span class="n">iBuffer</span> <span class="o">:=</span> <span class="p">(</span><span class="n">sValue</span> <span class="o">=</span> <span class="s">&quot;Reset&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">65536</span> <span class="o">:</span> <span class="n">sValue</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
